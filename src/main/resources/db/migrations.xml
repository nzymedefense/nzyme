<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">


    <changeSet id="0" author="lennartkoopmann">
        <createTable tableName="measurements" >
            <column name="id" type="integer" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="measurement_type" type="varchar(50)">
                <constraints nullable="false" />
            </column>

            <column name="measurement_value" type="integer">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp">
                <constraints nullable="false" />
            </column>
        </createTable>
    </changeSet>

    <changeSet id="1" author="lennartkoopmann">
        <createIndex indexName="idx_measurements_standard_lookup" tableName="measurements" unique="false">
            <column name="measurement_type" />
            <column name="created_at" />
        </createIndex>

        <createIndex indexName="idx_measurements_created_at" tableName="measurements" unique="false">
            <column name="created_at" />
        </createIndex>
    </changeSet>

    <changeSet id="2" author="lennartkoopmann">
        <createTable tableName="signal_index_history" >
            <column name="id" type="integer" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="bssid" type="varchar(17)">
                <constraints nullable="false" />
            </column>

            <column name="ssid" type="varchar(255)">
                <constraints nullable="false" />
            </column>

            <column name="channel" type="integer">
                <constraints nullable="false" />
            </column>

            <column name="signal_index" type="float">
                <constraints nullable="true" />
            </column>

            <column name="signal_index_threshold" type="float">
                <constraints nullable="true" />
            </column>

            <column name="signal_quality" type="integer">
                <constraints nullable="true" />
            </column>

            <column name="signal_stddev" type="float">
                <constraints nullable="true" />
            </column>

            <column name="expected_delta_upper" type="integer">
                <constraints nullable="true" />
            </column>

            <column name="expected_delta_lower" type="integer">
                <constraints nullable="true" />
            </column>

            <column name="created_at" type="timestamp">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createIndex indexName="idx_sigindex_standard_lookup" tableName="signal_index_history" unique="false">
            <column name="bssid" />
            <column name="ssid" />
            <column name="channel" />
            <column name="created_at" />
        </createIndex>

        <createIndex indexName="idx_sigindex_created_at" tableName="signal_index_history" unique="false">
            <column name="created_at" />
        </createIndex>
    </changeSet>

    <changeSet id="3" author="lennartkoopmann">
        <createTable tableName="beacon_rate_history" >
            <column name="id" type="integer" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="bssid" type="varchar(17)">
                <constraints nullable="false" />
            </column>

            <column name="ssid" type="varchar(255)">
                <constraints nullable="false" />
            </column>

            <column name="channel" type="integer">
                <constraints nullable="false" />
            </column>

            <column name="beacon_rate" type="integer">
                <constraints nullable="true" />
            </column>

            <column name="created_at" type="timestamp">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createIndex indexName="idx_beaconrate_standard_lookup" tableName="beacon_rate_history" unique="false">
            <column name="bssid" />
            <column name="ssid" />
            <column name="channel" />
            <column name="created_at" />
        </createIndex>

        <createIndex indexName="idx_beaconrate_created_at" tableName="beacon_rate_history" unique="false">
            <column name="created_at" />
        </createIndex>
    </changeSet>

    <changeSet id="4" author="lennartkoopmann">
        <dropColumn tableName="beacon_rate_history" columnName="channel" />
    </changeSet>

    <changeSet id="5" author="lennartkoopmann">
        <dropTable tableName="signal_index_history" />
    </changeSet>

    <changeSet id="6" author="lennartkoopmann">
        <createTable tableName="sigidx_histogram_history" >
            <column name="id" type="integer" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="bssid" type="varchar(17)">
                <constraints nullable="false" />
            </column>

            <column name="ssid" type="varchar(255)">
                <constraints nullable="false" />
            </column>

            <column name="channel" type="integer">
                <constraints nullable="false" />
            </column>

            <column name="histogram" type="text">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createIndex indexName="idx_sigidxhistory_standard_lookup" tableName="sigidx_histogram_history" unique="false">
            <column name="bssid" />
            <column name="ssid" />
            <column name="channel" />
            <column name="created_at" />
        </createIndex>
    </changeSet>

    <changeSet id="7" author="lennartkoopmann">
        <createTable tableName="alerts" >
            <column name="id" type="integer" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="alert_uuid" type="uuid">
                <constraints nullable="false" unique="true" />
            </column>

            <column name="alert_type" type="varchar(255)">
                <constraints nullable="false" />
            </column>

            <column name="subsystem" type="varchar(25)">
                <constraints nullable="false" />
            </column>

            <column name="message" type="text">
                <constraints nullable="false" />
            </column>

            <column name="description" type="text">
                <constraints nullable="false" />
            </column>

            <column name="fields" type="text">
                <constraints nullable="false" />
            </column>

            <column name="first_seen" type="timestamp">
                <constraints nullable="false" />
            </column>

            <column name="last_seen" type="timestamp">
                <constraints nullable="false" />
            </column>

            <column name="frame_count" type="integer">
                <constraints nullable="false" />
            </column>

            <column name="use_frame_count" type="boolean">
                <constraints nullable="false" />
            </column>

            <column name="documentation_link" type="varchar(255)">
                <constraints nullable="false" />
            </column>

            <column name="false_positives" type="text">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createIndex indexName="alerts_standard_lookup" tableName="alerts" unique="false">
            <column name="last_seen" />
        </createIndex>
    </changeSet>

    <changeSet id="8" author="lennartkoopmann">
        <dropColumn tableName="alerts" columnName="false_positives" />
        <dropColumn tableName="alerts" columnName="documentation_link" />
        <dropColumn tableName="alerts" columnName="description" />
        <dropColumn tableName="alerts" columnName="message" />
    </changeSet>

    <changeSet id="9" author="lennartkoopmann">
        <addColumn tableName="alerts">
            <column name="channel" type="integer">
                <constraints nullable="false" />
            </column>
            <column name="frequency" type="integer">
                <constraints nullable="false" />
            </column>
            <column name="antenna_signal" type="integer">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="10" author="lennartkoopmann">
        <dropColumn tableName="alerts" columnName="channel" />
        <dropColumn tableName="alerts" columnName="antenna_signal" />
        <dropColumn tableName="alerts" columnName="frequency" />
    </changeSet>

    <changeSet id="11" author="lennartkoopmann">
        <createTable tableName="bandits">
            <column name="id" type="integer" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="bandit_uuid" type="uuid">
                <constraints nullable="false" unique="true" />
            </column>

            <column name="name" type="varchar(75)">
                <constraints nullable="false" />
            </column>

            <column name="description" type="text">
                <constraints nullable="false" />
            </column>

            <column name="identifiers" type="text">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp">
                <constraints nullable="false" />
            </column>

            <column name="updated_at" type="timestamp">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createIndex indexName="bandits_standard_lookup" tableName="bandits" unique="false">
            <column name="created_at" />
        </createIndex>

        <createIndex indexName="bandits_indiv_lookup" tableName="bandits" unique="false">
            <column name="bandit_uuid" />
        </createIndex>
    </changeSet>

    <changeSet id="12" author="lennartkoopmann">
        <dropColumn tableName="bandits" columnName="identifiers" />

        <createTable tableName="bandit_identifiers">
            <column name="id" type="integer" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="identifier_type" type="varchar(75)">
                <constraints nullable="false" />
            </column>

            <column name="bandit_id" type="integer">
                <constraints nullable="false" />
            </column>

            <column name="configuration" type="text">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp">
                <constraints nullable="false" />
            </column>

            <column name="updated_at" type="timestamp">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createIndex indexName="bandits_identifiers_linked_lookup" tableName="bandit_identifiers" unique="false">
            <column name="bandit_id" />
        </createIndex>

        <addForeignKeyConstraint    constraintName="link_bandits2identifiers"
                                    baseTableName="bandit_identifiers"
                                    baseColumnNames="bandit_id"
                                    referencedTableName="bandits"
                                    referencedColumnNames="id"
                                    onUpdate="NO ACTION"
                                    onDelete="CASCADE"
        />
    </changeSet>

    <changeSet id="13" author="lennartkoopmann">
        <createTable tableName="contacts">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="contact_uuid" type="uuid">
                <constraints nullable="false" unique="true" />
            </column>

            <column name="bandit_id" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="frame_count" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="first_seen" type="timestamp">
                <constraints nullable="false" />
            </column>

            <column name="last_seen" type="timestamp">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createIndex indexName="contacts_linked_lookup" tableName="contacts" unique="false">
            <column name="bandit_id" />
        </createIndex>

        <addForeignKeyConstraint    constraintName="link_bandits2contacts"
                                    baseTableName="contacts"
                                    baseColumnNames="bandit_id"
                                    referencedTableName="bandits"
                                    referencedColumnNames="id"
                                    onUpdate="NO ACTION"
                                    onDelete="CASCADE"
        />

    </changeSet>

    <changeSet id="14" author="lennartkoopmann">
        <modifyDataType tableName="measurements" columnName="id" newDataType="bigint" />
        <modifyDataType tableName="measurements" columnName="measurement_value" newDataType="bigint" />
        <modifyDataType tableName="beacon_rate_history" columnName="id" newDataType="bigint" />
        <modifyDataType tableName="beacon_rate_history" columnName="beacon_rate" newDataType="bigint" />
        <modifyDataType tableName="sigidx_histogram_history" columnName="id" newDataType="bigint" />
        <modifyDataType tableName="alerts" columnName="id" newDataType="bigint" />
        <modifyDataType tableName="alerts" columnName="frame_count" newDataType="bigint" />
        <modifyDataType tableName="bandits" columnName="id" newDataType="bigint" />
        <modifyDataType tableName="bandit_identifiers" columnName="id" newDataType="bigint" />
        <modifyDataType tableName="bandit_identifiers" columnName="bandit_id" newDataType="bigint" />
    </changeSet>

    <changeSet id="15" author="lennartkoopmann">
        <createIndex indexName="contacts_active_lookup" tableName="contacts" unique="false">
            <column name="bandit_id" />
            <column name="last_seen" />
        </createIndex>
    </changeSet>

    <changeSet id="16" author="lennartkoopmann">
        <addColumn tableName="bandit_identifiers">
            <column name="identifier_uuid" type="uuid">
                <constraints nullable="false" unique="true" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="17" author="lennartkoopmann">
        <addColumn tableName="bandits">
            <column name="read_only" type="boolean" defaultValue="false">
                <constraints nullable="false" unique="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="18" author="lennartkoopmann">
        <addColumn tableName="contacts">
            <column name="source_role" type="varchar(75)" defaultValue="LEADER" >
                <constraints nullable="false" unique="false" />
            </column>
        </addColumn>

        <addColumn tableName="contacts">
            <column name="source_name" type="varchar(255)" defaultValue="unknown/migrated">
                <constraints nullable="false" unique="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="19" author="lennartkoopmann">
        <addColumn tableName="contacts">
            <column name="last_signal" type="bigint" defaultValue="0">
                <constraints nullable="false" unique="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="20" author="lennartkoopmann">
        <createTable tableName="sentry_ssids" >
            <column name="id" type="integer" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="ssid" type="varchar(255)">
                <constraints nullable="false" />
            </column>

            <column name="first_seen" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="last_seen" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createIndex indexName="idx_sentry_ssids_standard_lookup" tableName="sentry_ssids" unique="false">
            <column name="ssid" />
        </createIndex>

        <createIndex indexName="idx_sentry_ssids_list_lookup" tableName="sentry_ssids" unique="false">
            <column name="last_seen" />
        </createIndex>
    </changeSet>

    <changeSet id="21" author="lennartkoopmann">
        <createTable tableName="deauth_monitor" >
            <column name="id" type="integer" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="total_frame_count" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createIndex indexName="idx_deauth_frame_count_standard_lookup" tableName="deauth_monitor" unique="false">
            <column name="created_at" />
        </createIndex>
    </changeSet>

    <changeSet id="22" author="lennartkoopmann">
        <sqlFile path="db/quartz.sql" />
    </changeSet>

    <changeSet id="23" author="lennartkoopmann">
        <createTable tableName="events" >
            <column name="id" type="integer" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="type" type="varchar(255)">
                <constraints nullable="false" />
            </column>

            <column name="name" type="varchar(255)">
                <constraints nullable="false" />
            </column>

            <column name="description" type="text">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createIndex indexName="idx_events_standard_lookup" tableName="events" unique="false">
            <column name="created_at" />
        </createIndex>
    </changeSet>

    <changeSet id="24" author="lennartkoopmann">
        <createTable tableName="report_receivers_email" >
            <column name="id" type="integer" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="report_name" type="varchar(255)">
                <constraints nullable="false" />
            </column>

            <column name="address" type="varchar(255)">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createIndex indexName="idx_report_emails_standard_lookup" tableName="report_receivers_email" unique="false">
            <column name="report_name" />
        </createIndex>
    </changeSet>

    <changeSet id="25" author="lennartkoopmann">
        <createTable tableName="report_metadata" >
            <column name="id" type="integer" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="report_name" type="varchar(255)">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createIndex indexName="idx_report_meta_standard_lookup" tableName="report_metadata" unique="false">
            <column name="report_name" />
        </createIndex>
    </changeSet>

    <changeSet id="26" author="lennartkoopmann">
        <createTable tableName="report_execution_log" >
            <column name="id" type="integer" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="report_name" type="varchar(255)">
                <constraints nullable="false" />
            </column>

            <column name="result" type="varchar(25)">
                <constraints nullable="false" />
            </column>

            <column name="message" type="text">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createIndex indexName="idx_report_log_standard_lookup" tableName="report_execution_log" unique="false">
            <column name="report_name" />
            <column name="created_at" />
        </createIndex>
    </changeSet>

    <changeSet id="27" author="lennartkoopmann">
        <createTable tableName="reports" >
            <column name="id" type="integer" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="report_name" type="varchar(255)">
                <constraints nullable="false" />
            </column>

            <column name="report" type="text">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createIndex indexName="idx_reports_standard_lookup" tableName="reports" unique="false">
            <column name="report_name" />
            <column name="created_at" />
        </createIndex>
    </changeSet>

    <changeSet id="28" author="lennartkoopmann">
        <dropTable tableName="reports" />

        <addColumn tableName="report_execution_log">
            <column name="content" type="text">
                <constraints nullable="true" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="29" author="lennartkoopmann">
        <createTable tableName="contacts_ssids" >
            <column name="id" type="integer" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="contact_uuid" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="ssid" type="text">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createIndex indexName="idx_contacts_ssids_standard_lookup" tableName="contacts_ssids" unique="false">
            <column name="contact_uuid" />
        </createIndex>

        <createIndex indexName="idx_contacts_ssids_upsert_lookup" tableName="contacts_ssids" unique="false">
            <column name="contact_uuid" />
            <column name="ssid" />
        </createIndex>

        <addForeignKeyConstraint    constraintName="link_contacts2ssids"
                                    baseTableName="contacts_ssids"
                                    baseColumnNames="contact_uuid"
                                    referencedTableName="contacts"
                                    referencedColumnNames="contact_uuid"
                                    onUpdate="NO ACTION"
                                    onDelete="CASCADE" />
    </changeSet>

    <changeSet id="30" author="lennartkoopmann">
        <createTable tableName="contact_records" >
            <column name="id" type="integer" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="contact_uuid" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="record_type" type="varchar(25)">
                <constraints nullable="false" />
            </column>

            <column name="record_value" type="varchar(255)">
                <constraints nullable="false" />
            </column>

            <column name="rssi_average" type="double">
                <constraints nullable="false" />
            </column>

            <column name="rssi_stddev" type="double">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

        </createTable>

        <createIndex indexName="idx_contact_records_standard_lookup" tableName="contact_records" unique="false">
            <column name="contact_uuid" />
            <column name="record_type" />
        </createIndex>

        <addForeignKeyConstraint    constraintName="link_contacts2records"
                                    baseTableName="contact_records"
                                    baseColumnNames="contact_uuid"
                                    referencedTableName="contacts"
                                    referencedColumnNames="contact_uuid"
                                    onUpdate="NO ACTION"
                                    onDelete="CASCADE" />
    </changeSet>

    <changeSet id="31" author="lennartkoopmann">
        <dropTable tableName="contacts_ssids" />
    </changeSet>

    <changeSet id="32" author="lennartkoopmann">
        <addColumn tableName="contact_records">
            <column name="frame_count" type="bigint" defaultValue="0">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="33" author="lennartkoopmann">
        <createTable tableName="taps" >
            <column name="id" type="integer" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="name" type="varchar(50)">
                <constraints nullable="false" />
            </column>

            <column name="local_time" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="processed_bytes_total" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="processed_bytes_10" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="memory_total" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="memory_free" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="memory_used" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="cpu_load" type="double">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="updated_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createIndex indexName="idx_taps_standard_lookup" tableName="taps" unique="false">
            <column name="name" />
        </createIndex>

        <createIndex indexName="idx_taps_active_lookup" tableName="taps" unique="false">
            <column name="name" />
            <column name="updated_at" />
        </createIndex>
    </changeSet>

    <changeSet id="34" author="lennartkoopmann">
        <createTable tableName="base_configuration" >
            <column name="id" type="integer" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="tap_secret" type="varchar(64)">
                <constraints nullable="false" />
            </column>

            <column name="updated_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>
    </changeSet>

    <changeSet id="35" author="lennartkoopmann">
        <addColumn tableName="taps">
            <column name="description" type="text" />
        </addColumn>
    </changeSet>

    <changeSet id="36" author="lennartkoopmann">
        <renameColumn tableName="taps" oldColumnName="processed_bytes_10" newColumnName="processed_bytes_average" />
    </changeSet>

    <changeSet id="37" author="lennartkoopmann">
        <createTable tableName="tap_buses">
            <column name="id" type="integer" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="tap_name" type="varchar(50)">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="updated_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>

        <addUniqueConstraint tableName="taps" columnNames="name" />

        <addForeignKeyConstraint    constraintName="link_taps2buses"
                                    baseTableName="tap_buses"
                                    baseColumnNames="tap_name"
                                    referencedTableName="taps"
                                    referencedColumnNames="name"
                                    onUpdate="NO ACTION"
                                    onDelete="CASCADE" />
    </changeSet>

    <changeSet id="38" author="lennartkoopmann">
        <createTable tableName="bus_channels">
            <column name="id" type="integer" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="bus_id" type="integer">
                <constraints nullable="false" />
            </column>

            <column name="name" type="varchar(255)">
                <constraints nullable="false" />
            </column>

            <column name="capacity" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="watermark" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="errors_total" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="errors_average" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="throughput_bytes_total" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="throughput_bytes_average" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="throughput_messages_total" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="throughput_messages_average" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="updated_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>

        <addForeignKeyConstraint    constraintName="link_buses2channels"
                                    baseTableName="bus_channels"
                                    baseColumnNames="bus_id"
                                    referencedTableName="tap_buses"
                                    referencedColumnNames="id"
                                    onUpdate="NO ACTION"
                                    onDelete="CASCADE" />
    </changeSet>

    <changeSet id="39" author="lennartkoopmann">
        <addColumn tableName="tap_buses">
            <column name="name" type="varchar(255)" defaultValue="unknown">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="40" author="lennartkoopmann">
        <createTable tableName="tap_captures">
            <column name="id" type="integer" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="tap_name" type="varchar(50)">
                <constraints nullable="false" />
            </column>

            <column name="interface" type="varchar(255)">
                <constraints nullable="false" />
            </column>

            <column name="capture_type" type="varchar(50)">
                <constraints nullable="false" />
            </column>

            <column name="is_running" type="boolean">
                <constraints nullable="false" />
            </column>

            <column name="received" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="dropped_buffer" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="dropped_interface" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="updated_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>
    </changeSet>

    <changeSet id="41" author="lennartkoopmann">
        <createTable tableName="dns_statistics">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="tap_name" type="varchar(50)">
                <constraints nullable="false" />
            </column>

            <column name="ip" type="varchar(39)">
                <constraints nullable="false" />
            </column>

            <column name="request_count" type="integer">
                <constraints nullable="false" />
            </column>

            <column name="request_bytes" type="integer">
                <constraints nullable="false" />
            </column>

            <column name="response_count" type="integer">
                <constraints nullable="false" />
            </column>

            <column name="response_bytes" type="integer">
                <constraints nullable="false" />
            </column>

            <column name="nxdomain_count" type="integer">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>
    </changeSet>

    <changeSet id="42" author="lennartkoopmann">
        <createTable tableName="dns_nxdomains_log">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="tap_name" type="varchar(50)">
                <constraints nullable="false" />
            </column>

            <column name="ip" type="varchar(39)">
                <constraints nullable="false" />
            </column>

            <column name="server" type="varchar(39)">
                <constraints nullable="false" />
            </column>

            <column name="query_value" type="varchar(255)">
                <constraints nullable="false" />
            </column>

            <column name="data_type" type="varchar(55)">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>
    </changeSet>

    <changeSet id="43" author="lennartkoopmann">
        <createTable tableName="metrics_gauges">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="metric_name" type="varchar(128)">
                <constraints nullable="false" />
            </column>

            <column name="tap_name" type="varchar(50)">
                <constraints nullable="false" />
            </column>

            <column name="metric_value" type="double">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>
    </changeSet>

    <changeSet id="44" author="lennartkoopmann">
        <createIndex indexName="idx_metrics_std_lookup" tableName="metrics_gauges" unique="false">
            <column name="metric_name"/>
            <column name="tap_name"/>
            <column name="created_at"/>
        </createIndex>
    </changeSet>

    <changeSet id="45" author="lennartkoopmann">
        <createTable tableName="dns_pairs">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="ip" type="varchar(39)">
                <constraints nullable="false" />
            </column>

            <column name="server" type="varchar(39)">
                <constraints nullable="false" />
            </column>

            <column name="count" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>
    </changeSet>

    <changeSet id="46" author="lennartkoopmann">
        <addColumn tableName="dns_pairs">
            <column name="tap_name" type="varchar(50)">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="47" author="lennartkoopmann">
        <createIndex indexName="idx_dns_pairs_std_lookup" tableName="metrics_gauges" unique="false">
            <column name="tap_name"/>
            <column name="created_at"/>
        </createIndex>
    </changeSet>

    <changeSet id="48" author="lennartkoopmann">
        <createTable tableName="registry">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="key" type="varchar(128)">
                <constraints nullable="false" />
            </column>

            <column name="value" type="varchar(255)">
                <constraints nullable="false" />
            </column>
        </createTable>
    </changeSet>

    <changeSet id="49" author="lennartkoopmann">
        <createTable tableName="crypto_keys">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="node" type="varchar(255)">
                <constraints nullable="false" />
            </column>

            <column name="key_type" type="varchar(25)">
                <constraints nullable="false" />
            </column>

            <column name="key_signature" type="varchar(255)">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>
    </changeSet>

    <changeSet id="50" author="lennartkoopmann">
        <createTable tableName="registry_encrypted">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="key" type="varchar(128)">
                <constraints nullable="false" />
            </column>

            <column name="value" type="text">
                <constraints nullable="false" />
            </column>

            <column name="key_signature" type="varchar(255)">
                <constraints nullable="false" />
            </column>
        </createTable>
    </changeSet>

    <changeSet id="51" author="lennartkoopmann">
        <createTable tableName="nodes">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="uuid" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="name" type="varchar(255)">
                <constraints nullable="false" />
            </column>

            <column name="transport_address" type="varchar(255)">
                <constraints nullable="false" />
            </column>

            <column name="last_seen" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createIndex tableName="nodes" indexName="idx_node_uuid" unique="true">
            <column name="uuid" />
        </createIndex>
    </changeSet>

    <changeSet id="52" author="lennartkoopmann">
        <addColumn tableName="nodes">
            <column name="version" type="varchar(50)" afterColumn="transport_address" defaultValue="0.0.0">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="53" author="lennartkoopmann">
        <addColumn tableName="nodes">
            <column name="memory_bytes_total" type="bigint" defaultValue="0">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="nodes">
            <column name="memory_bytes_available" type="bigint" defaultValue="0">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="nodes">
            <column name="memory_bytes_used" type="bigint" defaultValue="0">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="nodes">
            <column name="cpu_system_load" type="double" defaultValue="0.0">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="nodes">
            <column name="cpu_thread_count" type="int" defaultValue="0">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="nodes">
            <column name="process_start_time" type="timestamp with time zone" defaultValue="1970-01-01 00:00:00 America/Chicago">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="nodes">
            <column name="process_virtual_size" type="bigint" defaultValue="0">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="nodes">
            <column name="process_arguments" type="text" defaultValue="">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="nodes">
            <column name="os_information" type="varchar(255)" defaultValue="">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="54" author="lennartkoopmann">
        <addColumn tableName="nodes">
            <column name="heap_bytes_total" type="bigint" defaultValue="0">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="nodes">
            <column name="heap_bytes_available" type="bigint" defaultValue="0">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="nodes">
            <column name="heap_bytes_used" type="bigint" defaultValue="0">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="55" author="lennartkoopmann">
        <renameColumn tableName="nodes" oldColumnName="transport_address" newColumnName="http_external_uri" />
    </changeSet>

    <changeSet id="56" author="lennartkoopmann">
        <dropTable tableName="measurements" />
    </changeSet>

    <changeSet id="57" author="lennartkoopmann">
        <renameTable oldTableName="metrics_gauges" newTableName="tap_metrics_gauges" />
    </changeSet>

    <!-- Switching from numbers to text for migration IDs to avoid merge problems. -->

    <changeSet id="create_node_metrics" author="lennartkoopmann">
        <createTable tableName="node_metrics_gauges">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="node_id" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="metric_name" type="varchar(128)">
                <constraints nullable="false" />
            </column>

            <column name="metric_value" type="double">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createIndex indexName="idx_nodemetrics_std_lookup" tableName="node_metrics_gauges" unique="false">
            <column name="metric_name"/>
            <column name="node_id"/>
            <column name="created_at"/>
        </createIndex>
    </changeSet>

    <changeSet id="drop_events" author="lennartkoopmann">
        <dropTable tableName="events" />
    </changeSet>

    <changeSet id="create_node_metrics_timers" author="lennartkoopmann">
        <createTable tableName="node_metrics_timers">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="node_id" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="metric_name" type="varchar(128)">
                <constraints nullable="false" />
            </column>

            <column name="metric_max" type="double">
                <constraints nullable="false" />
            </column>

            <column name="metric_min" type="double">
                <constraints nullable="false" />
            </column>

            <column name="metric_mean" type="double">
                <constraints nullable="false" />
            </column>

            <column name="metric_p99" type="double">
                <constraints nullable="false" />
            </column>

            <column name="metric_stddev" type="double">
                <constraints nullable="false" />
            </column>

            <column name="metric_counter" type="double">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createIndex indexName="idx_nodemetricstimers_std_lookup" tableName="node_metrics_timers" unique="false">
            <column name="metric_name"/>
            <column name="node_id"/>
            <column name="created_at"/>
        </createIndex>
    </changeSet>

    <changeSet id="change_node_metrics_timers_1" author="lennartkoopmann">
        <modifyDataType tableName="node_metrics_timers" columnName="metric_max" newDataType="bigint" />
        <modifyDataType tableName="node_metrics_timers" columnName="metric_min" newDataType="bigint" />
        <modifyDataType tableName="node_metrics_timers" columnName="metric_mean" newDataType="bigint" />
        <modifyDataType tableName="node_metrics_timers" columnName="metric_p99" newDataType="bigint" />
        <modifyDataType tableName="node_metrics_timers" columnName="metric_stddev" newDataType="bigint" />
        <modifyDataType tableName="node_metrics_timers" columnName="metric_counter" newDataType="bigint" />
    </changeSet>

    <changeSet id="add_clock_to_nodes" author="lennartkoopmann">
        <addColumn tableName="nodes">
            <column name="clock" type="timestamp with time zone" defaultValue="1970-01-01 00:00:00 America/Chicago">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="create_health_indicators" author="lennartkoopmann">
        <createTable tableName="health_indicators">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="indicator_id" type="varchar(50)">
                <constraints nullable="false" />
            </column>

            <column name="indicator_name" type="varchar(128)">
                <constraints nullable="false" />
            </column>

            <column name="level" type="varchar(25)">
                <constraints nullable="false" />
            </column>

            <column name="last_checked" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>
    </changeSet>

    <changeSet id="make_health_indicators_id_unique" author="lennartkoopmann">
        <createIndex tableName="health_indicators" indexName="idx_healthindicators_indicatorid" unique="true">
            <column name="indicator_id" />
        </createIndex>
    </changeSet>

    <changeSet id="rename_tap_clock_column" author="lennartkoopmann">
        <renameColumn tableName="taps" oldColumnName="local_time" newColumnName="clock" />
    </changeSet>
    
    <changeSet id="add_node_id_to_crypto_keys_and_rename_node_name" author="lennartkoopmann">
        <renameColumn tableName="crypto_keys" oldColumnName="node" newColumnName="node_name" />

        <addColumn tableName="crypto_keys">
            <column name="node_id" type="uuid" defaultValueComputed="gen_random_uuid()" afterColumn="node_name">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_deleted_field_to_nodes_and_taps" author="lennartkoopmann">
        <addColumn tableName="nodes">
            <column name="deleted" type="boolean" defaultValue="false">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="taps">
            <column name="deleted" type="boolean" defaultValue="false">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_deactivation_to_health_indicators" author="lennartkoopmann">
        <addColumn tableName="health_indicators">
            <column name="active" type="boolean" defaultValue="true">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_tls_cert_table" author="lennartkoopmann">
        <createTable tableName="crypto_tls_certificates">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="node_id" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="certificate" type="text">
                <constraints nullable="false" />
            </column>

            <column name="key" type="text">
                <constraints nullable="false" />
            </column>

            <column name="valid_from" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="expires_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>
    </changeSet>

    <changeSet id="add_listen_uri_to_nodes" author="lennartkoopmann">
        <addColumn tableName="nodes">
            <column name="http_listen_uri" type="varchar(255)" defaultValue="https://0.0.0.0:22900">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_source_type_to_tls_certs" author="lennartkoopmann">
        <addColumn tableName="crypto_tls_certificates">
            <column name="source_type" type="varchar(50)" defaultValue="TEST">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_tls_wildcard_cert_table" author="lennartkoopmann">
        <createTable tableName="crypto_tls_certificates_wildcard">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="node_matcher" type="varchar(255)">
                <constraints nullable="false" />
            </column>

            <column name="certificate" type="text">
                <constraints nullable="false" />
            </column>

            <column name="key" type="text">
                <constraints nullable="false" />
            </column>

            <column name="valid_from" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="expires_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="source_type" type="varchar(50)" defaultValue="TEST">
                <constraints nullable="false" />
            </column>
        </createTable>
    </changeSet>

    <changeSet id="add_message_bus_messages_table" author="lennartkoopmann">
        <createTable tableName="message_bus_messages">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="sender_node_id" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="receiver_node_id" type="uuid" />

            <column name="type" type="varchar(128)">
                <constraints nullable="false" />
            </column>

            <column name="parameters" type="text" />

            <column name="status" type="varchar(64)">
                <constraints nullable="false" />
            </column>

            <column name="cycle_limiter" type="bigint" />

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="acknowledged_at" type="timestamp with time zone" />
        </createTable>
    </changeSet>

    <changeSet id="add_node_cylces" author="lennartkoopmann">
        <addColumn tableName="nodes">
            <column name="cycle" type="bigint" defaultValue="1">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_lookup_index_to_messagebus" author="lennartkoopmann">
        <createIndex indexName="idx_msgbus_std_lookup" tableName="message_bus_messages" unique="false">
            <column name="receiver_node_id" />
            <column name="status" />
            <column name="cycle_limiter" />
        </createIndex>

        <createIndex indexName="idx_msgbus_nack_lookup" tableName="message_bus_messages" unique="false">
            <column name="status" />
        </createIndex>
    </changeSet>

    <changeSet id="add_tasks_queue_table" author="lennartkoopmann">
        <createTable tableName="tasks_queue">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="sender_node_id" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="type" type="varchar(128)">
                <constraints nullable="false" />
            </column>

            <column name="max_attempts" type="int" defaultValue="0">
                <constraints nullable="false" />
            </column>

            <column name="allow_retry" type="boolean" >
                <constraints nullable="false" />
            </column>

            <column name="parameters" type="text" />

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="status" type="varchar(64)">
                <constraints nullable="false" />
            </column>

            <column name="attempts" type="int" defaultValue="0">
                <constraints nullable="false" />
            </column>

            <column name="processing_time_ms" type="int" defaultValue="0">
                <constraints nullable="false" />
            </column>

            <column name="first_processed_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="last_processed_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createIndex indexName="idx_tskque_status_lookup" tableName="tasks_queue" unique="false">
            <column name="status" />
        </createIndex>
    </changeSet>

    <changeSet id="add_process_self_info_to_tasks_queue" author="lennartkoopmann">
        <addColumn tableName="tasks_queue">
            <column name="allow_process_self" type="boolean">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="remove_unnecessary_columns_in_tasks" author="lennartkoopmann">
        <dropColumn tableName="tasks_queue" columnName="max_attempts" />
        <renameColumn tableName="tasks_queue" oldColumnName="attempts" newColumnName="retries" />

        <dropNotNullConstraint tableName="tasks_queue" columnName="first_processed_at" />
        <dropNotNullConstraint tableName="tasks_queue" columnName="last_processed_at" />
    </changeSet>

    <changeSet id="add_previous_status_to_tasks_queue" author="lennartkoopmann">
        <addColumn tableName="tasks_queue">
            <column name="previous_status" type="varchar(64)" defaultValue="NEW">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_public_key_to_nodes" author="lennartkoopmann">
        <addColumn tableName="nodes">
            <column name="public_key" type="text" defaultValue="">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_last_acked_to_tasks_queue" author="lennartkoopmann">
        <addColumn tableName="tasks_queue">
            <column name="last_acked_at" type="timestamp with time zone" />
        </addColumn>
    </changeSet>

    <changeSet id="add_processed_by_to_tasks_queue" author="lennartkoopmann">
        <addColumn tableName="tasks_queue">
            <column name="processed_by" type="uuid" />
        </addColumn>
    </changeSet>

    <changeSet id="add_acked_by_to_tasks_queue" author="lennartkoopmann">
        <addColumn tableName="tasks_queue">
            <column name="acked_by" type="uuid" />
        </addColumn>
    </changeSet>

    <changeSet id="add_acked_by_to_message_bus" author="lennartkoopmann">
        <addColumn tableName="message_bus_messages">
            <column name="acknowledged_by" type="uuid" />
        </addColumn>
    </changeSet>

    <changeSet id="add_processing_time_to_message_bus" author="lennartkoopmann">
        <addColumn tableName="message_bus_messages">
            <column name="processing_time_ms" type="int" />
        </addColumn>
    </changeSet>

    <changeSet id="add_version_to_taps" author="lennartkoopmann">
        <addColumn tableName="taps">
            <column name="version" type="varchar(64)" />
        </addColumn>
    </changeSet>

    <changeSet id="add_organizations" author="lennartkoopmann">
        <createTable tableName="auth_organizations">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="name" type="varchar(256)">
                <constraints unique="true" nullable="false" />
            </column>

            <column name="description" type="text">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="updated_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>
    </changeSet>

    <changeSet id="add_tenants" author="lennartkoopmann">
        <createTable tableName="auth_tenants">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="organization_id" type="bigint">
                <constraints unique="true" nullable="false" />
            </column>

            <column name="name" type="varchar(256)">
                <constraints unique="true" nullable="false" />
            </column>

            <column name="description" type="text">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="updated_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>

        <addForeignKeyConstraint    constraintName="link_tenants2orgs"
                                    baseTableName="auth_tenants"
                                    baseColumnNames="organization_id"
                                    referencedTableName="auth_organizations"
                                    referencedColumnNames="id"
                                    onUpdate="NO ACTION"
                                    onDelete="CASCADE"
        />
    </changeSet>

    <changeSet id="fix_tenants2orgs_key_constraint" author="lennartkoopmann">
        <dropForeignKeyConstraint baseTableName="auth_tenants" constraintName="link_tenants2orgs" />
        <addForeignKeyConstraint    constraintName="link_tenants2orgs"
                                    baseTableName="auth_tenants"
                                    baseColumnNames="organization_id"
                                    referencedTableName="auth_organizations"
                                    referencedColumnNames="id"
                                    onUpdate="NO ACTION"
                                    onDelete="RESTRICT"
        />
    </changeSet>

    <changeSet id="fix_wrong_auth_constraints" author="lennartkoopmann">
        <dropUniqueConstraint tableName="auth_organizations" constraintName="auth_organizations_name_key" />
        <dropUniqueConstraint tableName="auth_tenants" constraintName="auth_tenants_name_key" />
        <dropUniqueConstraint tableName="auth_tenants" constraintName="auth_tenants_organization_id_key" />
    </changeSet>

    <changeSet id="add_roles" author="lennartkoopmann">
        <createTable tableName="auth_roles">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="tenant_id" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="description" type="text">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="updated_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>

        <addForeignKeyConstraint    constraintName="link_roles2tenants"
                                    baseTableName="auth_roles"
                                    baseColumnNames="tenant_id"
                                    referencedTableName="auth_tenants"
                                    referencedColumnNames="id"
                                    onUpdate="NO ACTION"
                                    onDelete="RESTRICT"
        />
    </changeSet>

    <changeSet id="add_users" author="lennartkoopmann">
        <createTable tableName="auth_users">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="tenant_id" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="role_id" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="email" type="varchar(128)">
                <constraints nullable="false" />
            </column>

            <column name="password" type="text">
                <constraints nullable="false" />
            </column>

            <column name="name" type="varchar(128)">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="updated_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>

        <addForeignKeyConstraint    constraintName="link_users2tenants"
                                    baseTableName="auth_users"
                                    baseColumnNames="tenant_id"
                                    referencedTableName="auth_tenants"
                                    referencedColumnNames="id"
                                    onUpdate="NO ACTION"
                                    onDelete="RESTRICT"
        />

        <addForeignKeyConstraint    constraintName="link_users2roles"
                                    baseTableName="auth_users"
                                    baseColumnNames="role_id"
                                    referencedTableName="auth_roles"
                                    referencedColumnNames="id"
                                    onUpdate="NO ACTION"
                                    onDelete="RESTRICT"
        />
    </changeSet>

    <changeSet id="change_roles_level" author="lennartkoopmann">
        <dropForeignKeyConstraint baseTableName="auth_roles" constraintName="link_roles2tenants" />
        <dropColumn tableName="auth_roles" columnName="tenant_id" />

        <addColumn tableName="auth_roles">
            <column name="organization_id" type="bigint">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="auth_users">
            <column name="is_superadmin" type="boolean" defaultValue="false">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addForeignKeyConstraint    constraintName="link_roles2orgs"
                                    baseTableName="auth_roles"
                                    baseColumnNames="organization_id"
                                    referencedTableName="auth_organizations"
                                    referencedColumnNames="id"
                                    onUpdate="NO ACTION"
                                    onDelete="RESTRICT"
        />
    </changeSet>

    <changeSet id="extend_users" author="lennartkoopmann">
        <addColumn tableName="auth_users">
            <column name="is_orgadmin" type="boolean">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="auth_users">
            <column name="organization_id" type="bigint">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="auth_users">
            <column name="password_salt" type="text">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <dropNotNullConstraint tableName="auth_users" columnName="role_id" />
    </changeSet>

    <changeSet id="extend_taps" author="lennartkoopmann">
        <addColumn tableName="taps">
            <column name="secret" type="varchar(64)">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="taps">
            <column name="organization_id" type="bigint">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="taps">
            <column name="tenant_id" type="bigint">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="taps">
            <column name="last_report" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="fix_taps_notnull_for_new_model" author="lennartkoopmann">
        <dropNotNullConstraint tableName="taps" columnName="clock" />
        <dropNotNullConstraint tableName="taps" columnName="processed_bytes_total" />
        <dropNotNullConstraint tableName="taps" columnName="processed_bytes_average" />
        <dropNotNullConstraint tableName="taps" columnName="memory_total" />
        <dropNotNullConstraint tableName="taps" columnName="memory_free" />
        <dropNotNullConstraint tableName="taps" columnName="memory_used" />
        <dropNotNullConstraint tableName="taps" columnName="cpu_load" />
        <dropNotNullConstraint tableName="taps" columnName="last_report" />

        <addNotNullConstraint tableName="taps" columnName="description" />
    </changeSet>

    <changeSet id="move_tap_refs_from_name_to_uuid" author="lennartkoopmann">
        <addColumn tableName="taps">
            <column name="uuid" type="uuid">
                <constraints nullable="false" unique="true" />
            </column>
        </addColumn>

        <dropColumn tableName="tap_metrics_gauges" columnName="tap_name" />
        <addColumn tableName="tap_metrics_gauges">
            <column name="tap_uuid" type="uuid">
                <constraints nullable="false" unique="true" />
            </column>
        </addColumn>

        <dropColumn tableName="tap_captures" columnName="tap_name" />
        <addColumn tableName="tap_captures">
            <column name="tap_uuid" type="uuid">
                <constraints nullable="false" unique="true" />
            </column>
        </addColumn>
        <addForeignKeyConstraint    constraintName="link_taps2captures"
                                    baseTableName="tap_captures"
                                    baseColumnNames="tap_uuid"
                                    referencedTableName="taps"
                                    referencedColumnNames="uuid"
                                    onUpdate="NO ACTION"
                                    onDelete="CASCADE" />

        <addColumn tableName="tap_buses">
            <column name="tap_uuid" type="uuid">
                <constraints nullable="false" unique="true" />
            </column>
        </addColumn>
        <dropForeignKeyConstraint baseTableName="tap_buses" constraintName="link_taps2buses" />
        <addForeignKeyConstraint    constraintName="link_taps2buses"
                                    baseTableName="tap_buses"
                                    baseColumnNames="tap_uuid"
                                    referencedTableName="taps"
                                    referencedColumnNames="uuid"
                                    onUpdate="NO ACTION"
                                    onDelete="CASCADE" />
        <dropColumn tableName="tap_buses" columnName="tap_name" />
    </changeSet>

    <changeSet id="make_tap_secret_unique" author="lennartkoopmann">
        <addUniqueConstraint tableName="taps" columnNames="secret" />
    </changeSet>

    <changeSet id="remove_tap_name_unique_constraint" author="lennartkoopmann">
        <dropUniqueConstraint tableName="taps" constraintName="taps_name_key" />
    </changeSet>

    <changeSet id="change_dns_table_tap_name_to_id" author="lennartkoopmann">
        <dropColumn tableName="dns_nxdomains_log" columnName="tap_name" />
        <dropColumn tableName="dns_pairs" columnName="tap_name" />
        <dropColumn tableName="dns_statistics" columnName="tap_name" />

        <addColumn tableName="dns_nxdomains_log">
            <column name="tap_uuid" type="uuid">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="dns_pairs">
            <column name="tap_uuid" type="uuid">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="dns_statistics">
            <column name="tap_uuid" type="uuid">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="fix_tap_uuid_uniqueness_after_name_change" author="lennartkoopmann">
        <dropUniqueConstraint tableName="tap_metrics_gauges" constraintName="tap_metrics_gauges_tap_uuid_key" />
        <dropUniqueConstraint tableName="tap_captures" constraintName="tap_captures_tap_uuid_key" />
        <dropUniqueConstraint tableName="tap_buses" constraintName="tap_buses_tap_uuid_key" />
    </changeSet>

    <changeSet id="increase_tap_secret_size_for_encryption" author="lennartkoopmann">
        <dropColumn tableName="taps" columnName="secret" />

        <addColumn tableName="taps">
            <column name="secret" type="text">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="create_sessions_table" author="lennartkoopmann">
        <createTable tableName="auth_sessions">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="sessionid" type="text">
                <constraints nullable="false" unique="true" />
            </column>

            <column name="user_id" type="bigint">
                <constraints nullable="false" unique="true" />
            </column>

            <column name="remote_ip" type="varchar(45)">
                <constraints nullable="false" unique="true" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="last_activity" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>

        <addForeignKeyConstraint    constraintName="link_users2sessions"
                                    baseTableName="auth_sessions"
                                    baseColumnNames="user_id"
                                    referencedTableName="auth_users"
                                    referencedColumnNames="id"
                                    onUpdate="NO ACTION"
                                    onDelete="CASCADE" />
    </changeSet>

    <changeSet id="make_user_email_unique" author="lennartkoopmann">
        <addUniqueConstraint tableName="auth_users" columnNames="email" />
    </changeSet>

    <changeSet id="move_last_activity_from_session_to_user" author="lennartkoopmann">
        <dropColumn tableName="auth_sessions" columnName="last_activity" />

        <addColumn tableName="auth_users">
            <column name="last_activity" type="timestamp with time zone" defaultValueComputed="NOW()">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="prepare_users_table_for_admins_outside_org_tenant" author="lennartkoopmann">
        <dropNotNullConstraint tableName="auth_users" columnName="organization_id" />
        <dropNotNullConstraint tableName="auth_users" columnName="tenant_id" />
    </changeSet>

    <changeSet id="remove_uniqueness_of_session_remote_ip" author="lennartkoopmann">
        <dropUniqueConstraint tableName="auth_sessions" constraintName="auth_sessions_remote_ip_key" />
    </changeSet>

    <changeSet id="add_mfa_and_elevation_to_sessions" author="lennartkoopmann">
        <addColumn tableName="auth_sessions">
            <column name="elevated" type="boolean" defaultValue="false">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="auth_sessions">
            <column name="elevated_since" type="timestamp with time zone">
                <constraints nullable="true" />
            </column>
        </addColumn>

        <addColumn tableName="auth_sessions">
            <column name="mfa_valid" type="boolean" defaultValue="false">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_mfa_totp_secret_to_users" author="lennartkoopmann">
        <addColumn tableName="auth_users">
            <column name="totp_secret" type="text">
                <constraints nullable="true" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_more_mfa_fields_to_users" author="lennartkoopmann">
        <addColumn tableName="auth_users">
            <column name="mfa_complete" type="boolean" defaultValue="false">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="auth_users">
            <column name="mfa_recovery_codes" type="text">
                <constraints nullable="true" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_mfa_requested_at" author="lennartkoopmann">
        <addColumn tableName="auth_sessions">
            <column name="mfa_requested_at" type="timestamp with time zone" defaultValue="NULL">
                <constraints nullable="true" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="fix_user_last_activity_default_value" author="lennartkoopmann">
        <dropNotNullConstraint tableName="auth_users" columnName="last_activity" />
        <dropDefaultValue tableName="auth_users" columnName="last_activity" />
    </changeSet>

    <changeSet id="add_geo_fields_to_users" author="lennartkoopmann">
        <addColumn tableName="auth_users">
            <column name="last_remote_ip" type="varchar(45)">
                <constraints nullable="true" />
            </column>
        </addColumn>

        <addColumn tableName="auth_users">
            <column name="last_geo_country" type="varchar(5)">
                <constraints nullable="true" />
            </column>
        </addColumn>

        <addColumn tableName="auth_users">
            <column name="last_geo_city" type="varchar(128)">
                <constraints nullable="true" />
            </column>
        </addColumn>

        <addColumn tableName="auth_users">
            <column name="last_geo_asn" type="varchar(255)">
                <constraints nullable="true" />
            </column>
        </addColumn>
    </changeSet>
    
    <changeSet id="create_permissions_table" author="lennartkoopmann">
        <createTable tableName="auth_permissions">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="user_id" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="permission" type="varchar(128)">
                <constraints nullable="false" />
            </column>
        </createTable>

        <addForeignKeyConstraint    constraintName="link_users2permissions"
                                    baseTableName="auth_permissions"
                                    baseColumnNames="user_id"
                                    referencedTableName="auth_users"
                                    referencedColumnNames="id"
                                    onUpdate="NO ACTION"
                                    onDelete="CASCADE" />
    </changeSet>

    <changeSet id="create_users_taps_permissions_table" author="lennartkoopmann">
        <createTable tableName="auth_users_taps">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="user_id" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="tap_id" type="bigint">
                <constraints nullable="false" />
            </column>
        </createTable>

        <addForeignKeyConstraint    constraintName="link_users2tapperms"
                                    baseTableName="auth_users_taps"
                                    baseColumnNames="user_id"
                                    referencedTableName="auth_users"
                                    referencedColumnNames="id"
                                    onUpdate="NO ACTION"
                                    onDelete="CASCADE" />
    </changeSet>

    <changeSet id="add_access_to_all_taps_field_for_users" author="lennartkoopmann">
        <addColumn tableName="auth_users">
            <column name="access_all_tenant_taps" type="boolean" defaultValue="true">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="change_user_taps_uuid_type" author="lennartkoopmann">
        <dropColumn tableName="auth_users_taps" columnName="tap_id" />

        <addColumn tableName="auth_users_taps">
            <column name="tap_id" type="uuid">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_uuids_to_all_auth_tables" author="lennartkoopmann">
        <addColumn tableName="auth_organizations">
            <column name="uuid" type="uuid" defaultValueComputed="gen_random_uuid()">
                <constraints nullable="false" unique="true" />
            </column>
        </addColumn>

        <addColumn tableName="auth_tenants">
            <column name="uuid" type="uuid" defaultValueComputed="gen_random_uuid()">
                <constraints nullable="false" unique="true" />
            </column>
        </addColumn>

        <addColumn tableName="auth_users">
            <column name="uuid" type="uuid" defaultValueComputed="gen_random_uuid()">
                <constraints nullable="false" unique="true" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="remove_unused_table" author="lennartkoopmann">
        <dropForeignKeyConstraint baseTableName="auth_users" constraintName="link_users2roles" />
        <dropTable tableName="auth_roles" />
    </changeSet>

    <changeSet id="fix_bigint_uuid_relations" author="lennartkoopmann">
        <dropColumn tableName="auth_permissions" columnName="user_id" />
        <addColumn tableName="auth_permissions">
            <column name="user_id" type="uuid">
                <constraints nullable="false" />
            </column>
        </addColumn>
        <addForeignKeyConstraint constraintName="link_users2permissions"
                                 baseTableName="auth_permissions"
                                 baseColumnNames="user_id"
                                 referencedTableName="auth_users"
                                 referencedColumnNames="uuid"
                                 onUpdate="NO ACTION"
                                 onDelete="CASCADE" />

        <dropColumn tableName="auth_sessions" columnName="user_id" />
        <addColumn tableName="auth_sessions">
            <column name="user_id" type="uuid">
                <constraints nullable="false" />
            </column>
        </addColumn>
        <addForeignKeyConstraint constraintName="link_users2sessions"
                                 baseTableName="auth_sessions"
                                 baseColumnNames="user_id"
                                 referencedTableName="auth_users"
                                 referencedColumnNames="uuid"
                                 onUpdate="NO ACTION"
                                 onDelete="CASCADE" />

        <dropColumn tableName="auth_tenants" columnName="organization_id" />
        <addColumn tableName="auth_tenants">
            <column name="organization_id" type="uuid">
                <constraints nullable="false" />
            </column>
        </addColumn>
        <addForeignKeyConstraint constraintName="link_tenants2orgs"
                                 baseTableName="auth_tenants"
                                 baseColumnNames="organization_id"
                                 referencedTableName="auth_organizations"
                                 referencedColumnNames="uuid"
                                 onUpdate="NO ACTION"
                                 onDelete="RESTRICT"
        />

        <dropColumn tableName="auth_users" columnName="tenant_id" />
        <addColumn tableName="auth_users">
            <column name="tenant_id" type="uuid">
                <constraints nullable="false" />
            </column>
        </addColumn>
        <addForeignKeyConstraint constraintName="link_users2tenants"
                                 baseTableName="auth_users"
                                 baseColumnNames="tenant_id"
                                 referencedTableName="auth_tenants"
                                 referencedColumnNames="uuid"
                                 onUpdate="NO ACTION"
                                 onDelete="RESTRICT"
        />

        <dropColumn tableName="auth_users" columnName="organization_id" />
        <addColumn tableName="auth_users">
            <column name="organization_id" type="uuid">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <dropColumn tableName="auth_users_taps" columnName="user_id" />
        <addColumn tableName="auth_users_taps">
            <column name="user_id" type="uuid">
                <constraints nullable="false" />
            </column>
        </addColumn>
        <addForeignKeyConstraint constraintName="link_users2tapperms"
                                 baseTableName="auth_users_taps"
                                 baseColumnNames="user_id"
                                 referencedTableName="auth_users"
                                 referencedColumnNames="uuid"
                                 onUpdate="NO ACTION"
                                 onDelete="CASCADE" />

        <dropColumn tableName="taps" columnName="organization_id" />
        <addColumn tableName="taps">
            <column name="organization_id" type="uuid">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <dropColumn tableName="taps" columnName="tenant_id" />
        <addColumn tableName="taps">
            <column name="tenant_id" type="uuid">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <dropColumn tableName="auth_users" columnName="role_id" />
    </changeSet>

    <changeSet id="fix_null_constraints_after_uuid_change" author="lennartkoopmann">
        <dropNotNullConstraint tableName="auth_users" columnName="organization_id" />
        <dropNotNullConstraint tableName="auth_users" columnName="tenant_id" />
    </changeSet>

    <changeSet id="add_user_login_bruteforce_detection" author="lennartkoopmann">
        <addColumn tableName="auth_users">
            <column name="failed_login_count" type="int">
                <constraints nullable="true" />
            </column>
        </addColumn>

        <addColumn tableName="auth_users">
            <column name="last_failed_login" type="timestamp with time zone">
                <constraints nullable="true" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="remove_unneeded_last_failed_login_timestamp" author="lennartkoopmann">
        <dropColumn tableName="auth_users" columnName="last_failed_login" />
    </changeSet>

    <changeSet id="create_events" author="lennartkoopmann">
        <createTable tableName="event_actions">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="uuid" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="action_type" type="varchar(64)">
                <constraints nullable="false" />
            </column>

            <column name="organization_id" type="uuid">
                <constraints nullable="true" />
            </column>

            <column name="tenant_id" type="uuid">
                <constraints nullable="true" />
            </column>

            <column name="name" type="varchar(255)">
                <constraints nullable="false" />
            </column>

            <column name="description" type="text">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createTable tableName="event_subscriptions">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="subscription_type" type="varchar(64)">
                <constraints nullable="false" />
            </column>

            <column name="reference" type="varchar(255)">
                <constraints nullable="false" />
            </column>

            <column name="event_action_id" type="uuid">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createTable tableName="events">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="uuid" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="organization_id" type="uuid">
                <constraints nullable="true" />
            </column>

            <column name="tenant_id" type="uuid">
                <constraints nullable="true" />
            </column>

            <column name="event_type" type="varchar(64)">
                <constraints nullable="false" />
            </column>

            <column name="reference" type="varchar(255)">
                <constraints nullable="false" />
            </column>

            <column name="title" type="varchar(255)">
                <constraints nullable="false" />
            </column>

            <column name="description" type="varchar(255)">
                <constraints nullable="false" />
            </column>

            <column name="actions_fired" type="text">
                <constraints nullable="true" />
            </column>
        </createTable>
    </changeSet>

    <changeSet id="change_events_layout" author="lennartkoopmann">
        <addDefaultValue tableName="events" columnName="uuid" defaultValueComputed="gen_random_uuid()" />
        <dropColumn tableName="events" columnName="title" />
        <dropColumn tableName="events" columnName="description" />
        <addColumn tableName="events">
            <column name="details" type="text">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_timestamp_to_events" author="lennartkoopmann">
        <addColumn tableName="events">
            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="remove_tenant_id_from_event_actions" author="lennartkoopmann">
        <dropColumn tableName="event_actions" columnName="tenant_id" />
    </changeSet>
    
    <changeSet id="add_configuration_to_event_actions" author="lennartkoopmann">
        <addColumn tableName="event_actions">
            <column name="configuration" type="text">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_timestamps_to_event_actions" author="lennartkoopmann">
        <addColumn tableName="event_actions">
            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="event_actions">
            <column name="updated_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="change_event_subscriptions_field_names_add_uuid_org_id" author="lennartkoopmann">
        <renameColumn tableName="event_subscriptions" oldColumnName="subscription_type" newColumnName="event_type" />
        <renameColumn tableName="event_subscriptions" oldColumnName="event_action_id" newColumnName="action_name" />

        <addColumn tableName="event_subscriptions">
            <column name="uuid" type="uuid">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="event_subscriptions">
            <column name="organization_id" type="uuid">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="fix_error_in_event_subscription_action_id_rename" author="lennartkoopmann">
        <renameColumn tableName="event_subscriptions" oldColumnName="action_name" newColumnName="action_id" />
    </changeSet>

    <changeSet id="fix_another_error_in_event_subscriptions_4654234" author="lennartkoopmann">
        <dropNotNullConstraint tableName="event_subscriptions" columnName="organization_id" />
    </changeSet>

    <changeSet id="remove_tables_for_v200" author="lennartkoopmann">
        <dropTable tableName="alerts" />
        <dropTable tableName="contact_records" />
        <dropTable tableName="contacts" />
        <dropTable tableName="bandit_identifiers" />
        <dropTable tableName="bandits" />
        <dropTable tableName="beacon_rate_history" />
        <dropTable tableName="deauth_monitor" />
        <dropTable tableName="report_execution_log" />
        <dropTable tableName="report_metadata" />
        <dropTable tableName="report_receivers_email" />
        <dropTable tableName="scheduler_blob_triggers" />
        <dropTable tableName="scheduler_calendars" />
        <dropTable tableName="scheduler_cron_triggers" />
        <dropTable tableName="scheduler_fired_triggers" />
        <dropTable tableName="scheduler_simprop_triggers" />
        <dropTable tableName="scheduler_simple_triggers" />
        <dropTable tableName="scheduler_triggers" />
        <dropTable tableName="scheduler_job_details" />
        <dropTable tableName="scheduler_locks" />
        <dropTable tableName="scheduler_paused_trigger_grps" />
        <dropTable tableName="scheduler_scheduler_state" />
        <dropTable tableName="sentry_ssids" />
        <dropTable tableName="sigidx_histogram_history" />
    </changeSet>

    <changeSet id="first_802_11_tables" author="lennartkoopmann">
        <createTable tableName="dot11_bssids">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="uuid" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="tap_uuid" type="uuid" >
                <constraints nullable="false" />
            </column>

            <column name="bssid" type="varchar(17)" >
                <constraints nullable="false" />
            </column>

            <column name="oui" type="text" >
                <constraints nullable="true" />
            </column>

            <column name="signal_strength_average" type="float">
                <constraints nullable="false" />
            </column>

            <column name="signal_strength_min" type="int">
                <constraints nullable="false" />
            </column>

            <column name="signal_strength_max" type="int">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>

        <addForeignKeyConstraint constraintName="link_taps2bssids"
                                 baseTableName="dot11_bssids"
                                 baseColumnNames="tap_uuid"
                                 referencedTableName="taps"
                                 referencedColumnNames="uuid"
                                 onUpdate="NO ACTION"
                                 onDelete="CASCADE" />
    </changeSet>

    <changeSet id="create_802_11_ssids_table" author="lennartkoopmann">
        <createTable tableName="dot11_ssids">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="uuid" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="bssid_id" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="security_protocol" type="varchar(4)">
                <constraints nullable="false" />
            </column>

            <column name="security_suites" type="text">
                <constraints nullable="true" />
            </column>

            <column name="fingerprints" type="text">
                <constraints nullable="false" />
            </column>

            <column name="is_wps" type="boolean">
                <constraints nullable="false" />
            </column>

            <column name="signal_strength_average" type="float">
                <constraints nullable="false" />
            </column>

            <column name="signal_strength_min" type="int">
                <constraints nullable="false" />
            </column>

            <column name="signal_strength_max" type="int">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>

        <addForeignKeyConstraint constraintName="link_ssids2bssids"
                                 baseTableName="dot11_ssids"
                                 baseColumnNames="bssid_id"
                                 referencedTableName="dot11_bssids"
                                 referencedColumnNames="id"
                                 onUpdate="NO ACTION"
                                 onDelete="CASCADE" />
    </changeSet>

    <changeSet id="add_fingerprints_to_bssids" author="lennartkoopmann">
        <addColumn tableName="dot11_bssids">
            <column name="fingerprints" type="text">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="make_ssid_security_protocol_longer" author="lennartkoopmann">
        <modifyDataType tableName="dot11_ssids" columnName="security_suites" newDataType="varchar(32)" />
    </changeSet>

    <changeSet id="add_actual_ssid_to_ssids_lmao" author="lennartkoopmann">
        <addColumn tableName="dot11_ssids">
            <column name="ssid" type="varchar(32)">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="make_ssid_security_suites_text" author="lennartkoopmann">
        <modifyDataType tableName="dot11_ssids" columnName="security_suites" newDataType="text" />
    </changeSet>

    <changeSet id="move_fingerprints_to_table" author="lennartkoopmann">
        <createTable tableName="dot11_fingerprints">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="uuid" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="fingerprint" type="varchar(64)">
                <constraints nullable="false" />
            </column>

            <column name="bssid_id" type="bigint">
                <constraints nullable="true" />
            </column>

            <column name="ssid_id" type="bigint">
                <constraints nullable="true" />
            </column>
        </createTable>

        <dropColumn tableName="dot11_bssids" columnName="fingerprints" />
        <dropColumn tableName="dot11_ssids" columnName="fingerprints" />

        <addForeignKeyConstraint constraintName="link_fingerprints2bssids"
                                 baseTableName="dot11_fingerprints"
                                 baseColumnNames="bssid_id"
                                 referencedTableName="dot11_bssids"
                                 referencedColumnNames="id"
                                 onUpdate="NO ACTION"
                                 onDelete="CASCADE" />

        <addForeignKeyConstraint constraintName="link_fingerprints2ssids"
                                 baseTableName="dot11_fingerprints"
                                 baseColumnNames="ssid_id"
                                 referencedTableName="dot11_ssids"
                                 referencedColumnNames="id"
                                 onUpdate="NO ACTION"
                                 onDelete="CASCADE" />
    </changeSet>

    <changeSet id="add_indices_to_first_dot11_tables" author="lennartkoopmann">
        <createIndex tableName="dot11_bssids" indexName="bssids_table_lookup">
            <column name="created_at" />
            <column name="tap_uuid" />
        </createIndex>

        <createIndex tableName="dot11_bssids" indexName="bssids_single_lookup">
            <column name="bssid" />
            <column name="created_at" />
        </createIndex>

        <createIndex tableName="dot11_ssids" indexName="ssids_by_bssid_lookup">
            <column name="created_at" />
            <column name="bssid_id" />
        </createIndex>

        <createIndex tableName="dot11_fingerprints" indexName="fingerprint_bssid_lookup">
            <column name="bssid_id" />
        </createIndex>

        <createIndex tableName="dot11_fingerprints" indexName="fingerprint_ssid_lookup">
            <column name="ssid_id" />
        </createIndex>
    </changeSet>

    <changeSet id="add_hidden_frame_counter_to_bssids" author="lennartkoopmann">
        <addColumn tableName="dot11_bssids">
            <column name="hidden_ssid_frames" type="bigint" defaultValue="0">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_actual_ssids_and_bssids_to_fingerprints" author="lennartkoopmann">
        <addColumn tableName="dot11_fingerprints">
            <column name="ssid" type="varchar(32)">
                <constraints nullable="true" />
            </column>
        </addColumn>

        <addColumn tableName="dot11_fingerprints">
            <column name="bssid" type="varchar(17)">
                <constraints nullable="true" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_actual_bssid_to_ssids" author="lennartkoopmann">
        <addColumn tableName="dot11_ssids">
            <column name="bssid" type="varchar(17)">
                <constraints nullable="true" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_timestamp_to_fingerprints" author="lennartkoopmann">
        <addColumn tableName="dot11_fingerprints">
            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="make_ssid_security_protocol_larger" author="lennartkoopmann">
        <modifyDataType tableName="dot11_ssids" columnName="security_protocol" newDataType="text" />
    </changeSet>

    <changeSet id="add_tap_uuid_to_fingerprints_and_ssids" author="lennartkoopmann">
        <addColumn tableName="dot11_fingerprints">
            <column name="tap_uuid" type="uuid">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="dot11_ssids">
            <column name="tap_uuid" type="uuid">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="remove_ssid_and_bssid_fields_from_fingerprints" author="lennartkoopmann">
        <dropColumn tableName="dot11_fingerprints" columnName="ssid" />
        <dropColumn tableName="dot11_fingerprints" columnName="bssid" />
    </changeSet>

    <changeSet id="create_dot11_channels" author="lennartkoopmann">
        <createTable tableName="dot11_channels">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="uuid" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="frequency" type="integer">
                <constraints nullable="false" />
            </column>

            <column name="ssid_id" type="bigint">
                <constraints nullable="false" />
            </column>
        </createTable>

        <addForeignKeyConstraint constraintName="link_channels2ssids"
                                 baseTableName="dot11_channels"
                                 baseColumnNames="ssid_id"
                                 referencedTableName="dot11_ssids"
                                 referencedColumnNames="id"
                                 onUpdate="NO ACTION"
                                 onDelete="CASCADE" />

        <createIndex tableName="dot11_channels" indexName="channel_ssid_id_lookup">
            <column name="ssid_id" />
        </createIndex>
    </changeSet>

    <changeSet id="add_stats_fields_to_dot11_channels" author="lennrtkoopmann">
        <addColumn tableName="dot11_channels">
            <column name="frame_type" type="varchar(32)">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="dot11_channels">
            <column name="stats_bytes" type="bigint">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="dot11_channels">
            <column name="stats_frames" type="bigint">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="create_dot11_infrastructure_types" author="lennartkoopmann">
        <createTable tableName="dot11_infrastructure_types">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="infrastructure_type" type="varchar(32)">
                <constraints nullable="false" />
            </column>

            <column name="ssid_id" type="bigint">
                <constraints nullable="false" />
            </column>
        </createTable>

        <addForeignKeyConstraint constraintName="link_iftypes2ssids"
                                 baseTableName="dot11_infrastructure_types"
                                 baseColumnNames="ssid_id"
                                 referencedTableName="dot11_ssids"
                                 referencedColumnNames="id"
                                 onUpdate="NO ACTION"
                                 onDelete="CASCADE" />

        <createIndex tableName="dot11_infrastructure_types" indexName="iftype_ssid_id_lookup">
            <column name="ssid_id" />
        </createIndex>
    </changeSet>

    <changeSet id="create_dot11_clients" author="lennartkoopmann">
        <createTable tableName="dot11_clients">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="uuid" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="bssid_id" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="client_mac" type="varchar(17)">
                <constraints nullable="false" />
            </column>

            <column name="tx_frames" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="tx_bytes" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="rx_frames" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="rx_bytes" type="bigint">
                <constraints nullable="false" />
            </column>
        </createTable>

        <addForeignKeyConstraint constraintName="link_clients2bssids"
                                 baseTableName="dot11_clients"
                                 baseColumnNames="bssid_id"
                                 referencedTableName="dot11_bssids"
                                 referencedColumnNames="id"
                                 onUpdate="NO ACTION"
                                 onDelete="CASCADE" />

        <createIndex tableName="dot11_clients" indexName="clients_bssid_id_lookup">
            <column name="bssid_id" />
        </createIndex>
    </changeSet>

    <changeSet id="remove_fields_from_dot11_fingerprints" author="lennartkoopmann">
        <dropColumn tableName="dot11_fingerprints" columnName="uuid" />
        <dropColumn tableName="dot11_fingerprints" columnName="created_at" />
        <dropColumn tableName="dot11_fingerprints" columnName="tap_uuid" />
    </changeSet>

    <changeSet id="add_dot11_rates" author="lennartkoopmann">
        <createTable tableName="dot11_rates">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="rate" type="varchar(12)">
                <constraints nullable="false" />
            </column>

            <column name="ssid_id" type="bigint">
                <constraints nullable="false" />
            </column>
        </createTable>

        <addForeignKeyConstraint constraintName="link_rates2ssids"
                                 baseTableName="dot11_rates"
                                 baseColumnNames="ssid_id"
                                 referencedTableName="dot11_ssids"
                                 referencedColumnNames="id"
                                 onUpdate="NO ACTION"
                                 onDelete="CASCADE" />

        <createIndex tableName="dot11_rates" indexName="rates_ssid_id_lookup">
            <column name="ssid_id" />
        </createIndex>
    </changeSet>

    <changeSet id="change_dot11_rates_rate_type" author="lennartkoopmann">
        <modifyDataType tableName="dot11_rates" columnName="rate" newDataType="float" />
    </changeSet>

    <changeSet id="add_beacon_and_proberesp_counts_to_dot11_ssids" author="lennartkoopmann">
        <addColumn tableName="dot11_ssids">
            <column name="beacon_count" type="bigint" defaultValue="0">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="dot11_ssids">
            <column name="proberesp_count" type="bigint" defaultValue="0">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="rename_ssid_frame_counts_to_advertisements" author="lennartkoopmann">
        <renameColumn tableName="dot11_ssids" oldColumnName="beacon_count" newColumnName="beacon_advertisements" />
        <renameColumn tableName="dot11_ssids" oldColumnName="proberesp_count" newColumnName="proberesp_advertisements" />
    </changeSet>

    <changeSet id="remove_uuids_from_dot11_tables" author="lennartkoopmann">
        <dropColumn tableName="dot11_bssids" columnName="uuid" />
        <dropColumn tableName="dot11_channels" columnName="uuid" />
        <dropColumn tableName="dot11_clients" columnName="uuid" />
        <dropColumn tableName="dot11_ssids" columnName="uuid" />
    </changeSet>

    <changeSet id="create_actual_clients_table" author="lennartkoopmann">
        <renameTable oldTableName="dot11_clients" newTableName="dot11_bssid_clients" />
        <dropPrimaryKey tableName="dot11_bssid_clients" />
        <addPrimaryKey tableName="dot11_bssid_clients" columnNames="id" />

        <createTable tableName="dot11_clients">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="tap_uuid" type="uuid">
                <constraints nullable="false" unique="true" />
            </column>

            <column name="client_mac" type="varchar(17)">
                <constraints nullable="false" />
            </column>

            <column name="wildcard_probe_requests" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createTable tableName="dot11_client_probereq_ssids">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="client_id" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="ssid" type="varchar(32)">
                <constraints nullable="false" />
            </column>

            <column name="tap_uuid" type="uuid">
                <constraints nullable="false" unique="true" />
            </column>
        </createTable>

        <addForeignKeyConstraint constraintName="link_probreqs2ssids"
                                 baseTableName="dot11_client_probereq_ssids"
                                 baseColumnNames="client_id"
                                 referencedTableName="dot11_clients"
                                 referencedColumnNames="id"
                                 onUpdate="NO ACTION"
                                 onDelete="CASCADE" />

        <createIndex tableName="dot11_client_probereq_ssids" indexName="probereq_client_id_lookup">
            <column name="client_id" />
        </createIndex>
    </changeSet>

    <changeSet id="fix_clients_tap_uuid_uniqueness" author="lennartkoopmann">
        <dropUniqueConstraint tableName="dot11_clients" constraintName="dot11_clients_tap_uuid_key" />
        <dropUniqueConstraint tableName="dot11_client_probereq_ssids" constraintName="dot11_client_probereq_ssids_tap_uuid_key" />
    </changeSet>

    <changeSet id="add_bssids_index_for_bssid_lookup" author="lennartkoopmann">
        <createIndex tableName="dot11_bssids" indexName="bssids_bssid_lookup">
            <column name="bssid" />
        </createIndex>
    </changeSet>

    <changeSet id="add_more_indices_for_bssid_lookup" author="lennartkoopmann">
        <createIndex tableName="dot11_bssids" indexName="bssids_bssid_timestamp">
            <column name="created_at" />
        </createIndex>

        <createIndex tableName="dot11_bssids" indexName="bssids_bssid_tapuuid">
            <column name="tap_uuid" />
        </createIndex>

        <createIndex tableName="dot11_ssids" indexName="ssids_bssid_lookup">
            <column name="bssid_id" />
        </createIndex>

        <createIndex tableName="dot11_fingerprints" indexName="fingerprints_bssid_lookup">
            <column name="bssid_id" />
        </createIndex>

        <createIndex tableName="dot11_infrastructure_types" indexName="infratypes_ssid_lookup">
            <column name="ssid_id" />
        </createIndex>

        <createIndex tableName="dot11_bssid_clients" indexName="bssidclients_bssid_lookup">
            <column name="bssid_id" />
        </createIndex>
    </changeSet>

    <changeSet id="add_dot11_channel_histogram_table" author="lennartkoopmann">
        <createTable tableName="dot11_channel_histograms">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="channel_id" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="signal_strength" type="integer">
                <constraints nullable="false" />
            </column>

            <column name="frame_count" type="integer">
                <constraints nullable="false" />
            </column>
        </createTable>

        <addForeignKeyConstraint constraintName="link_channelhistos2channels"
                                 baseTableName="dot11_channel_histograms"
                                 baseColumnNames="channel_id"
                                 referencedTableName="dot11_channels"
                                 referencedColumnNames="id"
                                 onUpdate="NO ACTION"
                                 onDelete="CASCADE" />
    </changeSet>

    <changeSet id="change_dot11_channel_histogram_table_to_connect_to_ssid_directly" author="lennartkoopmann">
        <dropTable tableName="dot11_channel_histograms" />

        <createTable tableName="dot11_channel_histograms">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="ssid_id" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="frequency" type="integer">
                <constraints nullable="false" />
            </column>

            <column name="signal_strength" type="integer">
                <constraints nullable="false" />
            </column>

            <column name="frame_count" type="integer">
                <constraints nullable="false" />
            </column>
        </createTable>

        <addForeignKeyConstraint constraintName="link_channelhistos2ssids"
                                 baseTableName="dot11_channel_histograms"
                                 baseColumnNames="ssid_id"
                                 referencedTableName="dot11_ssids"
                                 referencedColumnNames="id"
                                 onUpdate="NO ACTION"
                                 onDelete="CASCADE" />
    </changeSet>

    <changeSet id="optimize_dot11_indices_20230711" author="lennartkoopmann">
        <dropIndex tableName="dot11_bssid_clients" indexName="clients_bssid_id_lookup" /> <!-- duplicate -->
        <dropIndex tableName="dot11_infrastructure_types" indexName="iftype_ssid_id_lookup" /> <!-- duplicate -->
        <dropIndex tableName="dot11_fingerprints" indexName="fingerprints_bssid_lookup" /> <!-- duplicate -->

        <createIndex tableName="dot11_channel_histograms" indexName="channelhistos_rellookup">
            <column name="ssid_id" />
        </createIndex>

        <createIndex tableName="dot11_clients" indexName="clients_stdlookup">
            <column name="tap_uuid" />
            <column name="created_at" />
        </createIndex>

        <createIndex tableName="dot11_clients" indexName="clients_directlookup">
            <column name="tap_uuid" />
            <column name="client_mac" />
            <column name="created_at" />
        </createIndex>
    </changeSet>

    <changeSet id="change_dot11_bssids_index_order" author="lennartkoopmann">
        <dropIndex tableName="dot11_bssids" indexName="bssids_table_lookup" />

        <createIndex tableName="dot11_bssids" indexName="bssids_table_lookup">
            <column name="tap_uuid" />
            <column name="created_at" />
        </createIndex>
    </changeSet>

    <changeSet id="add_dot11_ssids_index_07152023" author="lennartkoopmann">
        <createIndex tableName="dot11_ssids" indexName="ssids_bssid_direct_lookup">
            <column name="bssid" />
            <column name="tap_uuid" />
        </createIndex>
    </changeSet>

    <changeSet id="add_frame_count_to_probe_requests" author="lennartkoopmann">
        <addColumn tableName="dot11_client_probereq_ssids">
            <column name="frame_count" type="bigint" defaultValue="0" />
        </addColumn>
    </changeSet>

    <changeSet id="add_dot11_monitored_networks" author="lennartkoopmann">
        <createTable tableName="dot11_monitored_networks">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="uuid" type="uuid">
                <constraints nullable="false" unique="true" />
            </column>

            <column name="organization_id" type="bigint">
                <constraints nullable="true" />
            </column>

            <column name="tenant_id" type="bigint">
                <constraints nullable="true" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="updated_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>
    </changeSet>

    <changeSet id="add_ssid_to_monitored_networks" author="lennartkoopmann">
        <addColumn tableName="dot11_monitored_networks">
            <column name="ssid" type="text">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_dot11_monitored_networks_bssids_and_fps" author="lennartkoopmann">
        <createTable tableName="dot11_monitored_networks_bssids">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="uuid" type="uuid">
                <constraints nullable="false" unique="true" />
            </column>

            <column name="monitored_network_id" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="bssid" type="varchar(17)">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createTable tableName="dot11_monitored_networks_fingerprints">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="uuid" type="uuid">
                <constraints nullable="false" unique="true" />
            </column>

            <column name="monitored_network_bssid_id" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="fingerprints" type="varchar(64)">
                <constraints nullable="false" />
            </column>
        </createTable>

        <addForeignKeyConstraint constraintName="link_monitoredbssids2ssids"
                                 baseTableName="dot11_monitored_networks_bssids"
                                 baseColumnNames="monitored_network_id"
                                 referencedTableName="dot11_monitored_networks"
                                 referencedColumnNames="id"
                                 onUpdate="NO ACTION"
                                 onDelete="CASCADE" />

        <addForeignKeyConstraint constraintName="link_monitoredfps2bssids"
                                 baseTableName="dot11_monitored_networks_fingerprints"
                                 baseColumnNames="monitored_network_bssid_id"
                                 referencedTableName="dot11_monitored_networks_bssids"
                                 referencedColumnNames="id"
                                 onUpdate="NO ACTION"
                                 onDelete="CASCADE" />
    </changeSet>

    <changeSet id="rename_monitored_fingerprints_fingerprint_column" author="lennartkoopmann">
        <renameColumn tableName="dot11_monitored_networks_fingerprints"
                      oldColumnName="fingerprints"
                      newColumnName="fingerprint" />
    </changeSet>

    <changeSet id="create_dot11_monitored_networks_channels" author="lennartkoopmann">
        <createTable tableName="dot11_monitored_networks_channels">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="uuid" type="uuid">
                <constraints nullable="false" unique="true" />
            </column>

            <column name="monitored_network_id" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="channel" type="integer">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createTable tableName="dot11_monitored_networks_security_suites">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="uuid" type="uuid">
                <constraints nullable="false" unique="true" />
            </column>

            <column name="monitored_network_id" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="suite" type="text">
                <constraints nullable="false" />
            </column>
        </createTable>

        <addForeignKeyConstraint constraintName="link_monitoredchannels2ssids"
                                 baseTableName="dot11_monitored_networks_channels"
                                 baseColumnNames="monitored_network_id"
                                 referencedTableName="dot11_monitored_networks"
                                 referencedColumnNames="id"
                                 onUpdate="NO ACTION"
                                 onDelete="CASCADE" />

        <addForeignKeyConstraint constraintName="link_monitoredsuites2ssids"
                                 baseTableName="dot11_monitored_networks_security_suites"
                                 baseColumnNames="monitored_network_id"
                                 referencedTableName="dot11_monitored_networks"
                                 referencedColumnNames="id"
                                 onUpdate="NO ACTION"
                                 onDelete="CASCADE" />
    </changeSet>

    <changeSet id="rename_monitored_channels_column_to_frequency" author="lennartkoopmann">
        <renameColumn tableName="dot11_monitored_networks_channels" oldColumnName="channel" newColumnName="frequency" />
    </changeSet>
    
    <changeSet id="add_enabled_disabled_state_to_monitored_networks" author="lennartkoopmann">
        <addColumn tableName="dot11_monitored_networks">
            <column name="enabled" type="boolean" defaultValue="false">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_dot11_monitored_networks_detection_fields" author="lennartkoopmann">
        <addColumn tableName="dot11_monitored_networks">
            <column name="status_unexpected_bssid" type="boolean" defaultValue="false">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="dot11_monitored_networks">
            <column name="status_unexpected_ssid" type="boolean" defaultValue="false">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="dot11_monitored_networks">
            <column name="status_unexpected_channel" type="boolean" defaultValue="false">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="dot11_monitored_networks">
            <column name="status_unexpected_security" type="boolean" defaultValue="false">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="dot11_monitored_networks">
            <column name="status_unexpected_fingerprint" type="boolean" defaultValue="false">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="remove_not_needed_dot11_monitored_networks_column_20230726" author="lennartkoopmann">
        <dropColumn tableName="dot11_monitored_networks" columnName="status_unexpected_ssid" />
    </changeSet>

    <changeSet id="add_monitoring_for_802_11_security_protocol" author="lennartkoopmann">
        <renameColumn tableName="dot11_monitored_networks"
                      oldColumnName="status_unexpected_security"
                      newColumnName="status_unexpected_security_suites" />

        <addColumn tableName="dot11_monitored_networks">
            <column name="status_unexpected_security_protocol" type="boolean" defaultValue="false">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>
</databaseChangeLog>