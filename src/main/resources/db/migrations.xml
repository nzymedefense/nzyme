<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">


    <changeSet id="0" author="lennartkoopmann">
        <createTable tableName="measurements" >
            <column name="id" type="integer" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="measurement_type" type="varchar(50)">
                <constraints nullable="false" />
            </column>

            <column name="measurement_value" type="integer">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp">
                <constraints nullable="false" />
            </column>
        </createTable>
    </changeSet>

    <changeSet id="1" author="lennartkoopmann">
        <createIndex indexName="idx_measurements_standard_lookup" tableName="measurements" unique="false">
            <column name="measurement_type" />
            <column name="created_at" />
        </createIndex>

        <createIndex indexName="idx_measurements_created_at" tableName="measurements" unique="false">
            <column name="created_at" />
        </createIndex>
    </changeSet>

    <changeSet id="2" author="lennartkoopmann">
        <createTable tableName="signal_index_history" >
            <column name="id" type="integer" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="bssid" type="varchar(17)">
                <constraints nullable="false" />
            </column>

            <column name="ssid" type="varchar(255)">
                <constraints nullable="false" />
            </column>

            <column name="channel" type="integer">
                <constraints nullable="false" />
            </column>

            <column name="signal_index" type="float">
                <constraints nullable="true" />
            </column>

            <column name="signal_index_threshold" type="float">
                <constraints nullable="true" />
            </column>

            <column name="signal_quality" type="integer">
                <constraints nullable="true" />
            </column>

            <column name="signal_stddev" type="float">
                <constraints nullable="true" />
            </column>

            <column name="expected_delta_upper" type="integer">
                <constraints nullable="true" />
            </column>

            <column name="expected_delta_lower" type="integer">
                <constraints nullable="true" />
            </column>

            <column name="created_at" type="timestamp">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createIndex indexName="idx_sigindex_standard_lookup" tableName="signal_index_history" unique="false">
            <column name="bssid" />
            <column name="ssid" />
            <column name="channel" />
            <column name="created_at" />
        </createIndex>

        <createIndex indexName="idx_sigindex_created_at" tableName="signal_index_history" unique="false">
            <column name="created_at" />
        </createIndex>
    </changeSet>

    <changeSet id="3" author="lennartkoopmann">
        <createTable tableName="beacon_rate_history" >
            <column name="id" type="integer" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="bssid" type="varchar(17)">
                <constraints nullable="false" />
            </column>

            <column name="ssid" type="varchar(255)">
                <constraints nullable="false" />
            </column>

            <column name="channel" type="integer">
                <constraints nullable="false" />
            </column>

            <column name="beacon_rate" type="integer">
                <constraints nullable="true" />
            </column>

            <column name="created_at" type="timestamp">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createIndex indexName="idx_beaconrate_standard_lookup" tableName="beacon_rate_history" unique="false">
            <column name="bssid" />
            <column name="ssid" />
            <column name="channel" />
            <column name="created_at" />
        </createIndex>

        <createIndex indexName="idx_beaconrate_created_at" tableName="beacon_rate_history" unique="false">
            <column name="created_at" />
        </createIndex>
    </changeSet>

    <changeSet id="4" author="lennartkoopmann">
        <dropColumn tableName="beacon_rate_history" columnName="channel" />
    </changeSet>

    <changeSet id="5" author="lennartkoopmann">
        <dropTable tableName="signal_index_history" />
    </changeSet>

    <changeSet id="6" author="lennartkoopmann">
        <createTable tableName="sigidx_histogram_history" >
            <column name="id" type="integer" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="bssid" type="varchar(17)">
                <constraints nullable="false" />
            </column>

            <column name="ssid" type="varchar(255)">
                <constraints nullable="false" />
            </column>

            <column name="channel" type="integer">
                <constraints nullable="false" />
            </column>

            <column name="histogram" type="text">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createIndex indexName="idx_sigidxhistory_standard_lookup" tableName="sigidx_histogram_history" unique="false">
            <column name="bssid" />
            <column name="ssid" />
            <column name="channel" />
            <column name="created_at" />
        </createIndex>
    </changeSet>

    <changeSet id="7" author="lennartkoopmann">
        <createTable tableName="alerts" >
            <column name="id" type="integer" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="alert_uuid" type="uuid">
                <constraints nullable="false" unique="true" />
            </column>

            <column name="alert_type" type="varchar(255)">
                <constraints nullable="false" />
            </column>

            <column name="subsystem" type="varchar(25)">
                <constraints nullable="false" />
            </column>

            <column name="message" type="text">
                <constraints nullable="false" />
            </column>

            <column name="description" type="text">
                <constraints nullable="false" />
            </column>

            <column name="fields" type="text">
                <constraints nullable="false" />
            </column>

            <column name="first_seen" type="timestamp">
                <constraints nullable="false" />
            </column>

            <column name="last_seen" type="timestamp">
                <constraints nullable="false" />
            </column>

            <column name="frame_count" type="integer">
                <constraints nullable="false" />
            </column>

            <column name="use_frame_count" type="boolean">
                <constraints nullable="false" />
            </column>

            <column name="documentation_link" type="varchar(255)">
                <constraints nullable="false" />
            </column>

            <column name="false_positives" type="text">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createIndex indexName="alerts_standard_lookup" tableName="alerts" unique="false">
            <column name="last_seen" />
        </createIndex>
    </changeSet>

    <changeSet id="8" author="lennartkoopmann">
        <dropColumn tableName="alerts" columnName="false_positives" />
        <dropColumn tableName="alerts" columnName="documentation_link" />
        <dropColumn tableName="alerts" columnName="description" />
        <dropColumn tableName="alerts" columnName="message" />
    </changeSet>

    <changeSet id="9" author="lennartkoopmann">
        <addColumn tableName="alerts">
            <column name="channel" type="integer">
                <constraints nullable="false" />
            </column>
            <column name="frequency" type="integer">
                <constraints nullable="false" />
            </column>
            <column name="antenna_signal" type="integer">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="10" author="lennartkoopmann">
        <dropColumn tableName="alerts" columnName="channel" />
        <dropColumn tableName="alerts" columnName="antenna_signal" />
        <dropColumn tableName="alerts" columnName="frequency" />
    </changeSet>

    <changeSet id="11" author="lennartkoopmann">
        <createTable tableName="bandits">
            <column name="id" type="integer" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="bandit_uuid" type="uuid">
                <constraints nullable="false" unique="true" />
            </column>

            <column name="name" type="varchar(75)">
                <constraints nullable="false" />
            </column>

            <column name="description" type="text">
                <constraints nullable="false" />
            </column>

            <column name="identifiers" type="text">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp">
                <constraints nullable="false" />
            </column>

            <column name="updated_at" type="timestamp">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createIndex indexName="bandits_standard_lookup" tableName="bandits" unique="false">
            <column name="created_at" />
        </createIndex>

        <createIndex indexName="bandits_indiv_lookup" tableName="bandits" unique="false">
            <column name="bandit_uuid" />
        </createIndex>
    </changeSet>

    <changeSet id="12" author="lennartkoopmann">
        <dropColumn tableName="bandits" columnName="identifiers" />

        <createTable tableName="bandit_identifiers">
            <column name="id" type="integer" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="identifier_type" type="varchar(75)">
                <constraints nullable="false" />
            </column>

            <column name="bandit_id" type="integer">
                <constraints nullable="false" />
            </column>

            <column name="configuration" type="text">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp">
                <constraints nullable="false" />
            </column>

            <column name="updated_at" type="timestamp">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createIndex indexName="bandits_identifiers_linked_lookup" tableName="bandit_identifiers" unique="false">
            <column name="bandit_id" />
        </createIndex>

        <addForeignKeyConstraint    constraintName="link_bandits2identifiers"
                                    baseTableName="bandit_identifiers"
                                    baseColumnNames="bandit_id"
                                    referencedTableName="bandits"
                                    referencedColumnNames="id"
                                    onUpdate="NO ACTION"
                                    onDelete="CASCADE"
        />
    </changeSet>

    <changeSet id="13" author="lennartkoopmann">
        <createTable tableName="contacts">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="contact_uuid" type="uuid">
                <constraints nullable="false" unique="true" />
            </column>

            <column name="bandit_id" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="frame_count" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="first_seen" type="timestamp">
                <constraints nullable="false" />
            </column>

            <column name="last_seen" type="timestamp">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createIndex indexName="contacts_linked_lookup" tableName="contacts" unique="false">
            <column name="bandit_id" />
        </createIndex>

        <addForeignKeyConstraint    constraintName="link_bandits2contacts"
                                    baseTableName="contacts"
                                    baseColumnNames="bandit_id"
                                    referencedTableName="bandits"
                                    referencedColumnNames="id"
                                    onUpdate="NO ACTION"
                                    onDelete="CASCADE"
        />

    </changeSet>

    <changeSet id="14" author="lennartkoopmann">
        <modifyDataType tableName="measurements" columnName="id" newDataType="bigint" />
        <modifyDataType tableName="measurements" columnName="measurement_value" newDataType="bigint" />
        <modifyDataType tableName="beacon_rate_history" columnName="id" newDataType="bigint" />
        <modifyDataType tableName="beacon_rate_history" columnName="beacon_rate" newDataType="bigint" />
        <modifyDataType tableName="sigidx_histogram_history" columnName="id" newDataType="bigint" />
        <modifyDataType tableName="alerts" columnName="id" newDataType="bigint" />
        <modifyDataType tableName="alerts" columnName="frame_count" newDataType="bigint" />
        <modifyDataType tableName="bandits" columnName="id" newDataType="bigint" />
        <modifyDataType tableName="bandit_identifiers" columnName="id" newDataType="bigint" />
        <modifyDataType tableName="bandit_identifiers" columnName="bandit_id" newDataType="bigint" />
    </changeSet>

    <changeSet id="15" author="lennartkoopmann">
        <createIndex indexName="contacts_active_lookup" tableName="contacts" unique="false">
            <column name="bandit_id" />
            <column name="last_seen" />
        </createIndex>
    </changeSet>

    <changeSet id="16" author="lennartkoopmann">
        <addColumn tableName="bandit_identifiers">
            <column name="identifier_uuid" type="uuid">
                <constraints nullable="false" unique="true" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="17" author="lennartkoopmann">
        <addColumn tableName="bandits">
            <column name="read_only" type="boolean" defaultValue="false">
                <constraints nullable="false" unique="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="18" author="lennartkoopmann">
        <addColumn tableName="contacts">
            <column name="source_role" type="varchar(75)" defaultValue="LEADER" >
                <constraints nullable="false" unique="false" />
            </column>
        </addColumn>

        <addColumn tableName="contacts">
            <column name="source_name" type="varchar(255)" defaultValue="unknown/migrated">
                <constraints nullable="false" unique="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="19" author="lennartkoopmann">
        <addColumn tableName="contacts">
            <column name="last_signal" type="bigint" defaultValue="0">
                <constraints nullable="false" unique="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="20" author="lennartkoopmann">
        <createTable tableName="sentry_ssids" >
            <column name="id" type="integer" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="ssid" type="varchar(255)">
                <constraints nullable="false" />
            </column>

            <column name="first_seen" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="last_seen" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createIndex indexName="idx_sentry_ssids_standard_lookup" tableName="sentry_ssids" unique="false">
            <column name="ssid" />
        </createIndex>

        <createIndex indexName="idx_sentry_ssids_list_lookup" tableName="sentry_ssids" unique="false">
            <column name="last_seen" />
        </createIndex>
    </changeSet>

    <changeSet id="21" author="lennartkoopmann">
        <createTable tableName="deauth_monitor" >
            <column name="id" type="integer" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="total_frame_count" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createIndex indexName="idx_deauth_frame_count_standard_lookup" tableName="deauth_monitor" unique="false">
            <column name="created_at" />
        </createIndex>
    </changeSet>

    <changeSet id="22" author="lennartkoopmann">
        <sqlFile path="db/quartz.sql" />
    </changeSet>

    <changeSet id="23" author="lennartkoopmann">
        <createTable tableName="events" >
            <column name="id" type="integer" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="type" type="varchar(255)">
                <constraints nullable="false" />
            </column>

            <column name="name" type="varchar(255)">
                <constraints nullable="false" />
            </column>

            <column name="description" type="text">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createIndex indexName="idx_events_standard_lookup" tableName="events" unique="false">
            <column name="created_at" />
        </createIndex>
    </changeSet>

    <changeSet id="24" author="lennartkoopmann">
        <createTable tableName="report_receivers_email" >
            <column name="id" type="integer" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="report_name" type="varchar(255)">
                <constraints nullable="false" />
            </column>

            <column name="address" type="varchar(255)">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createIndex indexName="idx_report_emails_standard_lookup" tableName="report_receivers_email" unique="false">
            <column name="report_name" />
        </createIndex>
    </changeSet>

    <changeSet id="25" author="lennartkoopmann">
        <createTable tableName="report_metadata" >
            <column name="id" type="integer" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="report_name" type="varchar(255)">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createIndex indexName="idx_report_meta_standard_lookup" tableName="report_metadata" unique="false">
            <column name="report_name" />
        </createIndex>
    </changeSet>

    <changeSet id="26" author="lennartkoopmann">
        <createTable tableName="report_execution_log" >
            <column name="id" type="integer" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="report_name" type="varchar(255)">
                <constraints nullable="false" />
            </column>

            <column name="result" type="varchar(25)">
                <constraints nullable="false" />
            </column>

            <column name="message" type="text">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createIndex indexName="idx_report_log_standard_lookup" tableName="report_execution_log" unique="false">
            <column name="report_name" />
            <column name="created_at" />
        </createIndex>
    </changeSet>

    <changeSet id="27" author="lennartkoopmann">
        <createTable tableName="reports" >
            <column name="id" type="integer" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="report_name" type="varchar(255)">
                <constraints nullable="false" />
            </column>

            <column name="report" type="text">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createIndex indexName="idx_reports_standard_lookup" tableName="reports" unique="false">
            <column name="report_name" />
            <column name="created_at" />
        </createIndex>
    </changeSet>

    <changeSet id="28" author="lennartkoopmann">
        <dropTable tableName="reports" />

        <addColumn tableName="report_execution_log">
            <column name="content" type="text">
                <constraints nullable="true" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="29" author="lennartkoopmann">
        <createTable tableName="contacts_ssids" >
            <column name="id" type="integer" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="contact_uuid" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="ssid" type="text">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createIndex indexName="idx_contacts_ssids_standard_lookup" tableName="contacts_ssids" unique="false">
            <column name="contact_uuid" />
        </createIndex>

        <createIndex indexName="idx_contacts_ssids_upsert_lookup" tableName="contacts_ssids" unique="false">
            <column name="contact_uuid" />
            <column name="ssid" />
        </createIndex>

        <addForeignKeyConstraint    constraintName="link_contacts2ssids"
                                    baseTableName="contacts_ssids"
                                    baseColumnNames="contact_uuid"
                                    referencedTableName="contacts"
                                    referencedColumnNames="contact_uuid"
                                    onUpdate="NO ACTION"
                                    onDelete="CASCADE" />
    </changeSet>

    <changeSet id="30" author="lennartkoopmann">
        <createTable tableName="contact_records" >
            <column name="id" type="integer" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="contact_uuid" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="record_type" type="varchar(25)">
                <constraints nullable="false" />
            </column>

            <column name="record_value" type="varchar(255)">
                <constraints nullable="false" />
            </column>

            <column name="rssi_average" type="double">
                <constraints nullable="false" />
            </column>

            <column name="rssi_stddev" type="double">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

        </createTable>

        <createIndex indexName="idx_contact_records_standard_lookup" tableName="contact_records" unique="false">
            <column name="contact_uuid" />
            <column name="record_type" />
        </createIndex>

        <addForeignKeyConstraint    constraintName="link_contacts2records"
                                    baseTableName="contact_records"
                                    baseColumnNames="contact_uuid"
                                    referencedTableName="contacts"
                                    referencedColumnNames="contact_uuid"
                                    onUpdate="NO ACTION"
                                    onDelete="CASCADE" />
    </changeSet>

    <changeSet id="31" author="lennartkoopmann">
        <dropTable tableName="contacts_ssids" />
    </changeSet>

    <changeSet id="32" author="lennartkoopmann">
        <addColumn tableName="contact_records">
            <column name="frame_count" type="bigint" defaultValue="0">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="33" author="lennartkoopmann">
        <createTable tableName="taps" >
            <column name="id" type="integer" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="name" type="varchar(50)">
                <constraints nullable="false" />
            </column>

            <column name="local_time" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="processed_bytes_total" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="processed_bytes_10" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="memory_total" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="memory_free" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="memory_used" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="cpu_load" type="double">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="updated_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createIndex indexName="idx_taps_standard_lookup" tableName="taps" unique="false">
            <column name="name" />
        </createIndex>

        <createIndex indexName="idx_taps_active_lookup" tableName="taps" unique="false">
            <column name="name" />
            <column name="updated_at" />
        </createIndex>
    </changeSet>

    <changeSet id="34" author="lennartkoopmann">
        <createTable tableName="base_configuration" >
            <column name="id" type="integer" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="tap_secret" type="varchar(64)">
                <constraints nullable="false" />
            </column>

            <column name="updated_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>
    </changeSet>

    <changeSet id="35" author="lennartkoopmann">
        <addColumn tableName="taps">
            <column name="description" type="text" />
        </addColumn>
    </changeSet>

    <changeSet id="36" author="lennartkoopmann">
        <renameColumn tableName="taps" oldColumnName="processed_bytes_10" newColumnName="processed_bytes_average" />
    </changeSet>

    <changeSet id="37" author="lennartkoopmann">
        <createTable tableName="tap_buses">
            <column name="id" type="integer" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="tap_name" type="varchar(50)">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="updated_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>

        <addUniqueConstraint tableName="taps" columnNames="name" />

        <addForeignKeyConstraint    constraintName="link_taps2buses"
                                    baseTableName="tap_buses"
                                    baseColumnNames="tap_name"
                                    referencedTableName="taps"
                                    referencedColumnNames="name"
                                    onUpdate="NO ACTION"
                                    onDelete="CASCADE" />
    </changeSet>

    <changeSet id="38" author="lennartkoopmann">
        <createTable tableName="bus_channels">
            <column name="id" type="integer" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="bus_id" type="integer">
                <constraints nullable="false" />
            </column>

            <column name="name" type="varchar(255)">
                <constraints nullable="false" />
            </column>

            <column name="capacity" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="watermark" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="errors_total" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="errors_average" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="throughput_bytes_total" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="throughput_bytes_average" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="throughput_messages_total" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="throughput_messages_average" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="updated_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>

        <addForeignKeyConstraint    constraintName="link_buses2channels"
                                    baseTableName="bus_channels"
                                    baseColumnNames="bus_id"
                                    referencedTableName="tap_buses"
                                    referencedColumnNames="id"
                                    onUpdate="NO ACTION"
                                    onDelete="CASCADE" />
    </changeSet>

    <changeSet id="39" author="lennartkoopmann">
        <addColumn tableName="tap_buses">
            <column name="name" type="varchar(255)" defaultValue="unknown">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="40" author="lennartkoopmann">
        <createTable tableName="tap_captures">
            <column name="id" type="integer" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="tap_name" type="varchar(50)">
                <constraints nullable="false" />
            </column>

            <column name="interface" type="varchar(255)">
                <constraints nullable="false" />
            </column>

            <column name="capture_type" type="varchar(50)">
                <constraints nullable="false" />
            </column>

            <column name="is_running" type="boolean">
                <constraints nullable="false" />
            </column>

            <column name="received" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="dropped_buffer" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="dropped_interface" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="updated_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>
    </changeSet>

    <changeSet id="41" author="lennartkoopmann">
        <createTable tableName="dns_statistics">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="tap_name" type="varchar(50)">
                <constraints nullable="false" />
            </column>

            <column name="ip" type="varchar(39)">
                <constraints nullable="false" />
            </column>

            <column name="request_count" type="integer">
                <constraints nullable="false" />
            </column>

            <column name="request_bytes" type="integer">
                <constraints nullable="false" />
            </column>

            <column name="response_count" type="integer">
                <constraints nullable="false" />
            </column>

            <column name="response_bytes" type="integer">
                <constraints nullable="false" />
            </column>

            <column name="nxdomain_count" type="integer">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>
    </changeSet>

    <changeSet id="42" author="lennartkoopmann">
        <createTable tableName="dns_nxdomains_log">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="tap_name" type="varchar(50)">
                <constraints nullable="false" />
            </column>

            <column name="ip" type="varchar(39)">
                <constraints nullable="false" />
            </column>

            <column name="server" type="varchar(39)">
                <constraints nullable="false" />
            </column>

            <column name="query_value" type="varchar(255)">
                <constraints nullable="false" />
            </column>

            <column name="data_type" type="varchar(55)">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>
    </changeSet>

    <changeSet id="43" author="lennartkoopmann">
        <createTable tableName="metrics_gauges">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="metric_name" type="varchar(128)">
                <constraints nullable="false" />
            </column>

            <column name="tap_name" type="varchar(50)">
                <constraints nullable="false" />
            </column>

            <column name="metric_value" type="double">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>
    </changeSet>

    <changeSet id="44" author="lennartkoopmann">
        <createIndex indexName="idx_metrics_std_lookup" tableName="metrics_gauges" unique="false">
            <column name="metric_name"/>
            <column name="tap_name"/>
            <column name="created_at"/>
        </createIndex>
    </changeSet>

    <changeSet id="45" author="lennartkoopmann">
        <createTable tableName="dns_pairs">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="ip" type="varchar(39)">
                <constraints nullable="false" />
            </column>

            <column name="server" type="varchar(39)">
                <constraints nullable="false" />
            </column>

            <column name="count" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>
    </changeSet>

    <changeSet id="46" author="lennartkoopmann">
        <addColumn tableName="dns_pairs">
            <column name="tap_name" type="varchar(50)">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="47" author="lennartkoopmann">
        <createIndex indexName="idx_dns_pairs_std_lookup" tableName="metrics_gauges" unique="false">
            <column name="tap_name"/>
            <column name="created_at"/>
        </createIndex>
    </changeSet>

    <changeSet id="48" author="lennartkoopmann">
        <createTable tableName="registry">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="key" type="varchar(128)">
                <constraints nullable="false" />
            </column>

            <column name="value" type="varchar(255)">
                <constraints nullable="false" />
            </column>
        </createTable>
    </changeSet>

    <changeSet id="49" author="lennartkoopmann">
        <createTable tableName="crypto_keys">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="node" type="varchar(255)">
                <constraints nullable="false" />
            </column>

            <column name="key_type" type="varchar(25)">
                <constraints nullable="false" />
            </column>

            <column name="key_signature" type="varchar(255)">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>
    </changeSet>

    <changeSet id="50" author="lennartkoopmann">
        <createTable tableName="registry_encrypted">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="key" type="varchar(128)">
                <constraints nullable="false" />
            </column>

            <column name="value" type="text">
                <constraints nullable="false" />
            </column>

            <column name="key_signature" type="varchar(255)">
                <constraints nullable="false" />
            </column>
        </createTable>
    </changeSet>

    <changeSet id="51" author="lennartkoopmann">
        <createTable tableName="nodes">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="uuid" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="name" type="varchar(255)">
                <constraints nullable="false" />
            </column>

            <column name="transport_address" type="varchar(255)">
                <constraints nullable="false" />
            </column>

            <column name="last_seen" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createIndex tableName="nodes" indexName="idx_node_uuid" unique="true">
            <column name="uuid" />
        </createIndex>
    </changeSet>

    <changeSet id="52" author="lennartkoopmann">
        <addColumn tableName="nodes">
            <column name="version" type="varchar(50)" defaultValue="0.0.0">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="53" author="lennartkoopmann">
        <addColumn tableName="nodes">
            <column name="memory_bytes_total" type="bigint" defaultValue="0">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="nodes">
            <column name="memory_bytes_available" type="bigint" defaultValue="0">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="nodes">
            <column name="memory_bytes_used" type="bigint" defaultValue="0">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="nodes">
            <column name="cpu_system_load" type="double" defaultValue="0.0">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="nodes">
            <column name="cpu_thread_count" type="int" defaultValue="0">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="nodes">
            <column name="process_start_time" type="timestamp with time zone" defaultValue="1970-01-01 00:00:00 America/Chicago">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="nodes">
            <column name="process_virtual_size" type="bigint" defaultValue="0">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="nodes">
            <column name="process_arguments" type="text" defaultValue="">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="nodes">
            <column name="os_information" type="varchar(255)" defaultValue="">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="54" author="lennartkoopmann">
        <addColumn tableName="nodes">
            <column name="heap_bytes_total" type="bigint" defaultValue="0">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="nodes">
            <column name="heap_bytes_available" type="bigint" defaultValue="0">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="nodes">
            <column name="heap_bytes_used" type="bigint" defaultValue="0">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="55" author="lennartkoopmann">
        <renameColumn tableName="nodes" oldColumnName="transport_address" newColumnName="http_external_uri" />
    </changeSet>

    <changeSet id="56" author="lennartkoopmann">
        <dropTable tableName="measurements" />
    </changeSet>

    <changeSet id="57" author="lennartkoopmann">
        <renameTable oldTableName="metrics_gauges" newTableName="tap_metrics_gauges" />
    </changeSet>

    <!-- Switching from numbers to text for migration IDs to avoid merge problems. -->

    <changeSet id="create_node_metrics" author="lennartkoopmann">
        <createTable tableName="node_metrics_gauges">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="node_id" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="metric_name" type="varchar(128)">
                <constraints nullable="false" />
            </column>

            <column name="metric_value" type="double">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createIndex indexName="idx_nodemetrics_std_lookup" tableName="node_metrics_gauges" unique="false">
            <column name="metric_name"/>
            <column name="node_id"/>
            <column name="created_at"/>
        </createIndex>
    </changeSet>

    <changeSet id="drop_events" author="lennartkoopmann">
        <dropTable tableName="events" />
    </changeSet>

    <changeSet id="create_node_metrics_timers" author="lennartkoopmann">
        <createTable tableName="node_metrics_timers">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="node_id" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="metric_name" type="varchar(128)">
                <constraints nullable="false" />
            </column>

            <column name="metric_max" type="double">
                <constraints nullable="false" />
            </column>

            <column name="metric_min" type="double">
                <constraints nullable="false" />
            </column>

            <column name="metric_mean" type="double">
                <constraints nullable="false" />
            </column>

            <column name="metric_p99" type="double">
                <constraints nullable="false" />
            </column>

            <column name="metric_stddev" type="double">
                <constraints nullable="false" />
            </column>

            <column name="metric_counter" type="double">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createIndex indexName="idx_nodemetricstimers_std_lookup" tableName="node_metrics_timers" unique="false">
            <column name="metric_name"/>
            <column name="node_id"/>
            <column name="created_at"/>
        </createIndex>
    </changeSet>

    <changeSet id="change_node_metrics_timers_1" author="lennartkoopmann">
        <modifyDataType tableName="node_metrics_timers" columnName="metric_max" newDataType="bigint" />
        <modifyDataType tableName="node_metrics_timers" columnName="metric_min" newDataType="bigint" />
        <modifyDataType tableName="node_metrics_timers" columnName="metric_mean" newDataType="bigint" />
        <modifyDataType tableName="node_metrics_timers" columnName="metric_p99" newDataType="bigint" />
        <modifyDataType tableName="node_metrics_timers" columnName="metric_stddev" newDataType="bigint" />
        <modifyDataType tableName="node_metrics_timers" columnName="metric_counter" newDataType="bigint" />
    </changeSet>

    <changeSet id="add_clock_to_nodes" author="lennartkoopmann">
        <addColumn tableName="nodes">
            <column name="clock" type="timestamp with time zone" defaultValue="1970-01-01 00:00:00 America/Chicago">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="create_health_indicators" author="lennartkoopmann">
        <createTable tableName="health_indicators">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="indicator_id" type="varchar(50)">
                <constraints nullable="false" />
            </column>

            <column name="indicator_name" type="varchar(128)">
                <constraints nullable="false" />
            </column>

            <column name="level" type="varchar(25)">
                <constraints nullable="false" />
            </column>

            <column name="last_checked" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>
    </changeSet>

    <changeSet id="make_health_indicators_id_unique" author="lennartkoopmann">
        <createIndex tableName="health_indicators" indexName="idx_healthindicators_indicatorid" unique="true">
            <column name="indicator_id" />
        </createIndex>
    </changeSet>

    <changeSet id="rename_tap_clock_column" author="lennartkoopmann">
        <renameColumn tableName="taps" oldColumnName="local_time" newColumnName="clock" />
    </changeSet>
    
    <changeSet id="add_node_id_to_crypto_keys_and_rename_node_name" author="lennartkoopmann">
        <renameColumn tableName="crypto_keys" oldColumnName="node" newColumnName="node_name" />

        <addColumn tableName="crypto_keys">
            <column name="node_id" type="uuid" defaultValueComputed="gen_random_uuid()">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_deleted_field_to_nodes_and_taps" author="lennartkoopmann">
        <addColumn tableName="nodes">
            <column name="deleted" type="boolean" defaultValue="false">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="taps">
            <column name="deleted" type="boolean" defaultValue="false">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_deactivation_to_health_indicators" author="lennartkoopmann">
        <addColumn tableName="health_indicators">
            <column name="active" type="boolean" defaultValue="true">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_tls_cert_table" author="lennartkoopmann">
        <createTable tableName="crypto_tls_certificates">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="node_id" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="certificate" type="text">
                <constraints nullable="false" />
            </column>

            <column name="key" type="text">
                <constraints nullable="false" />
            </column>

            <column name="valid_from" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="expires_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>
    </changeSet>

    <changeSet id="add_listen_uri_to_nodes" author="lennartkoopmann">
        <addColumn tableName="nodes">
            <column name="http_listen_uri" type="varchar(255)" defaultValue="https://0.0.0.0:22900">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_source_type_to_tls_certs" author="lennartkoopmann">
        <addColumn tableName="crypto_tls_certificates">
            <column name="source_type" type="varchar(50)" defaultValue="TEST">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_tls_wildcard_cert_table" author="lennartkoopmann">
        <createTable tableName="crypto_tls_certificates_wildcard">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="node_matcher" type="varchar(255)">
                <constraints nullable="false" />
            </column>

            <column name="certificate" type="text">
                <constraints nullable="false" />
            </column>

            <column name="key" type="text">
                <constraints nullable="false" />
            </column>

            <column name="valid_from" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="expires_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="source_type" type="varchar(50)" defaultValue="TEST">
                <constraints nullable="false" />
            </column>
        </createTable>
    </changeSet>

    <changeSet id="add_message_bus_messages_table" author="lennartkoopmann">
        <createTable tableName="message_bus_messages">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="sender_node_id" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="receiver_node_id" type="uuid" />

            <column name="type" type="varchar(128)">
                <constraints nullable="false" />
            </column>

            <column name="parameters" type="text" />

            <column name="status" type="varchar(64)">
                <constraints nullable="false" />
            </column>

            <column name="cycle_limiter" type="bigint" />

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="acknowledged_at" type="timestamp with time zone" />
        </createTable>
    </changeSet>

    <changeSet id="add_node_cylces" author="lennartkoopmann">
        <addColumn tableName="nodes">
            <column name="cycle" type="bigint" defaultValue="1">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_lookup_index_to_messagebus" author="lennartkoopmann">
        <createIndex indexName="idx_msgbus_std_lookup" tableName="message_bus_messages" unique="false">
            <column name="receiver_node_id" />
            <column name="status" />
            <column name="cycle_limiter" />
        </createIndex>

        <createIndex indexName="idx_msgbus_nack_lookup" tableName="message_bus_messages" unique="false">
            <column name="status" />
        </createIndex>
    </changeSet>

    <changeSet id="add_tasks_queue_table" author="lennartkoopmann">
        <createTable tableName="tasks_queue">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="sender_node_id" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="type" type="varchar(128)">
                <constraints nullable="false" />
            </column>

            <column name="max_attempts" type="int" defaultValue="0">
                <constraints nullable="false" />
            </column>

            <column name="allow_retry" type="boolean" >
                <constraints nullable="false" />
            </column>

            <column name="parameters" type="text" />

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="status" type="varchar(64)">
                <constraints nullable="false" />
            </column>

            <column name="attempts" type="int" defaultValue="0">
                <constraints nullable="false" />
            </column>

            <column name="processing_time_ms" type="int" defaultValue="0">
                <constraints nullable="false" />
            </column>

            <column name="first_processed_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="last_processed_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createIndex indexName="idx_tskque_status_lookup" tableName="tasks_queue" unique="false">
            <column name="status" />
        </createIndex>
    </changeSet>

    <changeSet id="add_process_self_info_to_tasks_queue" author="lennartkoopmann">
        <addColumn tableName="tasks_queue">
            <column name="allow_process_self" type="boolean">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="remove_unnecessary_columns_in_tasks" author="lennartkoopmann">
        <dropColumn tableName="tasks_queue" columnName="max_attempts" />
        <renameColumn tableName="tasks_queue" oldColumnName="attempts" newColumnName="retries" />

        <dropNotNullConstraint tableName="tasks_queue" columnName="first_processed_at" />
        <dropNotNullConstraint tableName="tasks_queue" columnName="last_processed_at" />
    </changeSet>

    <changeSet id="add_previous_status_to_tasks_queue" author="lennartkoopmann">
        <addColumn tableName="tasks_queue">
            <column name="previous_status" type="varchar(64)" defaultValue="NEW">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_public_key_to_nodes" author="lennartkoopmann">
        <addColumn tableName="nodes">
            <column name="public_key" type="text" defaultValue="">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_last_acked_to_tasks_queue" author="lennartkoopmann">
        <addColumn tableName="tasks_queue">
            <column name="last_acked_at" type="timestamp with time zone" />
        </addColumn>
    </changeSet>

    <changeSet id="add_processed_by_to_tasks_queue" author="lennartkoopmann">
        <addColumn tableName="tasks_queue">
            <column name="processed_by" type="uuid" />
        </addColumn>
    </changeSet>

    <changeSet id="add_acked_by_to_tasks_queue" author="lennartkoopmann">
        <addColumn tableName="tasks_queue">
            <column name="acked_by" type="uuid" />
        </addColumn>
    </changeSet>

    <changeSet id="add_acked_by_to_message_bus" author="lennartkoopmann">
        <addColumn tableName="message_bus_messages">
            <column name="acknowledged_by" type="uuid" />
        </addColumn>
    </changeSet>

    <changeSet id="add_processing_time_to_message_bus" author="lennartkoopmann">
        <addColumn tableName="message_bus_messages">
            <column name="processing_time_ms" type="int" />
        </addColumn>
    </changeSet>

    <changeSet id="add_version_to_taps" author="lennartkoopmann">
        <addColumn tableName="taps">
            <column name="version" type="varchar(64)" />
        </addColumn>
    </changeSet>

    <changeSet id="add_organizations" author="lennartkoopmann">
        <createTable tableName="auth_organizations">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="name" type="varchar(256)">
                <constraints unique="true" nullable="false" />
            </column>

            <column name="description" type="text">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="updated_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>
    </changeSet>

    <changeSet id="add_tenants" author="lennartkoopmann">
        <createTable tableName="auth_tenants">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="organization_id" type="bigint">
                <constraints unique="true" nullable="false" />
            </column>

            <column name="name" type="varchar(256)">
                <constraints unique="true" nullable="false" />
            </column>

            <column name="description" type="text">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="updated_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>

        <addForeignKeyConstraint    constraintName="link_tenants2orgs"
                                    baseTableName="auth_tenants"
                                    baseColumnNames="organization_id"
                                    referencedTableName="auth_organizations"
                                    referencedColumnNames="id"
                                    onUpdate="NO ACTION"
                                    onDelete="CASCADE"
        />
    </changeSet>

    <changeSet id="fix_tenants2orgs_key_constraint" author="lennartkoopmann">
        <dropForeignKeyConstraint baseTableName="auth_tenants" constraintName="link_tenants2orgs" />
        <addForeignKeyConstraint    constraintName="link_tenants2orgs"
                                    baseTableName="auth_tenants"
                                    baseColumnNames="organization_id"
                                    referencedTableName="auth_organizations"
                                    referencedColumnNames="id"
                                    onUpdate="NO ACTION"
                                    onDelete="RESTRICT"
        />
    </changeSet>

    <changeSet id="fix_wrong_auth_constraints" author="lennartkoopmann">
        <dropUniqueConstraint tableName="auth_organizations" constraintName="auth_organizations_name_key" />
        <dropUniqueConstraint tableName="auth_tenants" constraintName="auth_tenants_name_key" />
        <dropUniqueConstraint tableName="auth_tenants" constraintName="auth_tenants_organization_id_key" />
    </changeSet>

    <changeSet id="add_roles" author="lennartkoopmann">
        <createTable tableName="auth_roles">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="tenant_id" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="description" type="text">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="updated_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>

        <addForeignKeyConstraint    constraintName="link_roles2tenants"
                                    baseTableName="auth_roles"
                                    baseColumnNames="tenant_id"
                                    referencedTableName="auth_tenants"
                                    referencedColumnNames="id"
                                    onUpdate="NO ACTION"
                                    onDelete="RESTRICT"
        />
    </changeSet>

    <changeSet id="add_users" author="lennartkoopmann">
        <createTable tableName="auth_users">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="tenant_id" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="role_id" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="email" type="varchar(128)">
                <constraints nullable="false" />
            </column>

            <column name="password" type="text">
                <constraints nullable="false" />
            </column>

            <column name="name" type="varchar(128)">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="updated_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>

        <addForeignKeyConstraint    constraintName="link_users2tenants"
                                    baseTableName="auth_users"
                                    baseColumnNames="tenant_id"
                                    referencedTableName="auth_tenants"
                                    referencedColumnNames="id"
                                    onUpdate="NO ACTION"
                                    onDelete="RESTRICT"
        />

        <addForeignKeyConstraint    constraintName="link_users2roles"
                                    baseTableName="auth_users"
                                    baseColumnNames="role_id"
                                    referencedTableName="auth_roles"
                                    referencedColumnNames="id"
                                    onUpdate="NO ACTION"
                                    onDelete="RESTRICT"
        />
    </changeSet>

    <changeSet id="change_roles_level" author="lennartkoopmann">
        <dropForeignKeyConstraint baseTableName="auth_roles" constraintName="link_roles2tenants" />
        <dropColumn tableName="auth_roles" columnName="tenant_id" />

        <addColumn tableName="auth_roles">
            <column name="organization_id" type="bigint">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="auth_users">
            <column name="is_superadmin" type="boolean" defaultValue="false">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addForeignKeyConstraint    constraintName="link_roles2orgs"
                                    baseTableName="auth_roles"
                                    baseColumnNames="organization_id"
                                    referencedTableName="auth_organizations"
                                    referencedColumnNames="id"
                                    onUpdate="NO ACTION"
                                    onDelete="RESTRICT"
        />
    </changeSet>

    <changeSet id="extend_users" author="lennartkoopmann">
        <addColumn tableName="auth_users">
            <column name="is_orgadmin" type="boolean">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="auth_users">
            <column name="organization_id" type="bigint">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="auth_users">
            <column name="password_salt" type="text">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <dropNotNullConstraint tableName="auth_users" columnName="role_id" />
    </changeSet>

    <changeSet id="extend_taps" author="lennartkoopmann">
        <addColumn tableName="taps">
            <column name="secret" type="varchar(64)">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="taps">
            <column name="organization_id" type="bigint">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="taps">
            <column name="tenant_id" type="bigint">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="taps">
            <column name="last_report" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="fix_taps_notnull_for_new_model" author="lennartkoopmann">
        <dropNotNullConstraint tableName="taps" columnName="clock" />
        <dropNotNullConstraint tableName="taps" columnName="processed_bytes_total" />
        <dropNotNullConstraint tableName="taps" columnName="processed_bytes_average" />
        <dropNotNullConstraint tableName="taps" columnName="memory_total" />
        <dropNotNullConstraint tableName="taps" columnName="memory_free" />
        <dropNotNullConstraint tableName="taps" columnName="memory_used" />
        <dropNotNullConstraint tableName="taps" columnName="cpu_load" />
        <dropNotNullConstraint tableName="taps" columnName="last_report" />

        <addNotNullConstraint tableName="taps" columnName="description" />
    </changeSet>

    <changeSet id="move_tap_refs_from_name_to_uuid" author="lennartkoopmann">
        <addColumn tableName="taps">
            <column name="uuid" type="uuid">
                <constraints nullable="false" unique="true" />
            </column>
        </addColumn>

        <dropColumn tableName="tap_metrics_gauges" columnName="tap_name" />
        <addColumn tableName="tap_metrics_gauges">
            <column name="tap_uuid" type="uuid">
                <constraints nullable="false" unique="true" />
            </column>
        </addColumn>

        <dropColumn tableName="tap_captures" columnName="tap_name" />
        <addColumn tableName="tap_captures">
            <column name="tap_uuid" type="uuid">
                <constraints nullable="false" unique="true" />
            </column>
        </addColumn>
        <addForeignKeyConstraint    constraintName="link_taps2captures"
                                    baseTableName="tap_captures"
                                    baseColumnNames="tap_uuid"
                                    referencedTableName="taps"
                                    referencedColumnNames="uuid"
                                    onUpdate="NO ACTION"
                                    onDelete="CASCADE" />

        <addColumn tableName="tap_buses">
            <column name="tap_uuid" type="uuid">
                <constraints nullable="false" unique="true" />
            </column>
        </addColumn>
        <dropForeignKeyConstraint baseTableName="tap_buses" constraintName="link_taps2buses" />
        <addForeignKeyConstraint    constraintName="link_taps2buses"
                                    baseTableName="tap_buses"
                                    baseColumnNames="tap_uuid"
                                    referencedTableName="taps"
                                    referencedColumnNames="uuid"
                                    onUpdate="NO ACTION"
                                    onDelete="CASCADE" />
        <dropColumn tableName="tap_buses" columnName="tap_name" />
    </changeSet>

    <changeSet id="make_tap_secret_unique" author="lennartkoopmann">
        <addUniqueConstraint tableName="taps" columnNames="secret" />
    </changeSet>

    <changeSet id="remove_tap_name_unique_constraint" author="lennartkoopmann">
        <dropUniqueConstraint tableName="taps" constraintName="taps_name_key" />
    </changeSet>

    <changeSet id="change_dns_table_tap_name_to_id" author="lennartkoopmann">
        <dropColumn tableName="dns_nxdomains_log" columnName="tap_name" />
        <dropColumn tableName="dns_pairs" columnName="tap_name" />
        <dropColumn tableName="dns_statistics" columnName="tap_name" />

        <addColumn tableName="dns_nxdomains_log">
            <column name="tap_uuid" type="uuid">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="dns_pairs">
            <column name="tap_uuid" type="uuid">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="dns_statistics">
            <column name="tap_uuid" type="uuid">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="fix_tap_uuid_uniqueness_after_name_change" author="lennartkoopmann">
        <dropUniqueConstraint tableName="tap_metrics_gauges" constraintName="tap_metrics_gauges_tap_uuid_key" />
        <dropUniqueConstraint tableName="tap_captures" constraintName="tap_captures_tap_uuid_key" />
        <dropUniqueConstraint tableName="tap_buses" constraintName="tap_buses_tap_uuid_key" />
    </changeSet>

    <changeSet id="increase_tap_secret_size_for_encryption" author="lennartkoopmann">
        <dropColumn tableName="taps" columnName="secret" />

        <addColumn tableName="taps">
            <column name="secret" type="text">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="create_sessions_table" author="lennartkoopmann">
        <createTable tableName="auth_sessions">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="sessionid" type="text">
                <constraints nullable="false" unique="true" />
            </column>

            <column name="user_id" type="bigint">
                <constraints nullable="false" unique="true" />
            </column>

            <column name="remote_ip" type="varchar(45)">
                <constraints nullable="false" unique="true" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="last_activity" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>

        <addForeignKeyConstraint    constraintName="link_users2sessions"
                                    baseTableName="auth_sessions"
                                    baseColumnNames="user_id"
                                    referencedTableName="auth_users"
                                    referencedColumnNames="id"
                                    onUpdate="NO ACTION"
                                    onDelete="CASCADE" />
    </changeSet>

    <changeSet id="make_user_email_unique" author="lennartkoopmann">
        <addUniqueConstraint tableName="auth_users" columnNames="email" />
    </changeSet>

    <changeSet id="move_last_activity_from_session_to_user" author="lennartkoopmann">
        <dropColumn tableName="auth_sessions" columnName="last_activity" />

        <addColumn tableName="auth_users">
            <column name="last_activity" type="timestamp with time zone" defaultValueComputed="NOW()">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="prepare_users_table_for_admins_outside_org_tenant" author="lennartkoopmann">
        <dropNotNullConstraint tableName="auth_users" columnName="organization_id" />
        <dropNotNullConstraint tableName="auth_users" columnName="tenant_id" />
    </changeSet>

    <changeSet id="remove_uniqueness_of_session_remote_ip" author="lennartkoopmann">
        <dropUniqueConstraint tableName="auth_sessions" constraintName="auth_sessions_remote_ip_key" />
    </changeSet>

    <changeSet id="add_mfa_and_elevation_to_sessions" author="lennartkoopmann">
        <addColumn tableName="auth_sessions">
            <column name="elevated" type="boolean" defaultValue="false">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="auth_sessions">
            <column name="elevated_since" type="timestamp with time zone">
                <constraints nullable="true" />
            </column>
        </addColumn>

        <addColumn tableName="auth_sessions">
            <column name="mfa_valid" type="boolean" defaultValue="false">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_mfa_totp_secret_to_users" author="lennartkoopmann">
        <addColumn tableName="auth_users">
            <column name="totp_secret" type="text">
                <constraints nullable="true" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_more_mfa_fields_to_users" author="lennartkoopmann">
        <addColumn tableName="auth_users">
            <column name="mfa_complete" type="boolean" defaultValue="false">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="auth_users">
            <column name="mfa_recovery_codes" type="text">
                <constraints nullable="true" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_mfa_requested_at" author="lennartkoopmann">
        <addColumn tableName="auth_sessions">
            <column name="mfa_requested_at" type="timestamp with time zone" defaultValue="NULL">
                <constraints nullable="true" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="fix_user_last_activity_default_value" author="lennartkoopmann">
        <dropNotNullConstraint tableName="auth_users" columnName="last_activity" />
        <dropDefaultValue tableName="auth_users" columnName="last_activity" />
    </changeSet>

    <changeSet id="add_geo_fields_to_users" author="lennartkoopmann">
        <addColumn tableName="auth_users">
            <column name="last_remote_ip" type="varchar(45)">
                <constraints nullable="true" />
            </column>
        </addColumn>

        <addColumn tableName="auth_users">
            <column name="last_geo_country" type="varchar(5)">
                <constraints nullable="true" />
            </column>
        </addColumn>

        <addColumn tableName="auth_users">
            <column name="last_geo_city" type="varchar(128)">
                <constraints nullable="true" />
            </column>
        </addColumn>

        <addColumn tableName="auth_users">
            <column name="last_geo_asn" type="varchar(255)">
                <constraints nullable="true" />
            </column>
        </addColumn>
    </changeSet>
    
    <changeSet id="create_permissions_table" author="lennartkoopmann">
        <createTable tableName="auth_permissions">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="user_id" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="permission" type="varchar(128)">
                <constraints nullable="false" />
            </column>
        </createTable>

        <addForeignKeyConstraint    constraintName="link_users2permissions"
                                    baseTableName="auth_permissions"
                                    baseColumnNames="user_id"
                                    referencedTableName="auth_users"
                                    referencedColumnNames="id"
                                    onUpdate="NO ACTION"
                                    onDelete="CASCADE" />
    </changeSet>

    <changeSet id="create_users_taps_permissions_table" author="lennartkoopmann">
        <createTable tableName="auth_users_taps">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="user_id" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="tap_id" type="bigint">
                <constraints nullable="false" />
            </column>
        </createTable>

        <addForeignKeyConstraint    constraintName="link_users2tapperms"
                                    baseTableName="auth_users_taps"
                                    baseColumnNames="user_id"
                                    referencedTableName="auth_users"
                                    referencedColumnNames="id"
                                    onUpdate="NO ACTION"
                                    onDelete="CASCADE" />
    </changeSet>

    <changeSet id="add_access_to_all_taps_field_for_users" author="lennartkoopmann">
        <addColumn tableName="auth_users">
            <column name="access_all_tenant_taps" type="boolean" defaultValue="true">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="change_user_taps_uuid_type" author="lennartkoopmann">
        <dropColumn tableName="auth_users_taps" columnName="tap_id" />

        <addColumn tableName="auth_users_taps">
            <column name="tap_id" type="uuid">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_uuids_to_all_auth_tables" author="lennartkoopmann">
        <addColumn tableName="auth_organizations">
            <column name="uuid" type="uuid" defaultValueComputed="gen_random_uuid()">
                <constraints nullable="false" unique="true" />
            </column>
        </addColumn>

        <addColumn tableName="auth_tenants">
            <column name="uuid" type="uuid" defaultValueComputed="gen_random_uuid()">
                <constraints nullable="false" unique="true" />
            </column>
        </addColumn>

        <addColumn tableName="auth_users">
            <column name="uuid" type="uuid" defaultValueComputed="gen_random_uuid()">
                <constraints nullable="false" unique="true" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="remove_unused_table" author="lennartkoopmann">
        <dropForeignKeyConstraint baseTableName="auth_users" constraintName="link_users2roles" />
        <dropTable tableName="auth_roles" />
    </changeSet>

    <changeSet id="fix_bigint_uuid_relations" author="lennartkoopmann">
        <dropColumn tableName="auth_permissions" columnName="user_id" />
        <addColumn tableName="auth_permissions">
            <column name="user_id" type="uuid">
                <constraints nullable="false" />
            </column>
        </addColumn>
        <addForeignKeyConstraint constraintName="link_users2permissions"
                                 baseTableName="auth_permissions"
                                 baseColumnNames="user_id"
                                 referencedTableName="auth_users"
                                 referencedColumnNames="uuid"
                                 onUpdate="NO ACTION"
                                 onDelete="CASCADE" />

        <dropColumn tableName="auth_sessions" columnName="user_id" />
        <addColumn tableName="auth_sessions">
            <column name="user_id" type="uuid">
                <constraints nullable="false" />
            </column>
        </addColumn>
        <addForeignKeyConstraint constraintName="link_users2sessions"
                                 baseTableName="auth_sessions"
                                 baseColumnNames="user_id"
                                 referencedTableName="auth_users"
                                 referencedColumnNames="uuid"
                                 onUpdate="NO ACTION"
                                 onDelete="CASCADE" />

        <dropColumn tableName="auth_tenants" columnName="organization_id" />
        <addColumn tableName="auth_tenants">
            <column name="organization_id" type="uuid">
                <constraints nullable="false" />
            </column>
        </addColumn>
        <addForeignKeyConstraint constraintName="link_tenants2orgs"
                                 baseTableName="auth_tenants"
                                 baseColumnNames="organization_id"
                                 referencedTableName="auth_organizations"
                                 referencedColumnNames="uuid"
                                 onUpdate="NO ACTION"
                                 onDelete="RESTRICT"
        />

        <dropColumn tableName="auth_users" columnName="tenant_id" />
        <addColumn tableName="auth_users">
            <column name="tenant_id" type="uuid">
                <constraints nullable="false" />
            </column>
        </addColumn>
        <addForeignKeyConstraint constraintName="link_users2tenants"
                                 baseTableName="auth_users"
                                 baseColumnNames="tenant_id"
                                 referencedTableName="auth_tenants"
                                 referencedColumnNames="uuid"
                                 onUpdate="NO ACTION"
                                 onDelete="RESTRICT"
        />

        <dropColumn tableName="auth_users" columnName="organization_id" />
        <addColumn tableName="auth_users">
            <column name="organization_id" type="uuid">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <dropColumn tableName="auth_users_taps" columnName="user_id" />
        <addColumn tableName="auth_users_taps">
            <column name="user_id" type="uuid">
                <constraints nullable="false" />
            </column>
        </addColumn>
        <addForeignKeyConstraint constraintName="link_users2tapperms"
                                 baseTableName="auth_users_taps"
                                 baseColumnNames="user_id"
                                 referencedTableName="auth_users"
                                 referencedColumnNames="uuid"
                                 onUpdate="NO ACTION"
                                 onDelete="CASCADE" />

        <dropColumn tableName="taps" columnName="organization_id" />
        <addColumn tableName="taps">
            <column name="organization_id" type="uuid">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <dropColumn tableName="taps" columnName="tenant_id" />
        <addColumn tableName="taps">
            <column name="tenant_id" type="uuid">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <dropColumn tableName="auth_users" columnName="role_id" />
    </changeSet>

    <changeSet id="fix_null_constraints_after_uuid_change" author="lennartkoopmann">
        <dropNotNullConstraint tableName="auth_users" columnName="organization_id" />
        <dropNotNullConstraint tableName="auth_users" columnName="tenant_id" />
    </changeSet>

    <changeSet id="add_user_login_bruteforce_detection" author="lennartkoopmann">
        <addColumn tableName="auth_users">
            <column name="failed_login_count" type="int">
                <constraints nullable="true" />
            </column>
        </addColumn>

        <addColumn tableName="auth_users">
            <column name="last_failed_login" type="timestamp with time zone">
                <constraints nullable="true" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="remove_unneeded_last_failed_login_timestamp" author="lennartkoopmann">
        <dropColumn tableName="auth_users" columnName="last_failed_login" />
    </changeSet>

    <changeSet id="create_events" author="lennartkoopmann">
        <createTable tableName="event_actions">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="uuid" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="action_type" type="varchar(64)">
                <constraints nullable="false" />
            </column>

            <column name="organization_id" type="uuid">
                <constraints nullable="true" />
            </column>

            <column name="tenant_id" type="uuid">
                <constraints nullable="true" />
            </column>

            <column name="name" type="varchar(255)">
                <constraints nullable="false" />
            </column>

            <column name="description" type="text">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createTable tableName="event_subscriptions">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="subscription_type" type="varchar(64)">
                <constraints nullable="false" />
            </column>

            <column name="reference" type="varchar(255)">
                <constraints nullable="false" />
            </column>

            <column name="event_action_id" type="uuid">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createTable tableName="events">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="uuid" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="organization_id" type="uuid">
                <constraints nullable="true" />
            </column>

            <column name="tenant_id" type="uuid">
                <constraints nullable="true" />
            </column>

            <column name="event_type" type="varchar(64)">
                <constraints nullable="false" />
            </column>

            <column name="reference" type="varchar(255)">
                <constraints nullable="false" />
            </column>

            <column name="title" type="varchar(255)">
                <constraints nullable="false" />
            </column>

            <column name="description" type="varchar(255)">
                <constraints nullable="false" />
            </column>

            <column name="actions_fired" type="text">
                <constraints nullable="true" />
            </column>
        </createTable>
    </changeSet>

    <changeSet id="change_events_layout" author="lennartkoopmann">
        <addDefaultValue tableName="events" columnName="uuid" defaultValueComputed="gen_random_uuid()" />
        <dropColumn tableName="events" columnName="title" />
        <dropColumn tableName="events" columnName="description" />
        <addColumn tableName="events">
            <column name="details" type="text">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_timestamp_to_events" author="lennartkoopmann">
        <addColumn tableName="events">
            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="remove_tenant_id_from_event_actions" author="lennartkoopmann">
        <dropColumn tableName="event_actions" columnName="tenant_id" />
    </changeSet>
    
    <changeSet id="add_configuration_to_event_actions" author="lennartkoopmann">
        <addColumn tableName="event_actions">
            <column name="configuration" type="text">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_timestamps_to_event_actions" author="lennartkoopmann">
        <addColumn tableName="event_actions">
            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="event_actions">
            <column name="updated_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="change_event_subscriptions_field_names_add_uuid_org_id" author="lennartkoopmann">
        <renameColumn tableName="event_subscriptions" oldColumnName="subscription_type" newColumnName="event_type" />
        <renameColumn tableName="event_subscriptions" oldColumnName="event_action_id" newColumnName="action_name" />

        <addColumn tableName="event_subscriptions">
            <column name="uuid" type="uuid">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="event_subscriptions">
            <column name="organization_id" type="uuid">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="fix_error_in_event_subscription_action_id_rename" author="lennartkoopmann">
        <renameColumn tableName="event_subscriptions" oldColumnName="action_name" newColumnName="action_id" />
    </changeSet>

    <changeSet id="fix_another_error_in_event_subscriptions_4654234" author="lennartkoopmann">
        <dropNotNullConstraint tableName="event_subscriptions" columnName="organization_id" />
    </changeSet>

    <changeSet id="remove_tables_for_v200" author="lennartkoopmann">
        <dropTable tableName="alerts" />
        <dropTable tableName="contact_records" />
        <dropTable tableName="contacts" />
        <dropTable tableName="bandit_identifiers" />
        <dropTable tableName="bandits" />
        <dropTable tableName="beacon_rate_history" />
        <dropTable tableName="deauth_monitor" />
        <dropTable tableName="report_execution_log" />
        <dropTable tableName="report_metadata" />
        <dropTable tableName="report_receivers_email" />
        <dropTable tableName="scheduler_blob_triggers" />
        <dropTable tableName="scheduler_calendars" />
        <dropTable tableName="scheduler_cron_triggers" />
        <dropTable tableName="scheduler_fired_triggers" />
        <dropTable tableName="scheduler_simprop_triggers" />
        <dropTable tableName="scheduler_simple_triggers" />
        <dropTable tableName="scheduler_triggers" />
        <dropTable tableName="scheduler_job_details" />
        <dropTable tableName="scheduler_locks" />
        <dropTable tableName="scheduler_paused_trigger_grps" />
        <dropTable tableName="scheduler_scheduler_state" />
        <dropTable tableName="sentry_ssids" />
        <dropTable tableName="sigidx_histogram_history" />
    </changeSet>

    <changeSet id="first_802_11_tables" author="lennartkoopmann">
        <createTable tableName="dot11_bssids">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="uuid" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="tap_uuid" type="uuid" >
                <constraints nullable="false" />
            </column>

            <column name="bssid" type="varchar(17)" >
                <constraints nullable="false" />
            </column>

            <column name="oui" type="text" >
                <constraints nullable="true" />
            </column>

            <column name="signal_strength_average" type="float">
                <constraints nullable="false" />
            </column>

            <column name="signal_strength_min" type="int">
                <constraints nullable="false" />
            </column>

            <column name="signal_strength_max" type="int">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>

        <addForeignKeyConstraint constraintName="link_taps2bssids"
                                 baseTableName="dot11_bssids"
                                 baseColumnNames="tap_uuid"
                                 referencedTableName="taps"
                                 referencedColumnNames="uuid"
                                 onUpdate="NO ACTION"
                                 onDelete="CASCADE" />
    </changeSet>

    <changeSet id="create_802_11_ssids_table" author="lennartkoopmann">
        <createTable tableName="dot11_ssids">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="uuid" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="bssid_id" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="security_protocol" type="varchar(4)">
                <constraints nullable="false" />
            </column>

            <column name="security_suites" type="text">
                <constraints nullable="true" />
            </column>

            <column name="fingerprints" type="text">
                <constraints nullable="false" />
            </column>

            <column name="is_wps" type="boolean">
                <constraints nullable="false" />
            </column>

            <column name="signal_strength_average" type="float">
                <constraints nullable="false" />
            </column>

            <column name="signal_strength_min" type="int">
                <constraints nullable="false" />
            </column>

            <column name="signal_strength_max" type="int">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>

        <addForeignKeyConstraint constraintName="link_ssids2bssids"
                                 baseTableName="dot11_ssids"
                                 baseColumnNames="bssid_id"
                                 referencedTableName="dot11_bssids"
                                 referencedColumnNames="id"
                                 onUpdate="NO ACTION"
                                 onDelete="CASCADE" />
    </changeSet>

    <changeSet id="add_fingerprints_to_bssids" author="lennartkoopmann">
        <addColumn tableName="dot11_bssids">
            <column name="fingerprints" type="text">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="make_ssid_security_protocol_longer" author="lennartkoopmann">
        <modifyDataType tableName="dot11_ssids" columnName="security_suites" newDataType="varchar(32)" />
    </changeSet>

    <changeSet id="add_actual_ssid_to_ssids_lmao" author="lennartkoopmann">
        <addColumn tableName="dot11_ssids">
            <column name="ssid" type="varchar(32)">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="make_ssid_security_suites_text" author="lennartkoopmann">
        <modifyDataType tableName="dot11_ssids" columnName="security_suites" newDataType="text" />
    </changeSet>

    <changeSet id="move_fingerprints_to_table" author="lennartkoopmann">
        <createTable tableName="dot11_fingerprints">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="uuid" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="fingerprint" type="varchar(64)">
                <constraints nullable="false" />
            </column>

            <column name="bssid_id" type="bigint">
                <constraints nullable="true" />
            </column>

            <column name="ssid_id" type="bigint">
                <constraints nullable="true" />
            </column>
        </createTable>

        <dropColumn tableName="dot11_bssids" columnName="fingerprints" />
        <dropColumn tableName="dot11_ssids" columnName="fingerprints" />

        <addForeignKeyConstraint constraintName="link_fingerprints2bssids"
                                 baseTableName="dot11_fingerprints"
                                 baseColumnNames="bssid_id"
                                 referencedTableName="dot11_bssids"
                                 referencedColumnNames="id"
                                 onUpdate="NO ACTION"
                                 onDelete="CASCADE" />

        <addForeignKeyConstraint constraintName="link_fingerprints2ssids"
                                 baseTableName="dot11_fingerprints"
                                 baseColumnNames="ssid_id"
                                 referencedTableName="dot11_ssids"
                                 referencedColumnNames="id"
                                 onUpdate="NO ACTION"
                                 onDelete="CASCADE" />
    </changeSet>

    <changeSet id="add_indices_to_first_dot11_tables" author="lennartkoopmann">
        <createIndex tableName="dot11_bssids" indexName="bssids_table_lookup">
            <column name="created_at" />
            <column name="tap_uuid" />
        </createIndex>

        <createIndex tableName="dot11_bssids" indexName="bssids_single_lookup">
            <column name="bssid" />
            <column name="created_at" />
        </createIndex>

        <createIndex tableName="dot11_ssids" indexName="ssids_by_bssid_lookup">
            <column name="created_at" />
            <column name="bssid_id" />
        </createIndex>

        <createIndex tableName="dot11_fingerprints" indexName="fingerprint_bssid_lookup">
            <column name="bssid_id" />
        </createIndex>

        <createIndex tableName="dot11_fingerprints" indexName="fingerprint_ssid_lookup">
            <column name="ssid_id" />
        </createIndex>
    </changeSet>

    <changeSet id="add_hidden_frame_counter_to_bssids" author="lennartkoopmann">
        <addColumn tableName="dot11_bssids">
            <column name="hidden_ssid_frames" type="bigint" defaultValue="0">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_actual_ssids_and_bssids_to_fingerprints" author="lennartkoopmann">
        <addColumn tableName="dot11_fingerprints">
            <column name="ssid" type="varchar(32)">
                <constraints nullable="true" />
            </column>
        </addColumn>

        <addColumn tableName="dot11_fingerprints">
            <column name="bssid" type="varchar(17)">
                <constraints nullable="true" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_actual_bssid_to_ssids" author="lennartkoopmann">
        <addColumn tableName="dot11_ssids">
            <column name="bssid" type="varchar(17)">
                <constraints nullable="true" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_timestamp_to_fingerprints" author="lennartkoopmann">
        <addColumn tableName="dot11_fingerprints">
            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="make_ssid_security_protocol_larger" author="lennartkoopmann">
        <modifyDataType tableName="dot11_ssids" columnName="security_protocol" newDataType="text" />
    </changeSet>

    <changeSet id="add_tap_uuid_to_fingerprints_and_ssids" author="lennartkoopmann">
        <addColumn tableName="dot11_fingerprints">
            <column name="tap_uuid" type="uuid">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="dot11_ssids">
            <column name="tap_uuid" type="uuid">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="remove_ssid_and_bssid_fields_from_fingerprints" author="lennartkoopmann">
        <dropColumn tableName="dot11_fingerprints" columnName="ssid" />
        <dropColumn tableName="dot11_fingerprints" columnName="bssid" />
    </changeSet>

    <changeSet id="create_dot11_channels" author="lennartkoopmann">
        <createTable tableName="dot11_channels">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="uuid" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="frequency" type="integer">
                <constraints nullable="false" />
            </column>

            <column name="ssid_id" type="bigint">
                <constraints nullable="false" />
            </column>
        </createTable>

        <addForeignKeyConstraint constraintName="link_channels2ssids"
                                 baseTableName="dot11_channels"
                                 baseColumnNames="ssid_id"
                                 referencedTableName="dot11_ssids"
                                 referencedColumnNames="id"
                                 onUpdate="NO ACTION"
                                 onDelete="CASCADE" />

        <createIndex tableName="dot11_channels" indexName="channel_ssid_id_lookup">
            <column name="ssid_id" />
        </createIndex>
    </changeSet>

    <changeSet id="add_stats_fields_to_dot11_channels" author="lennrtkoopmann">
        <addColumn tableName="dot11_channels">
            <column name="frame_type" type="varchar(32)">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="dot11_channels">
            <column name="stats_bytes" type="bigint">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="dot11_channels">
            <column name="stats_frames" type="bigint">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="create_dot11_infrastructure_types" author="lennartkoopmann">
        <createTable tableName="dot11_infrastructure_types">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="infrastructure_type" type="varchar(32)">
                <constraints nullable="false" />
            </column>

            <column name="ssid_id" type="bigint">
                <constraints nullable="false" />
            </column>
        </createTable>

        <addForeignKeyConstraint constraintName="link_iftypes2ssids"
                                 baseTableName="dot11_infrastructure_types"
                                 baseColumnNames="ssid_id"
                                 referencedTableName="dot11_ssids"
                                 referencedColumnNames="id"
                                 onUpdate="NO ACTION"
                                 onDelete="CASCADE" />

        <createIndex tableName="dot11_infrastructure_types" indexName="iftype_ssid_id_lookup">
            <column name="ssid_id" />
        </createIndex>
    </changeSet>

    <changeSet id="create_dot11_clients" author="lennartkoopmann">
        <createTable tableName="dot11_clients">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="uuid" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="bssid_id" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="client_mac" type="varchar(17)">
                <constraints nullable="false" />
            </column>

            <column name="tx_frames" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="tx_bytes" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="rx_frames" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="rx_bytes" type="bigint">
                <constraints nullable="false" />
            </column>
        </createTable>

        <addForeignKeyConstraint constraintName="link_clients2bssids"
                                 baseTableName="dot11_clients"
                                 baseColumnNames="bssid_id"
                                 referencedTableName="dot11_bssids"
                                 referencedColumnNames="id"
                                 onUpdate="NO ACTION"
                                 onDelete="CASCADE" />

        <createIndex tableName="dot11_clients" indexName="clients_bssid_id_lookup">
            <column name="bssid_id" />
        </createIndex>
    </changeSet>

    <changeSet id="remove_fields_from_dot11_fingerprints" author="lennartkoopmann">
        <dropColumn tableName="dot11_fingerprints" columnName="uuid" />
        <dropColumn tableName="dot11_fingerprints" columnName="created_at" />
        <dropColumn tableName="dot11_fingerprints" columnName="tap_uuid" />
    </changeSet>

    <changeSet id="add_dot11_rates" author="lennartkoopmann">
        <createTable tableName="dot11_rates">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="rate" type="varchar(12)">
                <constraints nullable="false" />
            </column>

            <column name="ssid_id" type="bigint">
                <constraints nullable="false" />
            </column>
        </createTable>

        <addForeignKeyConstraint constraintName="link_rates2ssids"
                                 baseTableName="dot11_rates"
                                 baseColumnNames="ssid_id"
                                 referencedTableName="dot11_ssids"
                                 referencedColumnNames="id"
                                 onUpdate="NO ACTION"
                                 onDelete="CASCADE" />

        <createIndex tableName="dot11_rates" indexName="rates_ssid_id_lookup">
            <column name="ssid_id" />
        </createIndex>
    </changeSet>

    <changeSet id="change_dot11_rates_rate_type" author="lennartkoopmann">
        <modifyDataType tableName="dot11_rates" columnName="rate" newDataType="float" />
    </changeSet>

    <changeSet id="add_beacon_and_proberesp_counts_to_dot11_ssids" author="lennartkoopmann">
        <addColumn tableName="dot11_ssids">
            <column name="beacon_count" type="bigint" defaultValue="0">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="dot11_ssids">
            <column name="proberesp_count" type="bigint" defaultValue="0">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="rename_ssid_frame_counts_to_advertisements" author="lennartkoopmann">
        <renameColumn tableName="dot11_ssids" oldColumnName="beacon_count" newColumnName="beacon_advertisements" />
        <renameColumn tableName="dot11_ssids" oldColumnName="proberesp_count" newColumnName="proberesp_advertisements" />
    </changeSet>

    <changeSet id="remove_uuids_from_dot11_tables" author="lennartkoopmann">
        <dropColumn tableName="dot11_bssids" columnName="uuid" />
        <dropColumn tableName="dot11_channels" columnName="uuid" />
        <dropColumn tableName="dot11_clients" columnName="uuid" />
        <dropColumn tableName="dot11_ssids" columnName="uuid" />
    </changeSet>

    <changeSet id="create_actual_clients_table" author="lennartkoopmann">
        <renameTable oldTableName="dot11_clients" newTableName="dot11_bssid_clients" />
        <dropPrimaryKey tableName="dot11_bssid_clients" />
        <addPrimaryKey tableName="dot11_bssid_clients" columnNames="id" />

        <createTable tableName="dot11_clients">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="tap_uuid" type="uuid">
                <constraints nullable="false" unique="true" />
            </column>

            <column name="client_mac" type="varchar(17)">
                <constraints nullable="false" />
            </column>

            <column name="wildcard_probe_requests" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createTable tableName="dot11_client_probereq_ssids">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="client_id" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="ssid" type="varchar(32)">
                <constraints nullable="false" />
            </column>

            <column name="tap_uuid" type="uuid">
                <constraints nullable="false" unique="true" />
            </column>
        </createTable>

        <addForeignKeyConstraint constraintName="link_probreqs2ssids"
                                 baseTableName="dot11_client_probereq_ssids"
                                 baseColumnNames="client_id"
                                 referencedTableName="dot11_clients"
                                 referencedColumnNames="id"
                                 onUpdate="NO ACTION"
                                 onDelete="CASCADE" />

        <createIndex tableName="dot11_client_probereq_ssids" indexName="probereq_client_id_lookup">
            <column name="client_id" />
        </createIndex>
    </changeSet>

    <changeSet id="fix_clients_tap_uuid_uniqueness" author="lennartkoopmann">
        <dropUniqueConstraint tableName="dot11_clients" constraintName="dot11_clients_tap_uuid_key" />
        <dropUniqueConstraint tableName="dot11_client_probereq_ssids" constraintName="dot11_client_probereq_ssids_tap_uuid_key" />
    </changeSet>

    <changeSet id="add_bssids_index_for_bssid_lookup" author="lennartkoopmann">
        <createIndex tableName="dot11_bssids" indexName="bssids_bssid_lookup">
            <column name="bssid" />
        </createIndex>
    </changeSet>

    <changeSet id="add_more_indices_for_bssid_lookup" author="lennartkoopmann">
        <createIndex tableName="dot11_bssids" indexName="bssids_bssid_timestamp">
            <column name="created_at" />
        </createIndex>

        <createIndex tableName="dot11_bssids" indexName="bssids_bssid_tapuuid">
            <column name="tap_uuid" />
        </createIndex>

        <createIndex tableName="dot11_ssids" indexName="ssids_bssid_lookup">
            <column name="bssid_id" />
        </createIndex>

        <createIndex tableName="dot11_fingerprints" indexName="fingerprints_bssid_lookup">
            <column name="bssid_id" />
        </createIndex>

        <createIndex tableName="dot11_infrastructure_types" indexName="infratypes_ssid_lookup">
            <column name="ssid_id" />
        </createIndex>

        <createIndex tableName="dot11_bssid_clients" indexName="bssidclients_bssid_lookup">
            <column name="bssid_id" />
        </createIndex>
    </changeSet>

    <changeSet id="add_dot11_channel_histogram_table" author="lennartkoopmann">
        <createTable tableName="dot11_channel_histograms">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="channel_id" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="signal_strength" type="integer">
                <constraints nullable="false" />
            </column>

            <column name="frame_count" type="integer">
                <constraints nullable="false" />
            </column>
        </createTable>

        <addForeignKeyConstraint constraintName="link_channelhistos2channels"
                                 baseTableName="dot11_channel_histograms"
                                 baseColumnNames="channel_id"
                                 referencedTableName="dot11_channels"
                                 referencedColumnNames="id"
                                 onUpdate="NO ACTION"
                                 onDelete="CASCADE" />
    </changeSet>

    <changeSet id="change_dot11_channel_histogram_table_to_connect_to_ssid_directly" author="lennartkoopmann">
        <dropTable tableName="dot11_channel_histograms" />

        <createTable tableName="dot11_channel_histograms">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="ssid_id" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="frequency" type="integer">
                <constraints nullable="false" />
            </column>

            <column name="signal_strength" type="integer">
                <constraints nullable="false" />
            </column>

            <column name="frame_count" type="integer">
                <constraints nullable="false" />
            </column>
        </createTable>

        <addForeignKeyConstraint constraintName="link_channelhistos2ssids"
                                 baseTableName="dot11_channel_histograms"
                                 baseColumnNames="ssid_id"
                                 referencedTableName="dot11_ssids"
                                 referencedColumnNames="id"
                                 onUpdate="NO ACTION"
                                 onDelete="CASCADE" />
    </changeSet>

    <changeSet id="optimize_dot11_indices_20230711" author="lennartkoopmann">
        <dropIndex tableName="dot11_bssid_clients" indexName="clients_bssid_id_lookup" /> <!-- duplicate -->
        <dropIndex tableName="dot11_infrastructure_types" indexName="iftype_ssid_id_lookup" /> <!-- duplicate -->
        <dropIndex tableName="dot11_fingerprints" indexName="fingerprints_bssid_lookup" /> <!-- duplicate -->

        <createIndex tableName="dot11_channel_histograms" indexName="channelhistos_rellookup">
            <column name="ssid_id" />
        </createIndex>

        <createIndex tableName="dot11_clients" indexName="clients_stdlookup">
            <column name="tap_uuid" />
            <column name="created_at" />
        </createIndex>

        <createIndex tableName="dot11_clients" indexName="clients_directlookup">
            <column name="tap_uuid" />
            <column name="client_mac" />
            <column name="created_at" />
        </createIndex>
    </changeSet>

    <changeSet id="change_dot11_bssids_index_order" author="lennartkoopmann">
        <dropIndex tableName="dot11_bssids" indexName="bssids_table_lookup" />

        <createIndex tableName="dot11_bssids" indexName="bssids_table_lookup">
            <column name="tap_uuid" />
            <column name="created_at" />
        </createIndex>
    </changeSet>

    <changeSet id="add_dot11_ssids_index_07152023" author="lennartkoopmann">
        <createIndex tableName="dot11_ssids" indexName="ssids_bssid_direct_lookup">
            <column name="bssid" />
            <column name="tap_uuid" />
        </createIndex>
    </changeSet>

    <changeSet id="add_frame_count_to_probe_requests" author="lennartkoopmann">
        <addColumn tableName="dot11_client_probereq_ssids">
            <column name="frame_count" type="bigint" defaultValue="0" />
        </addColumn>
    </changeSet>

    <changeSet id="add_dot11_monitored_networks" author="lennartkoopmann">
        <createTable tableName="dot11_monitored_networks">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="uuid" type="uuid">
                <constraints nullable="false" unique="true" />
            </column>

            <column name="organization_id" type="bigint">
                <constraints nullable="true" />
            </column>

            <column name="tenant_id" type="bigint">
                <constraints nullable="true" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="updated_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>
    </changeSet>

    <changeSet id="add_ssid_to_monitored_networks" author="lennartkoopmann">
        <addColumn tableName="dot11_monitored_networks">
            <column name="ssid" type="text">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_dot11_monitored_networks_bssids_and_fps" author="lennartkoopmann">
        <createTable tableName="dot11_monitored_networks_bssids">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="uuid" type="uuid">
                <constraints nullable="false" unique="true" />
            </column>

            <column name="monitored_network_id" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="bssid" type="varchar(17)">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createTable tableName="dot11_monitored_networks_fingerprints">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="uuid" type="uuid">
                <constraints nullable="false" unique="true" />
            </column>

            <column name="monitored_network_bssid_id" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="fingerprints" type="varchar(64)">
                <constraints nullable="false" />
            </column>
        </createTable>

        <addForeignKeyConstraint constraintName="link_monitoredbssids2ssids"
                                 baseTableName="dot11_monitored_networks_bssids"
                                 baseColumnNames="monitored_network_id"
                                 referencedTableName="dot11_monitored_networks"
                                 referencedColumnNames="id"
                                 onUpdate="NO ACTION"
                                 onDelete="CASCADE" />

        <addForeignKeyConstraint constraintName="link_monitoredfps2bssids"
                                 baseTableName="dot11_monitored_networks_fingerprints"
                                 baseColumnNames="monitored_network_bssid_id"
                                 referencedTableName="dot11_monitored_networks_bssids"
                                 referencedColumnNames="id"
                                 onUpdate="NO ACTION"
                                 onDelete="CASCADE" />
    </changeSet>

    <changeSet id="rename_monitored_fingerprints_fingerprint_column" author="lennartkoopmann">
        <renameColumn tableName="dot11_monitored_networks_fingerprints"
                      oldColumnName="fingerprints"
                      newColumnName="fingerprint" />
    </changeSet>

    <changeSet id="create_dot11_monitored_networks_channels" author="lennartkoopmann">
        <createTable tableName="dot11_monitored_networks_channels">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="uuid" type="uuid">
                <constraints nullable="false" unique="true" />
            </column>

            <column name="monitored_network_id" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="channel" type="integer">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createTable tableName="dot11_monitored_networks_security_suites">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="uuid" type="uuid">
                <constraints nullable="false" unique="true" />
            </column>

            <column name="monitored_network_id" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="suite" type="text">
                <constraints nullable="false" />
            </column>
        </createTable>

        <addForeignKeyConstraint constraintName="link_monitoredchannels2ssids"
                                 baseTableName="dot11_monitored_networks_channels"
                                 baseColumnNames="monitored_network_id"
                                 referencedTableName="dot11_monitored_networks"
                                 referencedColumnNames="id"
                                 onUpdate="NO ACTION"
                                 onDelete="CASCADE" />

        <addForeignKeyConstraint constraintName="link_monitoredsuites2ssids"
                                 baseTableName="dot11_monitored_networks_security_suites"
                                 baseColumnNames="monitored_network_id"
                                 referencedTableName="dot11_monitored_networks"
                                 referencedColumnNames="id"
                                 onUpdate="NO ACTION"
                                 onDelete="CASCADE" />
    </changeSet>

    <changeSet id="rename_monitored_channels_column_to_frequency" author="lennartkoopmann">
        <renameColumn tableName="dot11_monitored_networks_channels" oldColumnName="channel" newColumnName="frequency" />
    </changeSet>
    
    <changeSet id="add_enabled_disabled_state_to_monitored_networks" author="lennartkoopmann">
        <addColumn tableName="dot11_monitored_networks">
            <column name="enabled" type="boolean" defaultValue="false">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_dot11_monitored_networks_detection_fields" author="lennartkoopmann">
        <addColumn tableName="dot11_monitored_networks">
            <column name="status_unexpected_bssid" type="boolean" defaultValue="false">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="dot11_monitored_networks">
            <column name="status_unexpected_ssid" type="boolean" defaultValue="false">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="dot11_monitored_networks">
            <column name="status_unexpected_channel" type="boolean" defaultValue="false">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="dot11_monitored_networks">
            <column name="status_unexpected_security" type="boolean" defaultValue="false">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="dot11_monitored_networks">
            <column name="status_unexpected_fingerprint" type="boolean" defaultValue="false">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="remove_not_needed_dot11_monitored_networks_column_20230726" author="lennartkoopmann">
        <dropColumn tableName="dot11_monitored_networks" columnName="status_unexpected_ssid" />
    </changeSet>

    <changeSet id="add_monitoring_for_802_11_security_protocol" author="lennartkoopmann">
        <renameColumn tableName="dot11_monitored_networks"
                      oldColumnName="status_unexpected_security"
                      newColumnName="status_unexpected_security_suites" />

        <addColumn tableName="dot11_monitored_networks">
            <column name="status_unexpected_security_protocol" type="boolean" defaultValue="false">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="fix_dot11_monitored_networks_org_information_column_types" author="lennartkoopmann">
        <dropColumn tableName="dot11_monitored_networks" columnName="organization_id" />
        <dropColumn tableName="dot11_monitored_networks" columnName="tenant_id" />

        <addColumn tableName="dot11_monitored_networks">
            <column name="organization_id" type="bigint">
                <constraints nullable="true" />
            </column>
        </addColumn>

        <addColumn tableName="dot11_monitored_networks">
        <column name="tenant_id" type="bigint">
            <constraints nullable="true" />
        </column>
        </addColumn>
    </changeSet>

    <changeSet id="actually_fix_dot11_monitored_networks_org_information_column_types" author="lennartkoopmann">
        <dropColumn tableName="dot11_monitored_networks" columnName="organization_id" />
        <dropColumn tableName="dot11_monitored_networks" columnName="tenant_id" />

        <addColumn tableName="dot11_monitored_networks">
            <column name="organization_id" type="uuid">
                <constraints nullable="true" />
            </column>
        </addColumn>

        <addColumn tableName="dot11_monitored_networks">
            <column name="tenant_id" type="uuid">
                <constraints nullable="true" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_dot11_monitored_networks_unexpected_signal_tracks" author="lennartkoopmann">
        <addColumn tableName="dot11_monitored_networks">
            <column name="status_unexpected_signal_tracks" type="boolean" defaultValue="false">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="create_detection_alerts_tables" author="lennartkoopmann">
        <createTable tableName="detection_alerts">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="uuid" type="uuid">
                <constraints nullable="false" unique="true" />
            </column>

            <column name="organization_id" type="bigint">
                <constraints nullable="true" />
            </column>

            <column name="tenant_id" type="bigint">
                <constraints nullable="true" />
            </column>

            <column name="dot11_monitored_network_id" type="uuid">
                <constraints nullable="true" />
            </column>

            <column name="tap_id" type="uuid">
                <constraints nullable="true" />
            </column>

            <column name="detection_type" type="varchar(64)">
                <constraints nullable="false" />
            </column>

            <column name="subsystem" type="varchar(32)">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="last_seen" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createTable tableName="detection_alert_attributes">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="detection_alert_id" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="attribute_key" type="varchar(64)">
                <constraints nullable="false" />
            </column>

            <column name="attribute_value" type="text">
                <constraints nullable="false" />
            </column>
        </createTable>

        <addForeignKeyConstraint constraintName="link_detectionalertattrs2alerts"
                                 baseTableName="detection_alert_attributes"
                                 baseColumnNames="detection_alert_id"
                                 referencedTableName="detection_alerts"
                                 referencedColumnNames="id"
                                 onUpdate="NO ACTION"
                                 onDelete="CASCADE" />
    </changeSet>

    <changeSet id="add_comparison_checksum_to_detection_alerts" author="lennartkoopmann">
        <addColumn tableName="detection_alerts">
            <column name="comparison_checksum" type="varchar(64)">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="make_detection_alert_comparison_checksum_unique" author="lennartkoopmann">
        <addUniqueConstraint tableName="detection_alerts" columnNames="comparison_checksum" />
    </changeSet>

    <changeSet id="add_detection_alert_indices" author="lennartkoopmann">
        <createIndex tableName="detection_alerts" indexName="detectionalerts_org">
            <column name="organization_id" />
        </createIndex>

        <createIndex tableName="detection_alerts" indexName="detectionalerts_tenant">
            <column name="tenant_id" />
        </createIndex>

        <createIndex tableName="detection_alerts" indexName="detectionalerts_type">
            <column name="detection_type" />
        </createIndex>

        <createIndex tableName="detection_alerts" indexName="detectionalerts_cs_compare">
            <column name="comparison_checksum" />
        </createIndex>
    </changeSet>

    <changeSet id="change_alert_org_and_tenant_id_types_to_uuid" author="lennartkoopmann">
        <dropColumn tableName="detection_alerts" columnName="organization_id" />
        <dropColumn tableName="detection_alerts" columnName="tenant_id" />

        <addColumn tableName="detection_alerts">
            <column name="organization_id" type="uuid">
                <constraints nullable="true" />
            </column>
        </addColumn>

        <addColumn tableName="detection_alerts">
            <column name="tenant_id" type="uuid">
                <constraints nullable="true" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_details_to_detection_alerts" author="lennartkoopmann">
        <addColumn tableName="detection_alerts">
            <column name="details" type="text" defaultValue="No Details.">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_detection_alert_timeline" author="lennartkoopmann">
        <createTable tableName="detection_alert_timeline">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="detection_alert_id" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="seen_from" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="seen_to" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>
    </changeSet>

    <changeSet id="link_detection_alert_timeline_to_alerts" author="lennartkoopmann">
        <addForeignKeyConstraint constraintName="link_detectionalerttl2alerts"
                                 baseTableName="detection_alert_timeline"
                                 baseColumnNames="detection_alert_id"
                                 referencedTableName="detection_alerts"
                                 referencedColumnNames="id"
                                 onUpdate="NO ACTION"
                                 onDelete="CASCADE" />
    </changeSet>

    <changeSet id="make_tenant_org_fields_of_monitored_networks_mandatory" author="lennartkoopmann">
        <delete tableName="dot11_monitored_networks">
            <where>1=1</where>
        </delete>

        <addNotNullConstraint tableName="dot11_monitored_networks" columnName="tenant_id" />
        <addNotNullConstraint tableName="dot11_monitored_networks" columnName="organization_id" />
    </changeSet>

    <changeSet id="add_detection_alert_compound_active_lookup_index" author="lennartkoopmann">
        <createIndex tableName="detection_alerts" indexName="compound_active_uuid_lookup">
            <column name="uuid" />
            <column name="last_seen" />
        </createIndex>
    </changeSet>

    <changeSet id="add_is_resolved_field_to_detection_alerts" author="lennartkoopmann">
        <addColumn tableName="detection_alerts">
            <column name="is_resolved" type="boolean" defaultValue="false" />
        </addColumn>
    </changeSet>

    <changeSet id="remove_no_longer_needed_alert_fields_20230821" author="lennartkoopmann">
        <dropColumn tableName="dot11_monitored_networks" columnName="status_unexpected_bssid" />
        <dropColumn tableName="dot11_monitored_networks" columnName="status_unexpected_channel" />
        <dropColumn tableName="dot11_monitored_networks" columnName="status_unexpected_security_suites" />
        <dropColumn tableName="dot11_monitored_networks" columnName="status_unexpected_fingerprint" />
        <dropColumn tableName="dot11_monitored_networks" columnName="status_unexpected_security_protocol" />
        <dropColumn tableName="dot11_monitored_networks" columnName="status_unexpected_signal_tracks" />
    </changeSet>

    <changeSet id="add_dot11_monitor_enable_disable_trigger_fields" author="lennartkoopmann">
        <addColumn tableName="dot11_monitored_networks">
            <column name="enabled_unexpected_bssid" type="boolean" defaultValue="true">
                <constraints nullable="false" />
            </column>

            <column name="enabled_unexpected_channel" type="boolean" defaultValue="true">
                <constraints nullable="false" />
            </column>

            <column name="enabled_unexpected_security_suites" type="boolean" defaultValue="true">
                <constraints nullable="false" />
            </column>

            <column name="enabled_unexpected_fingerprint" type="boolean" defaultValue="true">
                <constraints nullable="false" />
            </column>

            <column name="enabled_unexpected_signal_tracks" type="boolean" defaultValue="true">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_custom_bandits" author="lennartkoopmann">
        <createTable tableName="dot11_bandits">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="uuid" type="uuid">
                <constraints nullable="false" unique="true" />
            </column>

            <column name="organization_id" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="tenant_id" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="name" type="varchar(128)">
                <constraints nullable="false" />
            </column>

            <column name="description" type="text">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="updated_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>


        <createTable tableName="dot11_bandit_fingerprints">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="bandit_id" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="fingerprint" type="varchar(64)">
                <constraints nullable="false" />
            </column>
        </createTable>

        <addForeignKeyConstraint constraintName="link_fingerprints2bandits"
                                 baseTableName="dot11_bandit_fingerprints"
                                 baseColumnNames="bandit_id"
                                 referencedTableName="dot11_bandits"
                                 referencedColumnNames="id"
                                 onUpdate="NO ACTION"
                                 onDelete="CASCADE" />
    </changeSet>

    <changeSet id="change_custom_bandit_auth_relation_column_type" author="lennartkoopmann">
        <dropColumn tableName="dot11_bandits" columnName="organization_id" />
        <dropColumn tableName="dot11_bandits" columnName="tenant_id" />

        <addColumn tableName="dot11_bandits">
            <column name="organization_id" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="tenant_id" type="uuid">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_tap_remote_address" author="lennartkoopmann">
        <addColumn tableName="taps">
            <column name="remote_address" type="text" defaultValue="0.0.0.0">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_custom_track_detector_config" author="lennartkoopmann">
        <createTable tableName="dot11_track_detector_configuration">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="uuid" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="organization_id" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="bssid" type="varchar(17)">
                <constraints nullable="false" />
            </column>

            <column name="ssid" type="varchar(32)">
                <constraints nullable="false" />
            </column>

            <column name="channel" type="integer">
                <constraints nullable="false" />
            </column>

            <column name="frame_threshold" type="integer">
                <constraints nullable="false" />
            </column>

            <column name="gap_threshold" type="integer">
                <constraints nullable="false" />
            </column>

            <column name="signal_centerline_jitter" type="integer">
                <constraints nullable="false" />
            </column>

            <column name="updated_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>
    </changeSet>

    <changeSet id="add_tap_uuid_to_track_detector_configs" author="lennartkoopmann">
        <addColumn tableName="dot11_track_detector_configuration">
            <column name="tap_id" type="uuid">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_dot11_disco_activity_table" author="lennartkoopmann">
        <createTable tableName="dot11_disco_activity">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="tap_uuid" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="disco_type" type="integer">
                <constraints nullable="false" />
            </column> <!-- Liquibase is not great with ENUM types for DB compatibility. -->

            <column name="bssid" type="varchar(17)">
                <constraints nullable="false" />
            </column>

            <column name="sent_frames" type="integer">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createIndex tableName="dot11_disco_activity" indexName="default_lookup">
            <column name="tap_uuid" />
            <column name="bssid" />
            <column name="created_at" />
        </createIndex>

        <createTable tableName="dot11_disco_activity_receivers">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="disco_activity_id" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="bssid" type="varchar(17)">
                <constraints nullable="false" />
            </column>

            <column name="received_frames" type="integer">
                <constraints nullable="false" />
            </column>
        </createTable>

        <addForeignKeyConstraint constraintName="link_discoact2receivers"
                                 baseTableName="dot11_disco_activity_receivers"
                                 baseColumnNames="disco_activity_id"
                                 referencedTableName="dot11_disco_activity"
                                 referencedColumnNames="id"
                                 onUpdate="NO ACTION"
                                 onDelete="CASCADE" />
    </changeSet>

    <changeSet id="add_disco_type_index_to_disco_activity" author="lennartkoopmann">
        <createIndex tableName="dot11_disco_activity" indexName="discotype">
            <column name="disco_type" />
        </createIndex>
    </changeSet>

    <changeSet id="add_disco_monitor_to_tenants" author="lennartkoopmann">
        <addColumn tableName="auth_tenants">
            <column name="dot11_disco_monitor_type" type="varchar(32)">
                <constraints nullable="true" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_disco_monitor_config_to_tenants" author="lennartkoopmann">
        <addColumn tableName="auth_tenants">
            <column name="dot11_disco_monitor_configuration" type="text">
                <constraints nullable="true" />
            </column>
        </addColumn>
    </changeSet>
    
    <changeSet id="add_disco_monitor_config_default_value" author="lennartkoopmann">
        <addDefaultValue tableName="auth_tenants" columnName="dot11_disco_monitor_type" defaultValue="NOOP" />
        <addDefaultValue tableName="auth_tenants" columnName="dot11_disco_monitor_configuration" defaultValue="{}" />

        <sql>UPDATE auth_tenants SET dot11_disco_monitor_type = 'NOOP'</sql>
        <sql>UPDATE auth_tenants SET dot11_disco_monitor_configuration = '{}'</sql>

        <addNotNullConstraint tableName="auth_tenants" columnName="dot11_disco_monitor_type" />
        <addNotNullConstraint tableName="auth_tenants" columnName="dot11_disco_monitor_configuration" />
    </changeSet>

    <changeSet id="move_disco_monitor_config_from_tenants_to_networks" author="lennartkoopmann">
        <dropColumn tableName="auth_tenants" columnName="dot11_disco_monitor_type" />
        <dropColumn tableName="auth_tenants" columnName="dot11_disco_monitor_configuration" />

        <addColumn tableName="dot11_monitored_networks">
            <column name="disco_monitor_type" type="varchar(32)" defaultValue="NOOP">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="dot11_monitored_networks">
            <column name="dot11_disco_monitor_configuration" type="text" defaultValue="{}">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="fix_column_name_20231010" author="lennartkoopmann">
        <renameColumn tableName="dot11_monitored_networks"
                      oldColumnName="dot11_disco_monitor_configuration"
                      newColumnName="disco_monitor_configuration" />
    </changeSet>

    <changeSet id="add_authentication_timeout_columns" author="lennartkoopmann">
        <addColumn tableName="auth_organizations">
            <column name="session_timeout_minutes" type="integer" defaultValue="720">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="auth_organizations">
            <column name="session_inactivity_timeout_minutes" type="integer" defaultValue="15">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="auth_organizations">
            <column name="mfa_timeout_minutes" type="integer" defaultValue="5">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="move_authentication_timeout_columns_to_tenants" author="lennartkoopmann">
        <dropColumn tableName="auth_organizations" columnName="session_timeout_minutes" />
        <dropColumn tableName="auth_organizations" columnName="session_inactivity_timeout_minutes" />
        <dropColumn tableName="auth_organizations" columnName="mfa_timeout_minutes" />

        <addColumn tableName="auth_tenants">
            <column name="session_timeout_minutes" type="integer" defaultValue="720">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="auth_tenants">
            <column name="session_inactivity_timeout_minutes" type="integer" defaultValue="15">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="auth_tenants">
            <column name="mfa_timeout_minutes" type="integer" defaultValue="5">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="create_mac_context" author="lennartkoopmann">
        <createTable tableName="context_mac_addresses">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="mac_address" type="varchar(17)">
                <constraints nullable="false" />
            </column>

            <column name="subsystem" type="varchar(32)">
                <constraints nullable="false" />
            </column>

            <column name="name" type="varchar(12)">
                <constraints nullable="false" />
            </column>

            <column name="description" type="varchar(32)">
                <constraints nullable="true" />
            </column>

            <column name="notes" type="text">
                <constraints nullable="true" />
            </column>

            <column name="organization_id" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="tenant_id" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="updated_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createIndex tableName="context_mac_addresses" indexName="mac">
            <column name="mac_address" />
        </createIndex>

        <createIndex tableName="context_mac_addresses" indexName="subsystem">
            <column name="subsystem" />
        </createIndex>

        <createIndex tableName="context_mac_addresses" indexName="organization">
            <column name="organization_id" />
        </createIndex>

        <createIndex tableName="context_mac_addresses" indexName="tenant">
            <column name="tenant_id" />
        </createIndex>
    </changeSet>

    <changeSet id="add_mac_context_uniqueness" author="lennartkoopmann">
        <addUniqueConstraint tableName="context_mac_addresses" columnNames="mac_address, subsystem" />
    </changeSet>

    <changeSet id="add_uuid_to_mac_address_context" author="lennartkoopmann">
        <addColumn tableName="context_mac_addresses">
            <column name="uuid" type="uuid" />
        </addColumn>

        <createIndex tableName="context_mac_addresses" indexName="direct_uuid">
            <column name="uuid" />
        </createIndex>
    </changeSet>

    <changeSet id="remove_subsystem_from_mac_address_context" author="lennartkoopmann">
        <dropColumn tableName="context_mac_addresses" columnName="subsystem" />
    </changeSet>

    <changeSet id="add_mac_context_uniqueness_without_subsystem" author="lennartkoopmann">
        <addUniqueConstraint tableName="context_mac_addresses" columnNames="mac_address" />
    </changeSet>

    <changeSet id="add_similar_sounding_ssid_monitor_switch" author="lennartkoopmann">
        <addColumn tableName="dot11_monitored_networks">
            <column name="enabled_similar_sounding_ssid" type="boolean" defaultValue="true">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_ssid_substring_monitor_switch" author="lennartkoopmann">
        <addColumn tableName="dot11_monitored_networks">
            <column name="enabled_ssid_substring" type="boolean" defaultValue="true">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_alert_parameters_20231225" author="lennartkoopmann">
        <addColumn tableName="dot11_monitored_networks">
            <column name="dconf_similar_looking_ssid_threshold" type="integer">
                <constraints nullable="true" />
            </column>
        </addColumn>

        <addColumn tableName="dot11_monitored_networks">
            <column name="dconf_ssid_substring_value" type="varchar(255)">
                <constraints nullable="true" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="rename_monitored_net_similar_sounding_ssid_switch" author="lennartkoopmann">
        <renameColumn tableName="dot11_monitored_networks"
                      oldColumnName="enabled_similar_sounding_ssid"
                      newColumnName="enabled_similar_looking_ssid" />
    </changeSet>

    <changeSet id="set_default_value_of_similar_sound_ssids" author="lennartkoopmann">
        <sql>UPDATE dot11_monitored_networks SET dconf_similar_looking_ssid_threshold = 95</sql>
    </changeSet>

    <changeSet id="set_default_value_of_ssid_substring_detection" author="lennartkoopmann">
        <sql>UPDATE dot11_monitored_networks SET dconf_ssid_substring_value = null</sql>
    </changeSet>

    <changeSet id="disable_ssid_substring_detection_by_default" author="lennartkoopmann">
        <sql>UPDATE dot11_monitored_networks SET enabled_ssid_substring = false</sql>
    </changeSet>
    
    <changeSet id="create_dot11_monitored_networks_restricted_substrings" author="lennartkoopmann">
        <createTable tableName="dot11_monitored_networks_restricted_substrings">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="uuid" type="uuid">
                <constraints nullable="false" unique="true" />
            </column>

            <column name="monitored_network_id" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="substring" type="varchar(255)">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="updated_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>

        <addForeignKeyConstraint constraintName="link_restrstrings2monitorednets"
                                 baseTableName="dot11_monitored_networks_restricted_substrings"
                                 baseColumnNames="monitored_network_id"
                                 referencedTableName="dot11_monitored_networks"
                                 referencedColumnNames="id"
                                 onUpdate="NO ACTION"
                                 onDelete="CASCADE" />
    </changeSet>

    <changeSet id="remove_restricted_substring_updated_at_column" author="lennartkoopmann">
        <dropColumn tableName="dot11_monitored_networks_restricted_substrings" columnName="updated_at" />
    </changeSet>

    <changeSet id="remove_singular_detection_config_restricted_substrings" author="lennartkoopmann">
        <dropColumn tableName="dot11_monitored_networks" columnName="dconf_ssid_substring_value" />
    </changeSet>

    <changeSet id="align_disco_anomaly_alert_enable_disable_method" author="lennartkoopmann">
        <addColumn tableName="dot11_monitored_networks">
            <column name="enabled_disco_monitor" type="boolean" defaultValue="false">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <sql>UPDATE dot11_monitored_networks SET enabled_disco_monitor = true WHERE disco_monitor_type = 'STATIC_THRESHOLD'</sql>
        <sql>
            UPDATE dot11_monitored_networks
            SET
                enabled_disco_monitor = false,
                disco_monitor_configuration = '{"threshold":100}',
                disco_monitor_type = 'STATIC_THRESHOLD'
            WHERE disco_monitor_type = 'NOOP'
        </sql>
    </changeSet>

    <changeSet id="update_disco_monitor_default_values" author="lennartkoopmann">
        <addDefaultValue tableName="dot11_monitored_networks"
                         columnName="disco_monitor_type"
                         defaultValue="STATIC_THRESHOLD" />

        <addDefaultValue tableName="dot11_monitored_networks"
                         columnName="disco_monitor_configuration"
                         defaultValue="{&quot;threshold&quot;:100}" />
    </changeSet>

    <changeSet id="add_pmf_mode_to_ssids" author="lennartkoopmann">
        <addColumn tableName="dot11_ssids">
            <column name="pmf_mode" type="varchar(16)" defaultValue="UNAVAILABLE">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="drop_ssid_pmf_mode_column" author="lennartkoopmann">
        <dropColumn tableName="dot11_ssids" columnName="pmf_mode" />
    </changeSet>

    <changeSet id="support_multiple_security_settings_per_reported_ssid" author="lennartkoopmann">
        <dropColumn tableName="dot11_ssids" columnName="is_wps" />
        <dropColumn tableName="dot11_ssids" columnName="security_protocol" />
        <dropColumn tableName="dot11_ssids" columnName="security_suites" />

        <createTable tableName="dot11_ssid_settings">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="ssid_id" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="attribute" type="varchar(24)">
                <constraints nullable="false" />
            </column>

            <column name="value" type="varchar(128)">
                <constraints nullable="false" />
            </column>
        </createTable>

        <addForeignKeyConstraint constraintName="link_settings2ssids"
                                 baseTableName="dot11_ssid_settings"
                                 baseColumnNames="ssid_id"
                                 referencedTableName="dot11_ssids"
                                 referencedColumnNames="id"
                                 onUpdate="NO ACTION"
                                 onDelete="CASCADE" />
    </changeSet>

    <changeSet id="make_ssid_settings_value_nullable" author="lennartkoopmann">
        <dropNotNullConstraint tableName="dot11_ssid_settings" columnName="value" />
    </changeSet>

    <changeSet id="make_ssid_settings_value_not_nullable_again" author="lennartkoopmann">
        <addNotNullConstraint tableName="dot11_ssid_settings" columnName="value" />
    </changeSet>

    <changeSet id="add_80211_client_signal_strength" author="lennartkoopmann">
        <addColumn tableName="dot11_clients">
            <column name="signal_strength_average" type="float" defaultValue="0">
                <constraints nullable="false" />
            </column>

            <column name="signal_strength_min" type="int" defaultValue="0">
                <constraints nullable="false" />
            </column>

            <column name="signal_strength_max" type="int" defaultValue="0">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_missing_bssid_80211_client_signal_strength" author="lennartkoopmann">
        <addColumn tableName="dot11_bssid_clients">
            <column name="signal_strength_average" type="float" defaultValue="0">
                <constraints nullable="false" />
            </column>

            <column name="signal_strength_min" type="int" defaultValue="0">
                <constraints nullable="false" />
            </column>

            <column name="signal_strength_max" type="int" defaultValue="0">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="fix_default_value_of_similar_sound_ssids" author="lennartkoopmann">
        <sql>
            UPDATE dot11_monitored_networks
            SET dconf_similar_looking_ssid_threshold = 95
            WHERE dconf_similar_looking_ssid_threshold IS NULL
        </sql>

        <addNotNullConstraint tableName="dot11_monitored_networks" columnName="dconf_similar_looking_ssid_threshold" />
    </changeSet>

    <changeSet id="add_similar_sounding_ssid_default_value" author="lennartkoopmann">
        <addDefaultValue tableName="dot11_monitored_networks"
                         columnName="dconf_similar_looking_ssid_threshold"
                         defaultValue="95" />
    </changeSet>

    <changeSet id="add_floorplan_structure" author="lennartkoopmann">
        <createTable tableName="auth_tenants_locations">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="uuid" type="uuid">
                <constraints unique="true" nullable="false" />
            </column>

            <column name="organization_id" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="tenant_id" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="name" type="varchar(128)">
                <constraints nullable="false" />
            </column>

            <column name="description" type="text">
                <constraints nullable="true" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="updated_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createTable tableName="auth_tenants_locations_floors">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="uuid" type="uuid">
                <constraints unique="true" nullable="false" />
            </column>

            <column name="location_id" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="number" type="integer">
                <constraints nullable="false" />
            </column>

            <column name="name" type="varchar(128)">
                <constraints nullable="false" />
            </column>

            <column name="plan" type="blob">
                <constraints nullable="false" />
            </column>

            <column name="plan_width" type="integer">
                <constraints nullable="false" />
            </column>

            <column name="plan_height" type="integer">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="updated_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>

        <addColumn tableName="taps">
            <column name="location_uuid" type="uuid">
                <constraints nullable="true" />
            </column>

            <column name="floor_uuid" type="uuid">
                <constraints nullable="true" />
            </column>

            <column name="floor_location_x" type="integer">
                <constraints nullable="true" />
            </column>

            <column name="floor_location_y" type="integer">
                <constraints nullable="true" />
            </column>
        </addColumn>

        <addForeignKeyConstraint constraintName="link_locations2tenants"
                                 baseTableName="auth_tenants_locations"
                                 baseColumnNames="tenant_id"
                                 referencedTableName="auth_tenants"
                                 referencedColumnNames="uuid"
                                 onUpdate="NO ACTION"
                                 onDelete="RESTRICT" />

        <addForeignKeyConstraint constraintName="link_floors2locations"
                                 baseTableName="auth_tenants_locations_floors"
                                 baseColumnNames="location_id"
                                 referencedTableName="auth_tenants_locations"
                                 referencedColumnNames="uuid"
                                 onUpdate="NO ACTION"
                                 onDelete="RESTRICT" />

    </changeSet>

    <changeSet id="make_floor_plan_parts_optional" author="lennartkoopmann">
        <dropNotNullConstraint tableName="auth_tenants_locations_floors" columnName="plan" />
        <dropNotNullConstraint tableName="auth_tenants_locations_floors" columnName="plan_width" />
        <dropNotNullConstraint tableName="auth_tenants_locations_floors" columnName="plan_height" />
    </changeSet>

    <changeSet id="make_floor_name_optional" author="lennartkoopmann">
        <dropNotNullConstraint tableName="auth_tenants_locations_floors" columnName="name" />
    </changeSet>

    <changeSet id="fix_floorplan_blob_type" author="lennartkoopmann">
        <dropColumn tableName="auth_tenants_locations_floors" columnName="plan" />
        <addColumn tableName="auth_tenants_locations_floors">
            <column name="plan" type="longblob">
                <constraints nullable="true" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_ssid_settings_indices" author="lennartkoopmann">
        <createIndex tableName="dot11_ssid_settings" indexName="ssid_lookup">
            <column name="ssid_id"></column>
        </createIndex>

        <createIndex tableName="dot11_ssid_settings" indexName="attribute_lookup">
            <column name="attribute"></column>
        </createIndex>
    </changeSet>

    <changeSet id="add_floor_path_loss_exponent" author="lennartkoopmann">
        <addColumn tableName="auth_tenants_locations_floors">
            <column name="path_loss_exponent" type="float" defaultValue="3.0">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>
    
    <changeSet id="add_and_rename_floor_plan_dimension_columns" author="lennartkoopmann">
        <renameColumn tableName="auth_tenants_locations_floors" oldColumnName="plan_width" newColumnName="plan_width_pixels" />
        <renameColumn tableName="auth_tenants_locations_floors" oldColumnName="plan_height" newColumnName="plan_height_pixels" />

        <addColumn tableName="auth_tenants_locations_floors">
            <column name="plan_width_meters" type="integer" defaultValue="0">
                <constraints nullable="false" />
            </column>
            <column name="plan_height_meters" type="integer" defaultValue="0">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="rename_floor_plan_dimension_columns_to_height" author="lennartkoopmann">
        <renameColumn tableName="auth_tenants_locations_floors" oldColumnName="plan_height_pixels" newColumnName="plan_length_pixels" />
        <renameColumn tableName="auth_tenants_locations_floors" oldColumnName="plan_height_meters" newColumnName="plan_length_meters" />
    </changeSet>
    
    <changeSet id="create_metrics_timers" author="lennartkoopmann">
        <createTable tableName="tap_metrics_timers">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="metric_name" type="varchar(128)">
                <constraints nullable="false" />
            </column>

            <column name="tap_uuid" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="mean" type="double">
                <constraints nullable="false" />
            </column>

            <column name="p99" type="double">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>
    </changeSet>
    
    <changeSet id="add_metrics_indices" author="lennartkoopmann">
        <createIndex tableName="tap_metrics_gauges" indexName="gauges_stdlookup">
            <column name="metric_name" />
            <column name="tap_uuid" />
            <column name="created_at" />
        </createIndex>

        <createIndex tableName="tap_metrics_timers" indexName="timers_stdlookup">
            <column name="metric_name" />
            <column name="tap_uuid" />
            <column name="created_at" />
        </createIndex>
    </changeSet>

    <changeSet id="turn_registry_into_text_fields" author="lennartkoopmann">
        <modifyDataType tableName="registry" columnName="value" newDataType="text" />
    </changeSet>
    
    <changeSet id="remove_unused_indices_2022041801" author="lennartkoopmann">
        <dropIndex tableName="context_mac_addresses" indexName="mac" />
        <dropIndex tableName="detection_alerts" indexName="detectionalerts_cs_compare" />
        <dropIndex tableName="dot11_bssids" indexName="bssids_bssid_lookup" />
        <dropIndex tableName="dot11_bssids" indexName="bssids_bssid_tapuuid" />
        <dropIndex tableName="taps" indexName="idx_taps_standard_lookup" />
    </changeSet>

    <changeSet id="create_tap_captures_frequencies" author="lennartkoopmann">
        <addColumn tableName="tap_captures">
            <column name="uuid" type="uuid" defaultValueComputed="gen_random_uuid()">
                <constraints nullable="false" unique="true" />
            </column>
        </addColumn>

        <createTable tableName="tap_captures_frequencies">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="interface_uuid" type="uuid" >
                <constraints nullable="false" />
            </column>

            <column name="frequency" type="integer" >
                <constraints nullable="false" />
            </column>

            <column name="channel_widths" type="text">
                <constraints nullable="false" />
            </column>
        </createTable>

        <addForeignKeyConstraint constraintName="link_freqs2captures"
                                 baseTableName="tap_captures_frequencies"
                                 baseColumnNames="interface_uuid"
                                 referencedTableName="tap_captures"
                                 referencedColumnNames="uuid"
                                 onUpdate="NO ACTION"
                                 onDelete="RESTRICT" />
    </changeSet>

    <changeSet id="add_cycle_time_to_tap_captures" author="lennartkoopmann">
        <addColumn tableName="tap_captures">
            <column name="cycle_time" type="integer">
                <constraints nullable="true" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="create_l4_sessions_table" author="lennartkoopmann">
        <createTable tableName="l4_sessions">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="tap_uuid" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="l4_type" type="varchar(3)">
                <constraints nullable="false" />
            </column>

            <column name="source_mac" type="varchar(17)">
                <constraints nullable="false" />
            </column>

            <column name="source_address" type="varchar(45)">
                <constraints nullable="false" />
            </column>

            <column name="source_port" type="integer">
                <constraints nullable="false" />
            </column>

            <column name="destination_mac" type="varchar(17)">
                <constraints nullable="false" />
            </column>

            <column name="destination_address" type="varchar(45)">
                <constraints nullable="false" />
            </column>

            <column name="destination_port" type="integer">
                <constraints nullable="false" />
            </column>

            <column name="bytes_count" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="segments_count" type="bigint">
                <constraints nullable="true" />
            </column>

            <column name="start_time" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="end_time" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="most_recent_segment_time" type="timestamp with time zone">
                <constraints nullable="true" />
            </column>

            <column name="state" type="varchar(32)">
                <constraints nullable="true" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>
    </changeSet>

    <changeSet id="add_session_key_to_l4_sessions" author="lennartkoopmann">
        <addColumn tableName="l4_sessions">
            <column name="session_key" type="varchar(64)">
                <constraints nullable="true" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="make_l4_end_time_nullable" author="lennartkoopmann">
        <dropNotNullConstraint tableName="l4_sessions" columnName="end_time" />
    </changeSet>

    <changeSet id="add_l4_oui_and_geo_info" author="lennartkoopmann">
        <addColumn tableName="l4_sessions">
            <column name="source_mac_oui" type="text">
                <constraints nullable="true" />
            </column>

            <column name="destination_mac_oui" type="text">
                <constraints nullable="true" />
            </column>

            <column name="source_address_geo_asn_number" type="integer">
                <constraints nullable="true" />
            </column>

            <column name="source_address_geo_asn_name" type="text">
                <constraints nullable="true" />
            </column>

            <column name="source_address_geo_asn_domain" type="text">
                <constraints nullable="true" />
            </column>

            <column name="source_address_geo_city" type="text">
                <constraints nullable="true" />
            </column>

            <column name="source_address_geo_country_code" type="varchar(2)">
                <constraints nullable="true" />
            </column>

            <column name="source_address_geo_country_name" type="text">
                <constraints nullable="true" />
            </column>

            <column name="source_address_geo_country_latitude" type="float">
                <constraints nullable="true" />
            </column>

            <column name="source_address_geo_country_longitude" type="float">
                <constraints nullable="true" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_missing_l4_oui_and_geo_info" author="lennartkoopmann">
        <addColumn tableName="l4_sessions">
            <column name="destination_address_geo_asn_number" type="integer">
                <constraints nullable="true" />
            </column>

            <column name="destination_address_geo_asn_name" type="text">
                <constraints nullable="true" />
            </column>

            <column name="destination_address_geo_asn_domain" type="text">
                <constraints nullable="true" />
            </column>

            <column name="destination_address_geo_city" type="text">
                <constraints nullable="true" />
            </column>

            <column name="destination_address_geo_country_code" type="varchar(2)">
                <constraints nullable="true" />
            </column>

            <column name="destination_address_geo_country_name" type="text">
                <constraints nullable="true" />
            </column>

            <column name="destination_address_geo_country_latitude" type="float">
                <constraints nullable="true" />
            </column>

            <column name="destination_address_geo_country_longitude" type="float">
                <constraints nullable="true" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="remove_redundant_l4_fields" author="lennartkoopmann">
        <dropColumn tableName="l4_sessions" columnName="source_mac_oui" />
        <dropColumn tableName="l4_sessions" columnName="destination_mac_oui" />
        <dropColumn tableName="l4_sessions" columnName="source_address_geo_country_name" />
        <dropColumn tableName="l4_sessions" columnName="destination_address_geo_country_name" />
    </changeSet>

    <changeSet id="remove_base_configuration" author="lennartkoopmann">
        <dropTable tableName="base_configuration" />
    </changeSet>

    <changeSet id="add_l4_private_address_identifiers" author="lennartkoopmann">
        <addColumn tableName="l4_sessions">
            <column name="source_address_is_private" type="boolean">
                <constraints nullable="false" />
            </column>

            <column name="destination_address_is_private" type="boolean">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_dns_pair_geo_info" author="lennartkoopmann">
        <addColumn tableName="dns_pairs">
            <column name="server_geo_asn_number" type="integer">
                <constraints nullable="true" />
            </column>

            <column name="server_geo_asn_name" type="text">
                <constraints nullable="true" />
            </column>

            <column name="server_geo_asn_domain" type="text">
                <constraints nullable="true" />
            </column>

            <column name="server_geo_city" type="text">
                <constraints nullable="true" />
            </column>

            <column name="server_geo_country_code" type="varchar(2)">
                <constraints nullable="true" />
            </column>

            <column name="server_geo_latitude" type="float">
                <constraints nullable="true" />
            </column>

            <column name="server_geo_longitude" type="float">
                <constraints nullable="true" />
            </column>
        </addColumn>
    </changeSet>
    
    <changeSet id="rename_l4_geo_fields" author="lennartkoopmann">
        <renameColumn tableName="l4_sessions" oldColumnName="source_address_geo_country_latitude" newColumnName="source_address_geo_latitude" />
        <renameColumn tableName="l4_sessions" oldColumnName="source_address_geo_country_longitude" newColumnName="source_address_geo_longitude" />
        <renameColumn tableName="l4_sessions" oldColumnName="destination_address_geo_country_latitude" newColumnName="destination_address_geo_latitude" />
        <renameColumn tableName="l4_sessions" oldColumnName="destination_address_geo_country_longitude" newColumnName="destination_address_geo_longitude" />
    </changeSet>

    <changeSet id="remove_dns_nxdomains_log" author="lennartkoopmann">
        <dropTable tableName="dns_nxdomains_log" />
    </changeSet>

    <changeSet id="add_dns_log" author="lennartkoopmann">
        <createTable tableName="dns_log">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="uuid" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="tap_uuid" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="transaction_id" type="integer">
                <constraints nullable="false" />
            </column>

            <column name="source_address" type="varchar(45)">
                <constraints nullable="false" />
            </column>

            <column name="source_port" type="integer">
                <constraints nullable="false" />
            </column>

            <column name="source_mac" type="varchar(17)">
                <constraints nullable="false" />
            </column>

            <column name="destination_address" type="varchar(45)">
                <constraints nullable="false" />
            </column>

            <column name="destination_port" type="integer">
                <constraints nullable="false" />
            </column>

            <column name="destination_mac" type="varchar(17)">
                <constraints nullable="false" />
            </column>

            <column name="data_value" type="text">
                <constraints nullable="false" />
            </column>

            <column name="data_type" type="varchar(24)">
                <constraints nullable="false" />
            </column>

            <column name="timestamp" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>
    </changeSet>

    <changeSet id="rename_dns_log_ip_server_field_names" author="lennartkoopmann">
        <renameColumn tableName="dns_log" oldColumnName="source_address" newColumnName="client_address" />
        <renameColumn tableName="dns_log" oldColumnName="destination_address" newColumnName="server_address" />
        <renameColumn tableName="dns_log" oldColumnName="source_port" newColumnName="client_port" />
        <renameColumn tableName="dns_log" oldColumnName="destination_port" newColumnName="server_port" />
        <renameColumn tableName="dns_log" oldColumnName="source_mac" newColumnName="client_mac" />
        <renameColumn tableName="dns_log" oldColumnName="destination_mac" newColumnName="server_mac" />
    </changeSet>

    <changeSet id="make_dns_log_transaction_id_nullable" author="lennartkoopmann">
        <dropNotNullConstraint tableName="dns_log" columnName="transaction_id" />
    </changeSet>

    <changeSet id="add_dns_type_to_dns_log" author="lennartkoopmann">
        <addColumn tableName="dns_log">
            <column name="dns_type" type="varchar(12)">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>
    
    <changeSet id="add_dns_entropy_log" author="lennartkoopmann">
        <createTable tableName="dns_entropy_log">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="transaction_id" type="integer">
                <constraints nullable="false" />
            </column>

            <column name="entropy" type="float">
                <constraints nullable="false" />
            </column>

            <column name="zscore" type="float">
                <constraints nullable="false" />
            </column>

            <column name="timestamp" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>
    </changeSet>

    <changeSet id="add_entropy_mean_to_dns_entropy_log" author="lennartkoopmann">
        <addColumn tableName="dns_entropy_log">
            <column name="entropy_mean" type="float">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_tap_uuid_to_dns_entropy_log" author="lennartkoopmann">
        <addColumn tableName="dns_entropy_log">
            <column name="tap_uuid" type="uuid">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_data_value_domain_to_dns_log" author="lennartkoopmann">
        <addColumn tableName="dns_log">
            <column name="data_value_domain" type="text">
                <constraints nullable="true" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="rename_dns_log_domain_to_etld" author="lennartkoopmann">
        <renameColumn tableName="dns_log" oldColumnName="data_value_domain" newColumnName="data_value_etld" />
    </changeSet>

    <changeSet id="add_socks_tunnels" author="lennartkoopmann">
        <createTable tableName="socks_tunnels">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="uuid" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="tap_uuid" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="tcp_session_key" type="varchar(64)">
                <constraints nullable="true" />
            </column>

            <column name="socks_type" type="varchar(10)">
                <constraints nullable="false" />
            </column>

            <column name="authentication_status" type="varchar(24)">
                <constraints nullable="false" />
            </column>

            <column name="handshake_status" type="varchar(24)">
                <constraints nullable="false" />
            </column>

            <column name="connection_status" type="varchar(24)">
                <constraints nullable="false" />
            </column>

            <column name="username" type="text">
                <constraints nullable="true" />
            </column>

            <column name="tunneled_bytes" type="varchar(24)">
                <constraints nullable="false" />
            </column>

            <column name="tunneled_destination_address" type="varchar(45)">
                <constraints nullable="true" />
            </column>

            <column name="tunneled_destination_host" type="text">
                <constraints nullable="true" />
            </column>

            <column name="tunneled_destination_port" type="integer">
                <constraints nullable="false" />
            </column>

            <column name="established_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="terminated_at" type="timestamp with time zone">
                <constraints nullable="true" />
            </column>

            <column name="updated_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>
    </changeSet>

    <changeSet id="add_most_recent_segment_time_to_socks_tunnels" author="lennart koopmann">
        <addColumn tableName="socks_tunnels">
            <column name="most_recent_segment_time" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="make_socks_sesion_key_not_nullable" author="lennart koopmann">
        <dropNotNullConstraint tableName="socks_tunnels" columnName="tcp_session_key" />
    </changeSet>

    <changeSet id="add_ssh_sessions" author="lennartkoopmann">
        <createTable tableName="ssh_sessions">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="uuid" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="tap_uuid" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="tcp_session_key" type="varchar(64)">
                <constraints nullable="false" />
            </column>

            <column name="client_version_version" type="text">
                <constraints nullable="false" />
            </column>

            <column name="client_version_software" type="text">
                <constraints nullable="false" />
            </column>

            <column name="client_version_comments" type="text">
                <constraints nullable="true" />
            </column>

            <column name="server_version_version" type="text">
                <constraints nullable="false" />
            </column>

            <column name="server_version_software" type="text">
                <constraints nullable="false" />
            </column>

            <column name="server_version_comments" type="text">
                <constraints nullable="true" />
            </column>

            <column name="connection_status" type="varchar(24)">
                <constraints nullable="false" />
            </column>

            <column name="tunneled_bytes" type="varchar(24)">
                <constraints nullable="false" />
            </column>

            <column name="established_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="terminated_at" type="timestamp with time zone">
                <constraints nullable="true" />
            </column>

            <column name="most_recent_segment_time" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="updated_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>
    </changeSet>

    <changeSet id="change_and_add_port_to_dns_pairs" author="lennartkoopmann">
        <renameColumn tableName="dns_pairs" oldColumnName="ip" newColumnName="client_address" />
        <renameColumn tableName="dns_pairs" oldColumnName="server" newColumnName="server_address" />

        <addColumn tableName="dns_pairs">
            <column name="server_port" type="integer" defaultValue="53">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_bluetooth_devices" author="lennartkoopmann">
        <createTable tableName="bluetooth_devices">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="uuid" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="tap_uuid" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="mac" type="varchar(17)">
                <constraints nullable="false" />
            </column>

            <column name="alias" type="text">
                <constraints nullable="false" />
            </column>

            <column name="device" type="text">
                <constraints nullable="false" />
            </column>

            <column name="transport" type="text">
                <constraints nullable="false" />
            </column>

            <column name="name" type="text">
                <constraints nullable="true" />
            </column>

            <column name="rssi" type="integer">
                <constraints nullable="true" />
            </column>

            <column name="company_id" type="integer">
                <constraints nullable="true" />
            </column>

            <column name="class_number" type="integer">
                <constraints nullable="true" />
            </column>

            <column name="appearance" type="integer">
                <constraints nullable="true" />
            </column>

            <column name="modalias" type="text">
                <constraints nullable="true" />
            </column>

            <column name="tx_power" type="integer">
                <constraints nullable="true" />
            </column>

            <column name="manufacturer_data" type="text">
                <constraints nullable="true" />
            </column>

            <column name="uuids" type="text">
                <constraints nullable="true" />
            </column>

            <column name="service_data" type="text">
                <constraints nullable="true" />
            </column>

            <column name="last_seen" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>
    </changeSet>

    <changeSet id="add_l4_session_attributes_20240731" author="lennartkoopmann">
        <renameColumn tableName="l4_sessions" oldColumnName="source_address_is_private" newColumnName="source_address_is_site_local" />
        <renameColumn tableName="l4_sessions" oldColumnName="destination_address_is_private" newColumnName="destination_address_is_site_local" />

        <addColumn tableName="l4_sessions">
            <column name="source_address_is_multicast" type="boolean" defaultValue="false">
                <constraints nullable="false" />
            </column>

            <column name="destination_address_is_multicast" type="boolean" defaultValue="false">
                <constraints nullable="false" />
            </column>

            <column name="source_address_is_loopback" type="boolean" defaultValue="false">
                <constraints nullable="false" />
            </column>

            <column name="destination_address_is_loopback" type="boolean" defaultValue="false">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_additional_dns_server_attributes_to_pairs_20240731" author="lennartkoopmann">
        <addColumn tableName="dns_pairs">
            <column name="server_is_private" type="boolean" defaultValue="false">
                <constraints nullable="false" />
            </column>

            <column name="server_is_multicast" type="boolean" defaultValue="false">
                <constraints nullable="false" />
            </column>

            <column name="server_is_loopback" type="boolean" defaultValue="false">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="rename_dns_server_attributes_in_pairs_20240731" author="lennartkoopmann">
        <renameColumn tableName="dns_pairs" oldColumnName="server_geo_asn_number" newColumnName="server_address_geo_asn_number" />
        <renameColumn tableName="dns_pairs" oldColumnName="server_geo_asn_name" newColumnName="server_address_geo_asn_name" />
        <renameColumn tableName="dns_pairs" oldColumnName="server_geo_asn_domain" newColumnName="server_address_geo_asn_domain" />
        <renameColumn tableName="dns_pairs" oldColumnName="server_geo_city" newColumnName="server_address_geo_city" />
        <renameColumn tableName="dns_pairs" oldColumnName="server_geo_country_code" newColumnName="server_address_geo_country_code" />
        <renameColumn tableName="dns_pairs" oldColumnName="server_geo_latitude" newColumnName="server_address_geo_latitude" />
        <renameColumn tableName="dns_pairs" oldColumnName="server_geo_longitude" newColumnName="server_address_geo_longitude" />

        <renameColumn tableName="dns_pairs" oldColumnName="server_is_private" newColumnName="server_address_is_private" />
        <renameColumn tableName="dns_pairs" oldColumnName="server_is_multicast" newColumnName="server_address_is_multicast" />
        <renameColumn tableName="dns_pairs" oldColumnName="server_is_loopback" newColumnName="server_address_is_loopback" />
    </changeSet>

    <changeSet id="rename_dns_server_pairs_private_address" author="lennartkoopmann">
        <renameColumn tableName="dns_pairs" oldColumnName="server_address_is_private" newColumnName="server_address_is_site_local" />
    </changeSet>

    <changeSet id="make_dns_log_fields_inet" author="lennartkoopmann">
        <modifyDataType tableName="dns_log" columnName="client_address" newDataType="inet" />
        <modifyDataType tableName="dns_log" columnName="server_address" newDataType="inet" />
    </changeSet>

    <changeSet id="make_more_ip_address_fields_inet" author="lennartkoopmann">
        <modifyDataType tableName="dns_pairs" columnName="client_address" newDataType="inet" />
        <modifyDataType tableName="dns_pairs" columnName="server_address" newDataType="inet" />

        <modifyDataType tableName="dns_statistics" columnName="ip" newDataType="inet" />

        <modifyDataType tableName="socks_tunnels" columnName="tunneled_destination_address" newDataType="inet" />

        <modifyDataType tableName="l4_sessions" columnName="source_address" newDataType="inet" />
        <modifyDataType tableName="l4_sessions" columnName="destination_address" newDataType="inet" />
    </changeSet>

    <changeSet id="add_geo_fields_to_dns_log" author="lennartkoopmann">
        <addColumn tableName="dns_log">
            <column name="client_address_geo_asn_number" type="integer">
                <constraints nullable="true" />
            </column>

            <column name="client_address_geo_asn_name" type="text">
                <constraints nullable="true" />
            </column>

            <column name="client_address_geo_asn_domain" type="text">
                <constraints nullable="true" />
            </column>

            <column name="client_address_geo_city" type="text">
                <constraints nullable="true" />
            </column>

            <column name="client_address_geo_country_code" type="varchar(2)">
                <constraints nullable="true" />
            </column>

            <column name="client_address_geo_latitude" type="float">
                <constraints nullable="true" />
            </column>

            <column name="client_address_geo_longitude" type="float">
                <constraints nullable="true" />
            </column>

            <column name="client_address_is_private" type="boolean" defaultValue="false">
                <constraints nullable="false" />
            </column>

            <column name="client_address_is_multicast" type="boolean" defaultValue="false">
                <constraints nullable="false" />
            </column>

            <column name="client_address_is_loopback" type="boolean" defaultValue="false">
                <constraints nullable="false" />
            </column>

            <column name="server_address_geo_asn_number" type="integer">
                <constraints nullable="true" />
            </column>

            <column name="server_address_geo_asn_name" type="text">
                <constraints nullable="true" />
            </column>

            <column name="server_address_geo_asn_domain" type="text">
                <constraints nullable="true" />
            </column>

            <column name="server_address_geo_city" type="text">
                <constraints nullable="true" />
            </column>

            <column name="server_address_geo_country_code" type="varchar(2)">
                <constraints nullable="true" />
            </column>

            <column name="server_address_geo_latitude" type="float">
                <constraints nullable="true" />
            </column>

            <column name="server_address_geo_longitude" type="float">
                <constraints nullable="true" />
            </column>

            <column name="server_address_is_private" type="boolean" defaultValue="false">
                <constraints nullable="false" />
            </column>

            <column name="server_address_is_multicast" type="boolean" defaultValue="false">
                <constraints nullable="false" />
            </column>

            <column name="server_address_is_loopback" type="boolean" defaultValue="false">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="rename_dns_log_site_local_fields" author="lennart koopmann">
        <renameColumn tableName="dns_log" oldColumnName="server_address_is_private" newColumnName="server_address_is_site_local" />
        <renameColumn tableName="dns_log" oldColumnName="client_address_is_private" newColumnName="client_address_is_site_local" />
    </changeSet>
    
    <changeSet id="add_new_indices_20240804" author="lennartkoopmann">
        <createIndex tableName="dns_log" indexName="dns_log_lookup_timestamp">
            <column name="timestamp" />
        </createIndex>
        <createIndex tableName="dns_log" indexName="dns_log_filter_tap">
            <column name="tap_uuid" />
        </createIndex>
        <createIndex tableName="dns_log" indexName="dns_log_lookup_transaction">
            <column name="transaction_id" />
        </createIndex>
        
        <createIndex tableName="l4_sessions" indexName="l4_sessions_lookup_timestamp">
            <column name="most_recent_segment_time" />
        </createIndex>
        <createIndex tableName="l4_sessions" indexName="l4_sessions_lookup_session_key">
            <column name="session_key" />
        </createIndex>
        <createIndex tableName="l4_sessions" indexName="l4_sessions_filter_type">
            <column name="l4_type" />
        </createIndex>
        <createIndex tableName="l4_sessions" indexName="l4_sessions_filter_tap">
            <column name="tap_uuid" />
        </createIndex>

        <createIndex tableName="socks_tunnels" indexName="socks_tunnels_lookup_timestamp">
            <column name="most_recent_segment_time" />
        </createIndex>
        <createIndex tableName="socks_tunnels" indexName="socks_tunnels_filter_tap">
            <column name="tap_uuid" />
        </createIndex>

        <createIndex tableName="ssh_sessions" indexName="ssh_sessions_lookup_timestamp">
            <column name="most_recent_segment_time" />
        </createIndex>
        <createIndex tableName="ssh_sessions" indexName="ssh_sessions_filter_tap">
            <column name="tap_uuid" />
        </createIndex>

        <createIndex tableName="bluetooth_devices" indexName="bluetooth_devices_lookup_timestamp">
            <column name="last_seen" />
        </createIndex>
        <createIndex tableName="bluetooth_devices" indexName="bluetooth_devices_filter_tap">
            <column name="tap_uuid" />
        </createIndex>
    </changeSet>

    <changeSet id="fix_tap_freq_cascade_delete" author="lennartkoopmann">
        <dropForeignKeyConstraint baseTableName="tap_captures_frequencies" constraintName="link_freqs2captures" />
        <addForeignKeyConstraint constraintName="link_freqs2captures"
                                 baseTableName="tap_captures_frequencies"
                                 baseColumnNames="interface_uuid"
                                 referencedTableName="tap_captures"
                                 referencedColumnNames="uuid"
                                 onUpdate="NO ACTION"
                                 onDelete="CASCADE" />
    </changeSet>
    
    <changeSet id="add_mac_address_randomized_field_to_clients" author="lennartkoopmann">
        <addColumn tableName="dot11_clients">
            <column name="client_mac_is_randomized" type="boolean" defaultValue="false">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_tags_too_bluetooth_devices" author="lennartkoopmann">
        <addColumn tableName="bluetooth_devices">
            <column name="tags" type="jsonb">
                <constraints nullable="true" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="create_dot11_monitored_probereqs" author="lennartkoopmann">
        <createTable tableName="dot11_monitored_probereqs">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="uuid" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="organization_id" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="tenant_id" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="ssid" type="varchar(255)">
                <constraints nullable="false" />
            </column>

            <column name="notes" type="text">
                <constraints nullable="true" />
            </column>

            <column name="updated_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>
    </changeSet>
    
    <changeSet id="add_transparent_context" author="lennartkoopmann">
        <dropNotNullConstraint tableName="context_mac_addresses" columnName="name" />
    </changeSet>

    <changeSet id="add_transparent_context_fields" author="lennartkoopmann">
        <addColumn tableName="context_mac_addresses">
            <column name="hostnames" type="jsonb">
                <constraints nullable="true" />
            </column>

            <column name="ip_addresses" type="jsonb">
                <constraints nullable="true" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="create_own_table_for_transparent_context" author="lennartkoopmann">
        <dropColumn tableName="context_mac_addresses" columnName="hostnames" />
        <dropColumn tableName="context_mac_addresses" columnName="ip_addresses" />

        <createTable tableName="context_mac_addresses_transparent">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="context_id" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="tap_uuid" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="type" type="varchar(24)">
                <constraints nullable="false" />
            </column>

            <column name="ip_address" type="inet">
                <constraints nullable="true" />
            </column>

            <column name="hostname" type="text">
                <constraints nullable="true" />
            </column>

            <column name="updated_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>

        <addForeignKeyConstraint constraintName="link_macctx2transp"
                                 baseTableName="context_mac_addresses_transparent"
                                 baseColumnNames="context_id"
                                 referencedTableName="context_mac_addresses"
                                 referencedColumnNames="id"
                                 onUpdate="NO ACTION"
                                 onDelete="CASCADE" />
    </changeSet>

    <changeSet id="add_source_to_transparent_mac_address_context" author="lennartkoopmann">
        <addColumn tableName="context_mac_addresses_transparent">
            <column name="source" type="varchar(24)">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="rename_transparent_updated_to_last_seen" author="lennartkoopmann">
        <renameColumn tableName="context_mac_addresses_transparent" oldColumnName="updated_at" newColumnName="last_seen" />
    </changeSet>

    <changeSet id="create_dot11_known_networks" author="lennartkoopmann">
        <createTable tableName="dot11_known_networks">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="uuid" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="ssid" type="varchar(32)">
                <constraints nullable="false" />
            </column>

            <column name="is_approved" type="boolean">
                <constraints nullable="false" />
            </column>

            <column name="organization_id" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="tenant_id" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="first_seen" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="last_seen" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>
    </changeSet>

    <changeSet id="add_organization_and_tenant_to_registry" author="lennartkoopmann">
        <addColumn tableName="registry">
            <column name="organization_id" type="uuid">
                <constraints nullable="true" />
            </column>

            <column name="tenant_id" type="uuid">
                <constraints nullable="true" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_ignore_field_to_known_networks" author="lennartkoopmann">
        <addColumn tableName="dot11_known_networks">
            <column name="is_ignored" type="boolean" defaultValue="false">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_default_selected_tenant_and_org_to_users" author="lennartkoopmann">
        <addColumn tableName="auth_users">
            <column name="default_organization" type="uuid">
                <constraints nullable="true" />
            </column>

            <column name="default_tenant" type="uuid">
                <constraints nullable="true" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_client_monitoring_config_fields" author="lennartkoopmann">
        <addColumn tableName="dot11_monitored_networks">
            <column name="enabled_client_monitoring" type="boolean" defaultValue="false">
                <constraints nullable="false" />
            </column>

            <column name="enabled_client_eventing" type="boolean" defaultValue="false">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="create_dot11_known_clients" author="lennartkoopmann">
        <createTable tableName="dot11_known_clients">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="uuid" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="mac" type="varchar(32)">
                <constraints nullable="false" />
            </column>

            <column name="is_approved" type="boolean">
                <constraints nullable="false" />
            </column>

            <column name="is_ignored" type="boolean">
                <constraints nullable="false" />
            </column>

            <column name="monitored_network_id" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="first_seen" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="last_seen" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>

        <addForeignKeyConstraint constraintName="link_clients2networks"
                                 baseTableName="dot11_known_clients"
                                 baseColumnNames="monitored_network_id"
                                 referencedTableName="dot11_monitored_networks"
                                 referencedColumnNames="id"
                                 onUpdate="NO ACTION"
                                 onDelete="CASCADE" />

        <createIndex tableName="dot11_known_clients" indexName="known_clients_mac">
            <column name="mac" />
        </createIndex>
    </changeSet>

    <changeSet id="make_mac_addresses_optional" author="lennartkoopmann">
        <dropNotNullConstraint tableName="l4_sessions" columnName="source_mac" />
        <dropNotNullConstraint tableName="l4_sessions" columnName="destination_mac" />

        <dropNotNullConstraint tableName="dns_log" columnName="client_mac" />
        <dropNotNullConstraint tableName="dns_log" columnName="server_mac" />
    </changeSet>

    <changeSet id="move_retention_config_to_tenants" author="lennartkoopmann">
        <sql>
            WITH registry_entries AS (
                SELECT key, value FROM registry
                WHERE key IN (
                    'core.ethernet_l4_retention_time_days',
                    'core.ethernet_dns_retention_time_days',
                    'core.ethernet_arp_retention_time_days',
                    'core.dot11_retention_time_days',
                    'core.bluetooth_retention_time_days'
                    ) AND value &lt;&gt; '7'
            )
            INSERT INTO registry (organization_id, tenant_id, key, value)
            SELECT
                t.organization_id,
                t.uuid AS tenant_id,
                reg.key,
                reg.value
            FROM auth_tenants t
            JOIN registry_entries reg ON TRUE
            ON CONFLICT DO NOTHING;
        </sql>
    </changeSet>

    <changeSet id="delete_global_retention_config" author="lennartkoopmann">
        <sql>
            DELETE FROM registry WHERE key IN (
                'core.ethernet_l4_retention_time_days',
                'core.ethernet_dns_retention_time_days',
                'core.ethernet_arp_retention_time_days',
                'core.dot11_retention_time_days',
                'core.bluetooth_retention_time_days'
            ) AND organization_id IS NULL AND tenant_id IS NULL;
        </sql>
    </changeSet>

    <changeSet id="extend_mac_context_uniqueness" author="lennartkoopmann">
        <dropUniqueConstraint tableName="context_mac_addresses" constraintName="context_mac_addresses_mac_address_key" />
        <addUniqueConstraint tableName="context_mac_addresses" columnNames="mac_address, organization_id, tenant_id" />
    </changeSet>

    <changeSet id="add_uavs" author="lennartkoopmann">
        <createTable tableName="uavs">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="tap_uuid" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="uuid" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="uav_type" type="text">
                <constraints nullable="false" />
            </column>

            <column name="detection_source" type="text">
                <constraints nullable="false" />
            </column>

            <column name="first_seen" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="last_seen" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>
    </changeSet>

    <changeSet id="add_rssi_average_to_uavs" author="lennartkoopmann">
        <addColumn tableName="uavs">
            <column name="rssi_average" type="double">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="rename_uav_uuid_to_identifier" author="lennartkoopmann">
        <renameColumn tableName="uavs" oldColumnName="uuid" newColumnName="identifier" />
    </changeSet>

    <changeSet id="change_type_of_uav_identifier" author="lennartkoopmann">
        <modifyDataType tableName="uavs" columnName="identifier" newDataType="text" />
    </changeSet>
    
    <changeSet id="add_uav_fields" author="lennart koopmann">
        <addColumn tableName="uavs">
            <column name="operational_status" type="text">
                <constraints nullable="true" />
            </column>

            <column name="latitude" type="double">
                <constraints nullable="true" />
            </column>

            <column name="longitude" type="double">
                <constraints nullable="true" />
            </column>

            <column name="ground_track" type="integer">
                <constraints nullable="true" />
            </column>

            <column name="speed" type="double">
                <constraints nullable="true" />
            </column>

            <column name="vertical_speed" type="double">
                <constraints nullable="true" />
            </column>

            <column name="altitude_pressure" type="double">
                <constraints nullable="true" />
            </column>

            <column name="altitude_geodetic" type="double">
                <constraints nullable="true" />
            </column>

            <column name="height_type" type="text">
                <constraints nullable="true" />
            </column>

            <column name="height" type="double">
                <constraints nullable="true" />
            </column>

            <column name="accuracy_horizontal" type="integer">
                <constraints nullable="true" />
            </column>

            <column name="accuracy_vertical" type="integer">
                <constraints nullable="true" />
            </column>

            <column name="accuracy_barometer" type="integer">
                <constraints nullable="true" />
            </column>

            <column name="accuracy_speed" type="integer">
                <constraints nullable="true" />
            </column>

            <column name="operator_location_type" type="text">
                <constraints nullable="true" />
            </column>

            <column name="operator_latitude" type="double">
                <constraints nullable="true" />
            </column>

            <column name="operator_longitude" type="double">
                <constraints nullable="true" />
            </column>

            <column name="operator_altitude" type="double">
                <constraints nullable="true" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_uav_base_migrations" author="lennartkoopmann">
        <createIndex tableName="uavs" indexName="uavs_tap_uuid">
            <column name="tap_uuid" />
        </createIndex>

        <createIndex tableName="uavs" indexName="uavs_identifier">
            <column name="identifier" />
        </createIndex>

        <createIndex tableName="uavs" indexName="uavs_detection_source">
            <column name="detection_source" />
        </createIndex>

        <createIndex tableName="uavs" indexName="uavs_last_seen">
            <column name="last_seen" />
        </createIndex>
    </changeSet>

    <changeSet id="create_uav_vectors" author="lennartkoopmann">
        <createTable tableName="uavs_vectors">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="uav_id" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="operational_status" type="text">
                <constraints nullable="true" />
            </column>

            <column name="latitude" type="double">
                <constraints nullable="true" />
            </column>

            <column name="longitude" type="double">
                <constraints nullable="true" />
            </column>

            <column name="ground_track" type="integer">
                <constraints nullable="true" />
            </column>

            <column name="speed" type="double">
                <constraints nullable="true" />
            </column>

            <column name="vertical_speed" type="double">
                <constraints nullable="true" />
            </column>

            <column name="altitude_pressure" type="double">
                <constraints nullable="true" />
            </column>

            <column name="altitude_geodetic" type="double">
                <constraints nullable="true" />
            </column>

            <column name="height_type" type="text">
                <constraints nullable="true" />
            </column>

            <column name="height" type="double">
                <constraints nullable="true" />
            </column>

            <column name="accuracy_horizontal" type="integer">
                <constraints nullable="true" />
            </column>

            <column name="accuracy_vertical" type="integer">
                <constraints nullable="true" />
            </column>

            <column name="accuracy_barometer" type="integer">
                <constraints nullable="true" />
            </column>

            <column name="accuracy_speed" type="integer">
                <constraints nullable="true" />
            </column>

            <column name="timestamp" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>

        <addForeignKeyConstraint constraintName="link_vectors2uavs"
                                 baseTableName="uavs_vectors"
                                 baseColumnNames="uav_id"
                                 referencedTableName="uavs"
                                 referencedColumnNames="id"
                                 onUpdate="NO ACTION"
                                 onDelete="CASCADE" />

        <createIndex tableName="uavs_vectors" indexName="uavs_vectors_timestamp">
            <column name="timestamp" />
        </createIndex>
    </changeSet>

    <changeSet id="change_uav_vector_relation" author="lennartkoopmann">
        <dropForeignKeyConstraint baseTableName="uavs_vectors" constraintName="link_vectors2uavs" />
        <dropColumn tableName="uavs_vectors" columnName="uav_id" />

        <addColumn tableName="uavs_vectors">
            <column name="uav_identifier" type="text">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addUniqueConstraint tableName="uavs" columnNames="identifier" />

        <addForeignKeyConstraint constraintName="link_vectors2uavs"
                                 baseTableName="uavs_vectors"
                                 baseColumnNames="uav_identifier"
                                 referencedTableName="uavs"
                                 referencedColumnNames="identifier"
                                 onUpdate="NO ACTION"
                                 onDelete="CASCADE" />
    </changeSet>
    
    <changeSet id="add_uav_serial_ids" author="lennartkoopmann">
        <addColumn tableName="uavs">
            <column name="id_serial" type="text">
                <constraints nullable="true" />
            </column>

            <column name="id_registration" type="text">
                <constraints nullable="true" />
            </column>

            <column name="id_utm" type="text">
                <constraints nullable="true" />
            </column>

            <column name="id_session" type="text">
                <constraints nullable="true" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_uav_designation" author="lennartkoopmann">
        <addColumn tableName="uavs">
            <column name="designation" type="text" value="NONE">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_uav_operator_id" author="lennartkoopmann">
        <addColumn tableName="uavs">
            <column name="operator_id" type="text">
                <constraints nullable="true" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_latest_uav_vector_and_operator_timestamps" author="lennartkoopmann">
        <addColumn tableName="uavs">
            <column name="latest_vector_timestamp" type="timestamp with time zone">
                <constraints nullable="true" />
            </column>

            <column name="latest_operator_location_timestamp" type="timestamp with time zone">
                <constraints nullable="true" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_uav_classification" author="lennartkoopmann">
        <addColumn tableName="uavs">
            <column name="classification" type="text" value="UNKNOWN">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>
    
    <changeSet id="change_uav_vector_relation_to_id" author="lennartkoopmann">
        <dropForeignKeyConstraint baseTableName="uavs_vectors" constraintName="link_vectors2uavs" />
        <dropUniqueConstraint tableName="uavs" constraintName="uavs_identifier_key" />

        <sql>DELETE FROM uavs_vectors;</sql>

        <dropColumn tableName="uavs_vectors" columnName="uav_identifier" />
        <addColumn tableName="uavs_vectors">
            <column name="uav_id" type="bigint">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addForeignKeyConstraint constraintName="link_vectors2uavs"
                                 baseTableName="uavs_vectors"
                                 baseColumnNames="uav_id"
                                 referencedTableName="uavs"
                                 referencedColumnNames="id"
                                 onUpdate="NO ACTION"
                                 onDelete="CASCADE" />
    </changeSet>

    <changeSet id="add_uav_classifications_table" author="lennartkoopmann">
        <dropColumn tableName="uavs" columnName="classification" />

        <createTable tableName="uavs_classifications">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="uav_identifier" type="text">
                <constraints nullable="false" unique="true" />
            </column>

            <column name="classification" type="text" value="UNKNOWN">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createIndex tableName="uavs_classifications" indexName="uavs_classifications_identifier">
            <column name="uav_identifier" />
        </createIndex>

        <!-- no foreign key constraint required. also, we want to keep the classification after the UAV is
        deleted/cleaned, so no cascade delete required either. -->
    </changeSet>

    <changeSet id="add_tenant_information_to_uav_classifications" author="lennartkoopmann">
        <addColumn tableName="uavs_classifications">
            <column name="organization_id" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="tenant_id" type="uuid">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>
    
    <changeSet id="add_uav_classification_compound_uniqueness" author="lennartkoopmann">
        <dropUniqueConstraint tableName="uavs_classifications" constraintName="uavs_classifications_uav_identifier_key" />
        <addUniqueConstraint tableName="uavs_classifications" columnNames="uav_identifier, organization_id, tenant_id" />
    </changeSet>

    <changeSet id="split_uav_taps" author="lennartkoopmann">
        <sql>DELETE FROM uavs;</sql>

        <dropColumn tableName="uavs" columnName="tap_uuid" />

        <createTable tableName="uavs_taps">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="uav_id" type="bigint">
                <constraints nullable="false" unique="true" />
            </column>

            <column name="tap_uuid" type="uuid">
                <constraints nullable="false" />
            </column>
        </createTable>

        <addUniqueConstraint tableName="uavs_taps" columnNames="uav_id, tap_uuid" />

        <addForeignKeyConstraint constraintName="link_taps2uavs"
                                 baseTableName="uavs_taps"
                                 baseColumnNames="uav_id"
                                 referencedTableName="uavs"
                                 referencedColumnNames="id"
                                 onUpdate="NO ACTION"
                                 onDelete="CASCADE" />
    </changeSet>

    <changeSet id="introduce_uav_identifier_uniqueness" author="lennartkoopmann">
        <sql>DELETE FROM uavs;</sql>
        <addUniqueConstraint tableName="uavs" columnNames="identifier" />
    </changeSet>

    <changeSet id="move_uavs_to_multiple_tap_rows" author="lennartkoopmann">
        <sql>DELETE FROM uavs;</sql>

        <dropUniqueConstraint tableName="uavs" constraintName="uavs_identifier_key" />
        <dropTable tableName="uavs_taps" />
        <addColumn tableName="uavs">
            <column name="tap_uuid" type="uuid">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="create_uav_timelines" author="lennartkoopmann">
        <createTable tableName="uavs_timelines">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="uav_id" type="bigint">
                <constraints nullable="false" unique="true" />
            </column>

            <column name="seen_from" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="seen_to" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>

        <addForeignKeyConstraint constraintName="link_timelines2uavs"
                                 baseTableName="uavs_timelines"
                                 baseColumnNames="uav_id"
                                 referencedTableName="uavs"
                                 referencedColumnNames="id"
                                 onUpdate="NO ACTION"
                                 onDelete="CASCADE" />
    </changeSet>

    <changeSet id="drop_uav_timeline_uav_id_uniqueness" author="lennart koopmann">
        <dropUniqueConstraint tableName="uavs_timelines" constraintName="uavs_timelines_uav_id_key" />
    </changeSet>

    <changeSet id="add_uav_timeline_uuid" author="lennartkoopmann">
        <sql>DELETE FROM uavs_timelines;</sql>

        <addColumn tableName="uavs_timelines">
            <column name="uuid" type="uuid">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="link_uav_timelines_via_identifier_and_tenant" author="lennartkoopmann">
        <sql>DELETE FROM uavs_timelines;</sql>

        <dropForeignKeyConstraint baseTableName="uavs_timelines" constraintName="link_timelines2uavs" />
        <dropColumn tableName="uavs_timelines" columnName="uav_id" />

        <addColumn tableName="uavs_timelines">
            <column name="uav_identifier" type="text">
                <constraints nullable="false" />
            </column>

            <column name="organization_id" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="tenant_id" type="uuid">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <createIndex tableName="uavs_timelines" indexName="uavs_timelines_identifier_lookup">
            <column name="uav_identifier" />
        </createIndex>

        <createIndex tableName="uavs_timelines" indexName="uavs_timelines_tenant_lookup">
            <column name="organization_id" />
            <column name="tenant_id" />
        </createIndex>
    </changeSet>

    <changeSet id="add_uav_timeline_identifier_uniqueness" author="lennartkoopmann">
        <addUniqueConstraint tableName="uavs_timelines" columnNames="uav_identifier" />
    </changeSet>

    <changeSet id="revert_add_uav_timeline_identifier_uniqueness" author="lennartkoopmann">
        <dropUniqueConstraint tableName="uavs_timelines" constraintName="uavs_timelines_uav_identifier_key" />
    </changeSet>

    <changeSet id="create_uav_types" author="lennartkoopmann">
        <createTable tableName="uavs_types">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="uav_id" type="bigint">
                <constraints nullable="false" unique="true" />
            </column>

            <column name="organization_id" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="tenant_id" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="match_type" type="text">
                <constraints nullable="false" />
            </column>

            <column name="match_value" type="text">
                <constraints nullable="false" />
            </column>

            <column name="default_classification" type="text">
                <constraints nullable="false" />
            </column>

            <column name="type" type="text">
                <constraints nullable="true" />
            </column>

            <column name="name" type="text">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="updated_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>
    </changeSet>

    <changeSet id="add_uav_type_uniqueness" author="lennartkoopmann">
        <addUniqueConstraint tableName="uavs_types" columnNames="organization_id, tenant_id, match_type, match_value" />
    </changeSet>

    <changeSet id="add_uav_type_uuid" author="lennartkoopmann">
        <addColumn tableName="uavs_types">
            <column name="uuid" type="uuid">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="remote_uav_type_uav_id" author="lennartkoopmann">
        <dropColumn tableName="uavs_types" columnName="uav_id" />
    </changeSet>

    <changeSet id="make_uav_type_default_classification_nullable" author="lennartkoopmann">
        <dropNotNullConstraint tableName="uavs_types" columnName="default_classification" />
    </changeSet>

    <changeSet id="add_uav_type_model" author="lennartkoopmann">
        <addColumn tableName="uavs_types">
            <column name="model" type="text">
                <constraints nullable="true" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_lat_lon_to_taps" author="lennartkoopmann">
        <addColumn tableName="taps">
            <column name="latitude" type="double">
                <constraints nullable="true" />
            </column>

            <column name="longitude" type="double">
                <constraints nullable="true" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="create_cot_outputs" author="lennartkoopmann">
        <createTable tableName="integrations_cot_outputs">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="uuid" type="uuid">
                <constraints nullable="false" unique="true" />
            </column>

            <column name="organization_id" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="tenant_id" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="name" type="text">
                <constraints nullable="false" />
            </column>

            <column name="description" type="text">
                <constraints nullable="true" />
            </column>

            <column name="leaf_type_tap" type="text">
                <constraints nullable="false" />
            </column>

            <column name="leaf_type_uav" type="text">
                <constraints nullable="false" />
            </column>

            <column name="address" type="text">
                <constraints nullable="false" />
            </column>

            <column name="port" type="integer">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="updated_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>

        <addForeignKeyConstraint constraintName="link_cot2tenants"
                                 baseTableName="integrations_cot_outputs"
                                 baseColumnNames="uuid"
                                 referencedTableName="auth_tenants"
                                 referencedColumnNames="uuid"
                                 onUpdate="NO ACTION"
                                 onDelete="CASCADE" />

        <createIndex tableName="integrations_cot_outputs" indexName="integrations_cot_outputs_tenant_lookup">
            <column name="organization_id" />
            <column name="tenant_id" />
        </createIndex>
    </changeSet>

    <changeSet id="fix_cots_fk_constraint" author="lennartkoopmann">
        <dropForeignKeyConstraint baseTableName="integrations_cot_outputs" constraintName="link_cot2tenants" />
        <addForeignKeyConstraint constraintName="link_cot2tenants"
                                 baseTableName="integrations_cot_outputs"
                                 baseColumnNames="tenant_id"
                                 referencedTableName="auth_tenants"
                                 referencedColumnNames="uuid"
                                 onUpdate="NO ACTION"
                                 onDelete="CASCADE" />
    </changeSet>

    <changeSet id="drop_cots_custom_uav_leaf_type" author="lennartkoopmann">
        <dropColumn tableName="integrations_cot_outputs" columnName="leaf_type_uav" />
    </changeSet>

    <changeSet id="add_cots_status_and_statistics" author="lennartkoopmann">
        <addColumn tableName="integrations_cot_outputs">
            <column name="status" type="text" defaultValue="RUNNING">
                <constraints nullable="false" />
            </column>

            <column name="sent_messages" type="bigint" defaultValue="0">
                <constraints nullable="false" />
            </column>

            <column name="sent_bytes" type="bigint" defaultValue="0">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_cot_connection_type" author="lennartkoopmann">
        <addColumn tableName="integrations_cot_outputs">
            <column name="connection_type" type="text" defaultValue="UDP_PLAINTEXT">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_optional_cot_certificate" author="lennartkoopmann">
        <addColumn tableName="integrations_cot_outputs">
            <column name="certificate" type="longblob">
                <constraints nullable="true" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_optional_cot_certificate_passphrase" author="lennartkoopmann">
        <addColumn tableName="integrations_cot_outputs">
            <column name="certificate_passphrase" type="longblob">
                <constraints nullable="true" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_mfa_disabled_to_users" author="lennartkoopmann">
        <addColumn tableName="auth_users">
            <column name="mfa_disabled" type="boolean" defaultValue="false">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_dhcp_transactions" author="lennartkoopmann">
        <createTable tableName="dhcp_transactions">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="uuid" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="tap_uuid" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="transaction_id" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="transaction_type" type="text">
                <constraints nullable="false" />
            </column>

            <column name="client_mac" type="text">
                <constraints nullable="false" />
            </column>

            <column name="additional_client_macs" type="jsonb">
                <constraints nullable="true" />
            </column>

            <column name="server_mac" type="text">
                <constraints nullable="true" />
            </column>

            <column name="additional_server_macs" type="jsonb">
                <constraints nullable="true" />
            </column>

            <column name="offered_ip_addresses" type="jsonb">
                <constraints nullable="true" />
            </column>

            <column name="requested_ip_address" type="text">
                <constraints nullable="true" />
            </column>

            <column name="options_fingerprint" type="text">
                <constraints nullable="true" />
            </column>

            <column name="additional_options_fingerprints" type="jsonb">
                <constraints nullable="true" />
            </column>

            <column name="timestamps" type="jsonb">
                <constraints nullable="false" />
            </column>

            <column name="latest_packet" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="notes" type="jsonb">
                <constraints nullable="true" />
            </column>

            <column name="is_complete" type="bool">
                <constraints nullable="false" />
            </column>

            <column name="updated_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>
        
        <createIndex tableName="dhcp_transactions" indexName="dhcptx_tap">
            <column name="tap_uuid" />
        </createIndex>

        <createIndex tableName="dhcp_transactions" indexName="dhcptx_tx_id">
            <column name="transaction_id" />
        </createIndex>

        <createIndex tableName="dhcp_transactions" indexName="dhcptx_ts">
            <column name="latest_packet" />
        </createIndex>
    </changeSet>

    <changeSet id="add_dhcp_transactions_first_packet" author="lennartkoopmann">
        <addColumn tableName="dhcp_transactions">
            <column name="first_packet" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <createIndex tableName="dhcp_transactions" indexName="dhcptx_first_packet">
            <column name="first_packet" />
        </createIndex>
    </changeSet>

    <changeSet id="add_dhcp_transactions_successful" author="lennartkoopmann">
        <addColumn tableName="dhcp_transactions">
            <column name="successful" type="bool">
                <constraints nullable="true" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="rename_dhcp_transactions_successful" author="lennartkoopmann">
        <renameColumn tableName="dhcp_transactions" oldColumnName="successful" newColumnName="is_successful" />
    </changeSet>

    <changeSet id="dhcp_transaction_options_and_fingerprints" author="lennartkoopmann">
        <dropColumn tableName="dhcp_transactions" columnName="options_fingerprint" />
        <dropColumn tableName="dhcp_transactions" columnName="additional_options_fingerprints" />

        <addColumn tableName="dhcp_transactions">
            <column name="options" type="jsonb" defaultValue="[]">
                <constraints nullable="false" />
            </column>

            <column name="additional_options" type="jsonb" defaultValue="[]">
                <constraints nullable="false" />
            </column>

            <column name="fingerprint" type="text">
                <constraints nullable="true" />
            </column>

            <column name="additional_fingerprints" type="jsonb" defaultValue="[]">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_dhcp_transaction_vendor_class" author="lennartkoopmann">
        <addColumn tableName="dhcp_transactions">
            <column name="vendor_class" type="text">
                <constraints nullable="true" />
            </column>

            <column name="additional_vendor_classes" type="jsonb" defaultValue="[]">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_assets" author="lennartkoopmann">
        <createTable tableName="assets">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="uuid" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="organization_id" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="tenant_id" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="mac" type="text">
                <constraints nullable="false" />
            </column>

            <column name="dhcp_fingerprint" type="text">
                <constraints nullable="false" />
            </column>

            <column name="first_seen" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="last_seen" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="updated_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="created_at" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createIndex tableName="assets" indexName="assets_single_lookup">
            <column name="uuid" />
        </createIndex>

        <createIndex tableName="assets" indexName="assets_mac_lookup">
            <column name="mac" />
        </createIndex>

        <createIndex tableName="assets" indexName="assets_org_lookup">
            <column name="organization_id" />
        </createIndex>

        <createIndex tableName="assets" indexName="assets_tenant_lookup">
            <column name="tenant_id" />
        </createIndex>
    </changeSet>

    <changeSet id="add_tcp_sources_to_assets" author="lennartkoopmann">
        <dropNotNullConstraint tableName="assets" columnName="dhcp_fingerprint" />

        <addColumn tableName="assets">
            <column name="tcp_fingerprint" type="text">
                <constraints nullable="true" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_seen_flags_to_assets" author="lennartkoopmann">
        <addColumn tableName="assets">
            <column name="seen_dhcp" type="boolean" defaultValue="false">
                <constraints nullable="false" />
            </column>

            <column name="seen_tcp" type="boolean" defaultValue="false">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_asset_uniqueness" author="lennartkoopmann">
        <addUniqueConstraint tableName="assets" columnNames="mac,organization_id,tenant_id" />
    </changeSet>

    <changeSet id="add_tcp_syn_options" author="lennartkoopmann">
        <addColumn tableName="l4_sessions">
            <column name="tcp_syn_window_size" type="integer">
                <constraints nullable="true" />
            </column>

            <column name="tcp_syn_maximum_segment_size" type="integer">
                <constraints nullable="true" />
            </column>

            <column name="tcp_syn_window_scale_multiplier" type="integer">
                <constraints nullable="true" />
            </column>

            <column name="tcp_syn_options" type="jsonb">
                <constraints nullable="true" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="add_more_tcp_syn_parameters" author="lennartkoopmann">
        <addColumn tableName="l4_sessions">
            <column name="ip_ttl" type="integer">
                <constraints nullable="true" />
            </column>

            <column name="ip_tos" type="integer">
                <constraints nullable="true" />
            </column>

            <column name="ip_df" type="boolean">
                <constraints nullable="true" />
            </column>

            <column name="tcp_syn_cwr" type="boolean">
                <constraints nullable="true" />
            </column>

            <column name="tcp_syn_ece" type="boolean">
                <constraints nullable="true" />
            </column>
        </addColumn>
    </changeSet>


    <changeSet id="add_l4_tcp_fingerprint" author="lennartkoopmann">
        <addColumn tableName="l4_sessions">
            <column name="tcp_fingerprint" type="text">
                <constraints nullable="true" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="give_assets_dhcp_fingerprints_types" author="lennartkoopmann">
        <dropColumn tableName="assets" columnName="dhcp_fingerprint" />

        <addColumn tableName="assets">
            <column name="dhcp_fingerprint_initial" type="text">
                <constraints nullable="true" />
            </column>

            <column name="dhcp_fingerprint_renew" type="text">
                <constraints nullable="true" />
            </column>

            <column name="dhcp_fingerprint_reboot" type="text">
                <constraints nullable="true" />
            </column>

            <column name="dhcp_fingerprint_rebind" type="text">
                <constraints nullable="true" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="remove_user_default_tenant" author="lennartkoopmann">
        <dropColumn tableName="auth_users" columnName="default_organization" />
        <dropColumn tableName="auth_users" columnName="default_tenant" />
    </changeSet>

    <changeSet id="add_persistent_asset_hostnames_and_ip_addresses" author="lennartkoopmann">
        <createTable tableName="assets_hostnames">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="asset_id" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="uuid" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="hostname" type="text">
                <constraints nullable="false" />
            </column>

            <column name="source" type="text">
                <constraints nullable="false" />
            </column>

            <column name="first_seen" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="last_seen" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>

        <addUniqueConstraint tableName="assets_hostnames" columnNames="asset_id,hostname,source" />

        <addForeignKeyConstraint constraintName="link_hostnames2assets"
                                 baseTableName="assets_hostnames"
                                 baseColumnNames="asset_id"
                                 referencedTableName="assets"
                                 referencedColumnNames="id"
                                 onUpdate="NO ACTION"
                                 onDelete="CASCADE" />

        <createTable tableName="assets_ip_addresses">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" />
            </column>

            <column name="asset_id" type="bigint">
                <constraints nullable="false" />
            </column>

            <column name="uuid" type="uuid">
                <constraints nullable="false" />
            </column>

            <column name="address" type="inet">
                <constraints nullable="false" />
            </column>

            <column name="source" type="text">
                <constraints nullable="false" />
            </column>

            <column name="first_seen" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>

            <column name="last_seen" type="timestamp with time zone">
                <constraints nullable="false" />
            </column>
        </createTable>

        <addUniqueConstraint tableName="assets_ip_addresses" columnNames="asset_id,address,source" />

        <addForeignKeyConstraint constraintName="link_ips2assets"
                                 baseTableName="assets_ip_addresses"
                                 baseColumnNames="asset_id"
                                 referencedTableName="assets"
                                 referencedColumnNames="id"
                                 onUpdate="NO ACTION"
                                 onDelete="CASCADE" />
    </changeSet>
</databaseChangeLog>