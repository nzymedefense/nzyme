name: Test Build

on: [push, pull_request]

jobs:
  build_all:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres
        env:
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - uses: actions/checkout@v4

      - name: Create Database
        run: createdb --host=localhost --port=5432 --username=postgres nzyme-java-tests
        env:
          PGPASSWORD: postgres

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: maven

      - name: Clean Maven environment
        run: mvn clean

      - name: Build `node`
        run: mvn package -DskipTests
        env:
          TEST_DATABASE_URL: postgresql://localhost:5432/nzyme-java-tests?user=postgres&password=postgres

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          
      - name: Install Rust build system dependencies
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential \
            pkg-config \
            libudev-dev \
            libdbus-1-dev \
            libpcap-dev \
            libssl-dev
            
      - name: Build `tap`
        working-directory: ./tap
        run: |
          cargo clean
          cargo build --release

      - name: Build `nzyme-util`
        working-directory: ./nzyme-util
        run: |
          cargo clean
          cargo build --release
